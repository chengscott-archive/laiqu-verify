cscope 15 $HOME/work/host/laiqu -q 0000000718 0000123125
	@acctManager/changePass.php

1 ï»¿<?
php
 
»quœe_Úû
('../common/checkAuthority.php'); ?>

2 <
html
 
	gxmÊs
="http://www.w3.org/1999/xhtml">

3 <
h—d
>

4 <
t™Ë
>éªŒè¯å¹³å°</title>

5 <
m‘a
 
h‰p
-
equiv
="CÚ‹Á-Ty³" 
cÚ‹Á
="text/html; charset=utf-8">

7 <
lšk
 
h»f
="../css/com_css.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

8 <
lšk
 
h»f
="css/·sswÜd_css.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

10 <
süt
 
¤c
="../js/jquery.min.js"></script>

11 <
süt
 
¤c
="../js/common_funcs.js"></script>

12 <
süt
 
¤c
="js/changePass.js"></script>

13 </
h—d
>

14 <
body
>

17 <
div
 
şass
="maš" 
id
="main">

21 <
div
 
şass
="top_blank">

22 </
div
>

24 <
div
 
şass
="top">

25 <
img
 
¤c
="../images/logo.jpg" />

26 </
div
>

28 <
div
 
şass
="body">

30 <
div
 
şass
="body_l">

31 <?
php


32 
»quœe
 '../common/templates/left_nav_bar.php';

34 <
div
 
	gşass
="serv">

35 <
div
 
şass
="tel" > </div>

36 <
a
 
şass
="online_qq"></a>

37 </
div
>

38 </
div
>

40 <
div
 
şass
="body_r fl">

41 <
p
 
şass
="title_r">>ä¿®æ”¹å¯†ç </p>

42 <
div
 
şass
="title_line"></div>

43 <
p
 
şass
="t_‹xt" 
id
="result_msg_area">é‡è¦æç¤ºï¼šé¦–æ¬¡ç™»å½•ä½¿ç”¨é»˜è®¤å¯†ç åï¼Œå»ºè®®æ‚¨ä¿®æ”¹å¯†ç ï¼Œå¹¶å¦¥å–„ä¿å­˜ã€‚</p>

45 <
div
 
şass
="password">

46 <
div
 
şass
="password_f ">

47 <
p
 
şass
="pw_text fl">åŸå¯†ç </p>

48 <
div
 
şass
="password_b fl">

49 <
šput
 
şass
="im_·sswÜd" 
Çme
="" 
id
="Üigš_·sswd" 
v®ue
="" 
ty³
='password'/>

50 </
div
>

52 <!-- <
p
 
şass
="guide_‹xˆæ">å¯†ç ç”±6-16ä½åŠè§’å­—ï¼ˆå­—æ¯ã€æ•°å­—ã€ç¬¦å·ï¼‰ç¬¦ç»„æˆï¼Œ<
br
 />æ³¨æ„åŒºåˆ†å¤§å°å†™ã€‚</p> -->

54 <
p
 
şass
="”rÜ_‹xˆæ" 
id
='origin_msg_area'></p>

57 </
div
>

59 <
div
 
şass
="password_f ">

60 <
p
 
şass
="pw_text fl">æ–°å¯†ç </p>

61 <
div
 
şass
="password_b fl">

62 <
šput
 
şass
="im_·sswÜd" 
Çme
="" 
id
="Ãw_·sswd" 
v®ue
="" 
ty³
='password'/>

63 </
div
>

64 <
p
 
şass
="guide_‹xˆæ" 
id
='Ãw_msg_¬—'>å¯†ç ç”±6-18ä½ï¼ˆå­—æ¯ã€æ•°å­—ï¼‰ç»„æˆï¼Œ<
br
 />å¿…é¡»ä»¥å­—æ¯å¼€å¤´ã€‚</p>

66 <!-- <
p
 
şass
="error_text fl">å¯†ç ä¸ç¬¦åˆè¦æ±‚ã€‚</p> -->

68 </
div
>

70 <
div
 
şass
="password_x ">

71 <
p
 
şass
="pw_text fl">ç¡®è®¤å¯†ç </p>

72 <
div
 
şass
="password_b fl">

73 <
šput
 
şass
="im_·sswÜd" 
Çme
="" 
id
="Ãw_·sswd_cÚfœm" 
v®ue
="" 
ty³
='password'/>

74 </
div
>

75 <!-- <
p
 
şass
="guide_‹xˆæ">å¯†ç ç”±6-16ä½åŠè§’å­—ï¼ˆå­—æ¯ã€æ•°å­—ã€ç¬¦å·ï¼‰ç¬¦ç»„æˆï¼Œ<
br
 />æ³¨æ„åŒºåˆ†å¤§å°å†™ã€‚</p> -->

77 <!-- <
p
 
şass
="error_text fl">å¯†ç ä¸ç¬¦åˆè¦æ±‚ã€‚</p> -->

78 <
p
 
şass
="”rÜ_‹xˆæ" 
id
='new_confirm_msg_area'></p>

79 </
div
>

81 <
div
 
şass
="password_f ">

82 <
a
 
şass
="§ve_bu‰Ú" 
h»f
="javasüt:void(0);" 
id
='do_change_btn'></a>

85 </
div
>

87 </
div
>

88 </
div
>

92 </
div
>

94 <
div
 
şass
="footer">

95 <
div
 
şass
="bottom_line ">

96 </
div
>

97 <
p
 
şass
="footer_text">æ¥ è¶£ ç½‘ ç»œ ç§‘ æŠ€ æœ‰ é™ å…¬ å¸</p>

98 </
div
>

100 </
div
>

112 </
body
>

113 </
html
>

	@acctManager/do_changePass.php

1 <?
php


11 
»quœe_Úû
('../common/checkAuthority.php');

12 
»quœe_Úû
('../common/utilities.php');

13 
»quœe_Úû
('../module/Partner.php');

16 
funùiÚ
 
	$ruÁimeE¼ÜHªdËr
(
$”ºo
, 
$”r¡r
, 
$”rfe
, 
$”¾še
)

19 
$code
 = 
CommÚCodeMsg
::
SYSTEM_RUNTIME_ERROR
;

21 
	`”rÜ_log
(
$”r¡r
);

22 
	`d›
(
	`g’_»¥Ú£_jsÚ
('ChªgePassCodeMsg', 
$code
));

24 
	}
}

25 
funùiÚ
 
	$exû±iÚHªdËr
(
$exû±iÚ
)

27 
$code
 = 
$exû±iÚ
->
	`g‘Code
();

28 
$v”ifyMsg
 = 
ChªgePassCodeMsg
::
	`g‘_mes§ge
(
$code
);

29 ià(
	`em±y
(
$v”ifyMsg
))

31 
$code
 = 
CommÚCodeMsg
::
UNCAUGHT_FATAL_ERROR
;

32 
$”r¡r
 = 
$exû±iÚ
->
	`g‘Mes§ge
();

34 
	`”rÜ_log
(
$”r¡r
);

36 
	`d›
(
	`g’_»¥Ú£_jsÚ
('ChªgePassCodeMsg', 
$code
));

37 
	}
}

38 
£t_”rÜ_hªdËr
('ruÁimeE¼ÜHªdËr', 
E_ERROR
);

39 
£t_exû±iÚ_hªdËr
('exceptionHandler');

42 
	g$·¹ÃrId
 = 
$_SESSION
['partnerId'];

44 
	g$·¹Ãr
 = 
Ãw
 
P¬Š”
();

46 
	g$ÜigšPasswd
 = 
$_POST
['originPasswd'];

47 
	g$ÃwPasswd
 = 
$_POST
['newPasswd'];

49 ià(
	gLQ_OK
 ==ğ
$·¹Ãr
->
chªgePass
(
$·¹ÃrId
, 
$ÜigšPasswd
, 
$ÃwPasswd
))

50 
	g$»¥Ú£Code
 = 
ChªgePassCodeMsg
::
CHANGE_PASS_SUCCESS
;

52 
	g$»¥Ú£Code
 = 
ChªgePassCodeMsg
::
CHANGE_PASS_FAILED
;

53 
echo
 
g’_»¥Ú£_jsÚ
('ChªgePassCodeMsg', 
$»¥Ú£Code
);

	@admin/add-partner.php

1 <?
php
 
	g»quœe_Úû
 'common.php';?>

2 <
html
 
	gxmÊs
="http://www.w3.org/1999/xhtml">

3 <
h—d
>

4 <
t™Ë
>æ·»åŠ å•†æˆ·</title>

5 <
m‘a
 
h‰p
-
equiv
="CÚ‹Á-Ty³" 
cÚ‹Á
="text/html; charset=utf-8">

6 <
lšk
 
h»f
="css/add-·¹Ãr.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

7 </
h—d
>

8 <
body
>

9 <
süt
 
¤c
="../js/jquery.min.js"></script>

10 <
süt
 
¤c
="../js/jquery.form.js"></script>

11 <
süt
 
¤c
="js/add-partner.js"></script>

12 <
div
 
şass
="maš" 
id
="main">

13 <
fÜm
 
aùiÚ
="doAddP¬Š”.php" 
m‘hod
="po¡" 
acû±
-
ch¬£t
="utf-8" 
id
="add_partner_form">

15 <
div
 
id
="partner_info">

16 <
h3
>å•†æˆ·åŸºæœ¬ä¿¡æ¯</h3>

17 <
p
>å•†æˆ·ç™»å½•å:<
šput
 
ty³
="‹xt" 
v®ue
="" 
Çme
="·¹Ãr_acù_Çme" 
id
="partner_acct_name">*</p>

18 <
p
>å•†æˆ·æ ‡é¢˜:<
šput
 
ty³
="‹xt" 
v®ue
="" 
Çme
="partner_acct_title">*</p>

19 <
p
>ç™»å½•å¯†ç :<
šput
 
ty³
="·sswÜd" 
v®ue
="" 
Çme
="partner_acct_pwd">*</p>

20 <
p
>å¯†ç ç¡®è®¤:<
šput
 
ty³
="·sswÜd" 
v®ue
="" 
Çme
="partner_acct_pwd_confirm">*</p>

21 <
p
>è”ç³»ç”µè¯:<
šput
 
ty³
="‹xt" 
v®ue
="" 
Çme
="partner_acct_phone"></p>

22 <
p
>åœ°å€:<
šput
 
ty³
="‹xt" 
v®ue
="" 
Çme
="partner_acct_address"></p>

23 </
div
>

24 <
div
 
id
='İ”©iÚ_b¬'><
šput
 
ty³
="subm™" 
v®ue
="æäº¤"></div>

25 </
fÜm
>

27 </
div
>

28 </
body
>

29 </
html
>

	@admin/bind-partner-platform.php

1 <?
php
 
	g»quœe_Úû
 'common.php';?>

2 <
html
 
	gxmÊs
="http://www.w3.org/1999/xhtml">

3 <
h—d
>

4 <
t™Ë
>å¹³å°ç»‘å®š</title>

5 <
m‘a
 
h‰p
-
equiv
="CÚ‹Á-Ty³" 
cÚ‹Á
="text/html; charset=utf-8">

6 <
lšk
 
h»f
="css/add-·¹Ãr.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

7 </
h—d
>

8 <
body
>

9 <
süt
 
¤c
="../js/jquery.min.js"></script>

10 <
süt
 
¤c
="../js/jquery.form.js"></script>

11 <
süt
 
¤c
="js/bind-partner-platform.js"></script>

12 <
div
 
şass
="maš" 
id
="main">

13 <
fÜm
 
aùiÚ
="bšdP¬Š”PÏtfÜm.php" 
m‘hod
="po¡" 
acû±
-
ch¬£t
="utf-8" 
id
="bind_partner_platform_form">

15 <
div
 
id
="partner_platform_info">

16 <
h3
>å•†æˆ·å¹³å°ç»‘å®š</h3>

17 <
div
 
id
="platform_select_bar">

18 <
£Ëù
 
Çme
="¶©fÜm_£Ëù" 
id
="platform_select">

19 <
İtiÚ
 
v®ue
="juhuasuan">èšåˆ’ç®—</option>

20 <
İtiÚ
 
v®ue
="laiqu">æ¥è¶£</option>

21 </
£Ëù
>

22 </
div
>

23 <
div
 
id
="platform_bind_body"></div>

24 </
div
>

26 <
p
><
šput
 
ty³
="subm™" 
v®ue
="æäº¤"></p>

27 </
fÜm
>

29 </
div
>

30 <
div
 
id
='·¹Ãr_u£ºame_äom_»que¡' 
¡yË
='di¥Ïy:nÚe;'><?
php


31 ià(
is£t
(
$_REQUEST
['·¹Ãr_u£ºame'])){ 
echo
 $_REQUEST['·¹Ãr_u£ºame'];} ?></
	gdiv
>

32 </
	gbody
>

33 </
	ghtml
>

	@admin/bindPartnerPlatform.php

1 <?
php


11 
	g»quœe_Úû
 'common.php';

12 
	g»quœe_Úû
 '../common/class/MyTable.php';

15 
	g$mysql
 = 
Ãw
 
MyTabË
();

17 
fÜ—ch
 (
$_REQUEST
 
as
 
$key
 => 
$v®ue
)

19 
$$key
 = 
add¦ashes
(
Œim
(
$v®ue
));

23 ià(!
is£t
(
$¶©fÜm
è|| 
	g$¶©fÜm
 === "" ||

24 !
is£t
(
$·¹Ãr_u£ºame
) || $partner_username === "" ||

25 !
is£t
(
$¶©fÜm_u£ºame
) || $platform_username === "" ||

26 !
is£t
(
$¶©fÜm_‹rmš®id
) || $platform_terminalid === "" ||

27 !
is£t
(
$¶©fÜm_pwd
) || $platform_pwd === "" ||

28 !
is£t
(
$¶©fÜm_pwd_cÚfœm
) || $platform_pwd_confirm === "")

30 
echo
 
g’_jsÚ_»¥Ú£
(
NEW_PLATFORM_INFO_NOT_COMPLETE
);

31 
	gex™
;

35 
	g$mysql
->
£t_bËÇme
('partner');

36 
	g$·¹ÃrIdP¬ams
 = 
¬¿y
("u£ºame"=>
$·¹Ãr_u£ºame
);

37 
	g$·¹ÃrIdRow
 = 
$mysql
->
g‘_row
(
$·¹ÃrIdP¬ams
);

39 ià(
	g$·¹ÃrIdRow
 ==ğ
nuÎ
)

41 
echo
 
g’_jsÚ_»¥Ú£
(
PARTNER_NOT_EXIST
);

42 
	gex™
;

45 
	g$·¹ÃrId
 = 
$·¹ÃrIdRow
['id'];

48 ià(
	g$¶©fÜm_pwd
 !=ğ
$¶©fÜm_pwd_cÚfœm
)

50 
echo
 
g’_jsÚ_»¥Ú£
(
PLATFORM_PWD_NOT_MATCH
);

51 
	gex™
;

54 
	g$mysql
->
£t_bËÇme
('partner_platforms');

55 
	g$checkBšdP¬ams
 = 
¬¿y
 ("·¹Ãr_id"=>
$·¹ÃrId
, "¶©fÜm_key"=>
$¶©fÜm
, "status"=>1);

56 
	g$checkBšdRow
 = 
$mysql
->
g‘_row
(
$checkBšdP¬ams
);

58 ià(
	g$checkBšdRow
)

60 
	g$İSql
 = "UPDATE ".
$mysql
->
g‘_dbTabËName
("partner_platforms");

61 
	g$İSql
 .= " SET…_username='$platform_username',p_password='$platform_pwd',p_terminalid='$platform_terminalid'";

62 
	g$İSql
 .= " WHERE…artner_id=$partnerId AND…latform_key='$platform'";

63 
	g$İCode
 = 
PARTNER_PLATFORM_UPDATE_FAILED
;

66 
	g$İSql
 = "INSERT INTO ".
$mysql
->
g‘_dbTabËName
("partner_platforms");

67 
	g$İSql
 .= "(partner_id,platform_key,p_username,p_password,p_terminalid,status) ";

68 
	g$İSql
 .= "VALUES($partnerId,'$platform','$platform_username','$platform_pwd','$platform_terminalid',1)";

69 
	g$İCode
 = 
PARTNER_PLATFORM_INSERT_FAILED
;

71 
	g$İResuÉ
 = 
$mysql
->
qu”y
(
$İSql
);

73 ià(
mysql_afãùed_rows
() > 0)

75 
echo
 
g’_jsÚ_»¥Ú£
('success');

77 
echo
 
g’_jsÚ_»¥Ú£
(
$İCode
);

79 
	gex™
;

	@admin/common.php

1 <?
php


11 
	g»quœe
 '../common/common.php';

12 
	g»quœe_Úû
 '../common/functions/common.funcs.php';

14 
	g$
 = 
g‘_ş›Á_
();

16 ià(
	g$
 !=ğ"::1" && 
$
 !=ğ
LAIQU_OFFICE_IP
)

18 
echo
 'Access denied!';

19 
	gex™
;

24 
defše
('PARTNER_ACCT_NAME_ALREADY_USED', 1001);

25 
defše
('NEW_PARTNER_INFO_NOT_COMPLETE', 1002);

26 
defše
('PARTNER_ACCT_PWD_NOT_MATCH', 1003);

27 
defše
('CREATE_PARTNER_FAILED', 1004);

29 
defše
('NEW_PLATFORM_INFO_NOT_COMPLETE',1101);

30 
defše
('PARTNER_NOT_EXIST', 1102);

31 
defše
('PLATFORM_PWD_NOT_MATCH',1103);

32 
defše
('PARTNER_PLATFORM_UPDATE_FAILED',1104);

33 
defše
('PARTNER_PLATFORM_INSERT_FAILED',1105);

35 
	g$”rÜMsgs
 = 
¬¿y
(

36 
PARTNER_ACCT_NAME_ALREADY_USED
 => 'å•†æˆ·ç™»é™†åå·²è¢«ä½¿ç”¨',

37 
NEW_PARTNER_INFO_NOT_COMPLETE
 => 'æ–°å¢å•†æˆ·ä¿¡æ¯ä¸å…¨',

38 
PARTNER_ACCT_PWD_NOT_MATCH
 => 'å•†å®¶è´¦å·å¯†ç ä¸åŒ¹é…',

39 
CREATE_PARTNER_FAILED
 => 'åˆ›å»ºå•†å®¶è´¦å·å¤±è´¥',

40 
NEW_PLATFORM_INFO_NOT_COMPLETE
 => 'å•†æˆ·å¹³å°ä¿¡æ¯ä¸å…¨',

41 
PARTNER_NOT_EXIST
 => 'å•†æˆ·å¹³å°ä¸å­˜åœ¨',

42 
PLATFORM_PWD_NOT_MATCH
 => 'ä¸¤æ¬¡å¹³å°å¯†ç ä¸åŒ¹é…',

43 
PARTNER_PLATFORM_UPDATE_FAILED
 => 'å•†æˆ·å¹³å°ä¿¡æ¯æ›´æ–°å¤±è´¥',

44 
PARTNER_PLATFORM_INSERT_FAILED
 => 'å•†æˆ·å¹³å°ä¿¡æ¯åˆ›å»ºå¤±è´¥'

50 
funùiÚ
 
	$ü—‹_·¹Ãr_acù
()

55  
	`mktime
() - 326000000;

56 
	}
}

58 
funùiÚ
 
	$g’_jsÚ_»¥Ú£
(
$code
)

60 
$»¥Ú£A¼ay
 = 
	`¬¿y
();

61 ià(
$code
 === "success")

63 
$»¥Ú£A¼ay
['sucûss'] = 
Œue
;

65 
$»¥Ú£A¼ay
['sucûss'] = 
çl£
;

66 
$»¥Ú£A¼ay
['code'] = 
$code
;

67 
$»¥Ú£A¼ay
['msg'] = 
	`g‘_”rÜMsgs
(
$code
);

69 
echo
 
	`jsÚ_’code
(
$»¥Ú£A¼ay
);

70 
	}
}

73 
funùiÚ
 
	$g’_»¥Ú£_¬¿y
(
$code
)

75 
$»¥Ú£A¼ay
 = 
	`¬¿y
();

76 ià(
$code
 === "success")

78 
$»¥Ú£A¼ay
['sucûss'] = 
Œue
;

80 
$»¥Ú£A¼ay
['sucûss'] = 
çl£
;

81 
$»¥Ú£A¼ay
['code'] = 
$code
;

82 
$»¥Ú£A¼ay
['msg'] = 
	`g‘_”rÜMsgs
(
$code
);

84  
$»¥Ú£A¼ay
;

85 
	}
}

87 
funùiÚ
 
	$g‘_”rÜMsgs
(
$code
)

89 
glob®
 
$”rÜMsgs
;

91 ià(!
	`is£t
(
$”rÜMsgs
[
$code
]))

95  
$”rÜMsgs
[
$code
];

97 
	}
}

	@admin/doAddPartner.php

1 <?
php


11 
	g»quœe_Úû
 'common.php';

12 
	g»quœe_Úû
 '../common/class/MyTable.php';

15 
	g$mysql
 = 
Ãw
 
MyTabË
();

17 
fÜ—ch
 (
$_REQUEST
 
as
 
$key
 => 
$v®ue
)

19 
$$key
 = 
add¦ashes
(
Œim
(
$v®ue
));

23 ià(!
is£t
(
$·¹Ãr_acù_Çme
è|| 
	g$·¹Ãr_acù_Çme
 === "" ||

24 !
is£t
(
$·¹Ãr_acù_t™Ë
) || $partner_acct_title === "" ||

25 !
is£t
(
$·¹Ãr_acù_pwd
) || $partner_acct_pwd === "" ||

26 !
is£t
(
$·¹Ãr_acù_pwd_cÚfœm
) || $partner_acct_pwd_confirm === "")

28 
echo
 
g’_jsÚ_»¥Ú£
(
NEW_PARTNER_INFO_NOT_COMPLETE
);

29 
	gex™
;

33 
	g$mysql
->
£t_bËÇme
('partner');

34 
	g$·¿ms
 = 
¬¿y
("u£ºame" => 
$·¹Ãr_acù_Çme
);

35 
	g$checkU£ºameRow
 = 
$mysql
->
g‘_row
(
$·¿ms
);

36 ià(
	g$checkU£ºameRow
 !ğ
nuÎ
)

38 
echo
 
g’_jsÚ_»¥Ú£
(
PARTNER_ACCT_NAME_ALREADY_USED
);

39 
	gex™
;

42 ià(
	g$·¹Ãr_acù_pwd
 !=ğ
$·¹Ãr_acù_pwd_cÚfœm
)

44 
echo
 
g’_jsÚ_»¥Ú£
(
PARTNER_ACCT_PWD_NOT_MATCH
);

45 
	gex™
;

49 
	g$·¹Ãr_acù
 = 
ü—‹_·¹Ãr_acù
();

51 
	g$·¹Ãr_acù_pwd
 = 
üy±_·ss
(
$·¹Ãr_acù_pwd
);

53 
	g$š£¹P¬Š”Sql
 = "INSERT ".
$mysql
->
g‘_dbTabËName
("partner");

54 
	g$š£¹P¬Š”Sql
 .= "(partner_acct,username,…assword,itle,address, mobile, create_time) ";

55 
	g$š£¹P¬Š”Sql
 .= "VALUES('$partner_acct','$partner_acct_name','$partner_acct_pwd','$partner_acct_title','$partner_acct_address','$partner_acct_phone',UNIX_TIMESTAMP())";

57 
	g$š£¹ResuÉ
 = 
$mysql
->
qu”y
(
$š£¹P¬Š”Sql
);

58 ià(
mysql_afãùed_rows
() < 1)

60 
echo
 
g’_jsÚ_»¥Ú£
(
CREATE_PARTNER_FAILED
);

63 
	g$»¥Ú£A¼ay
 = 
g’_»¥Ú£_¬¿y
('success');

64 
	g$»¥Ú£A¼ay
['·¹ÃrAcù'] = 
$·¹Ãr_acù
;

65 
echo
 
jsÚ_’code
(
$»¥Ú£A¼ay
);

67 
	gex™
;

	@admin/index.php

1 <?
php


2 
	g»quœe
 '../common/common.php';

3 
	g»quœe_Úû
 '../common/functions/common.funcs.php';

5 
	g$
 = 
g‘_ş›Á_
();

7 ià(
	g$
 !=ğ"::1" && 
$
 !=ğ
LAIQU_OFFICE_IP
)

9 
echo
 'Access denied!';

10 
	gex™
;

	@common/CodeMessages.php

1 <?
php


12 şas 
	cCommÚCodeMsg


16 cÚ¡ 
	mSYSTEM_RUNTIME_ERROR
 = 20000;

17 cÚ¡ 
	mUNCAUGHT_FATAL_ERROR
 = 20001;

18 cÚ¡ 
	mINVALID_ARGUMENT_ERROR
 = 20002;

19 cÚ¡ 
	mUNKNOWN_EXCEPTION
 = 20003;

20 cÚ¡ 
	mCODEMSG_CLASS_NOT_EXIST
 = 20004;

21 cÚ¡ 
	mMYSQL_CONNECT_ERROR
 = 20005;

22 cÚ¡ 
	mMYSQL_SELECT_DB_ERROR
 = 20006;

25 
´iv©e
 
	m$_codeMes§ges
 = 
¬¿y
 (

26 
£lf
::
SYSTEM_RUNTIME_ERROR
 => "ç³»ç»Ÿè¿è¡Œæ—¶é”™è¯¯",

27 
£lf
::
UNCAUGHT_FATAL_ERROR
 => "æœªæ•æ‰çš„è‡´å‘½é”™è¯¯",

28 
£lf
::
INVALID_ARGUMENT_ERROR
 => "æ— æ•ˆçš„å‚æ•°",

29 
£lf
::
UNKNOWN_EXCEPTION
 => "æœªçŸ¥å¼‚å¸¸",

30 
£lf
::
CODEMSG_CLASS_NOT_EXIST
 => "é”™è¯¯ä»£ç ä¿¡æ¯ç±»ä¸å­˜åœ¨",

31 
£lf
::
MYSQL_CONNECT_ERROR
 => "æ•°æ®åº“è¿æ¥é”™è¯¯",

32 
£lf
::
MYSQL_SELECT_DB_ERROR
 => "æ•°æ®åº“é€‰æ‹©é”™è¯¯"

44 
public
 
funùiÚ
 
	$g‘_mes§ge
(
$code
 = 
nuÎ
)

46 ià(
$code
 ==ğ
nuÎ
)

47  
£lf
::
$_codeMes§ges
;

49  
	`is£t
(
£lf
::
$_codeMes§ges
[
$code
]è? s–f::$_codeMes§ges[$code] : 
nuÎ
;

51 
	}
}

53 şas 
	cV”ifyCoupÚCodeMsg


57 cÚ¡ 
	mVERIFY_COUPON_SUCCESS
 = 21000;

58 cÚ¡ 
	mVERIFY_COUPON_FAIL
 = 210001;

59 cÚ¡ 
	mCOUPON_NOT_EXIST
 = 210002;

61 cÚ¡ 
	mUNKNOWN_PLATFORM_ERROR
 = 21100;

62 cÚ¡ 
	mTRANSFER_REQUEST_PARAM_ERROR
 = 21102;

63 cÚ¡ 
	mREQUEST_EXCEPTION
 = 21103;

64 cÚ¡ 
	mPARSE_RESPONSE_EXCEPTION
 = 21104;

65 cÚ¡ 
	mPARSE_CONFIG_FILE_EXCEPTION
 = 21105;

66 cÚ¡ 
	mUNKNOWN_EXCEPTION
 = 21106;

67 cÚ¡ 
	mMARK_COUPON_CONSUMED_ERROR
 = 21107;

68 cÚ¡ 
	mINVALID_COUPONID_ARG_ERROR
 = 21108;

69 cÚ¡ 
	mINVALID_COUPONPWD_ARG_ERROR
 = 21109;

70 cÚ¡ 
	mVALIDATECODE_NOT_MATCH_ERROR
 = 21110;

71 cÚ¡ 
	mMALFORMED_COUNT_NUMBER
 = 211111;

72 cÚ¡ 
	mJUHUASUAN_LOGIN_EXPIRED
 = 211112;

73 cÚ¡ 
	mPLATFORM_ACCT_NOT_BIND_ERROR
 = 211113;

74 cÚ¡ 
	mRECORD_COUPON_FAILED_ERROR
 = 211114;

77 
´iv©e
 
	m$_codeMes§ges
 = 
¬¿y
 (

78 
£lf
::
VERIFY_COUPON_SUCCESS
 => "éªŒè¯æˆåŠŸ",

79 
£lf
::
VERIFY_COUPON_FAIL
 => "éªŒè¯å¤±è´¥",

80 
£lf
::
COUPON_NOT_EXIST
 => "å›¢è´­åˆ¸ä¸å­˜åœ¨",

81 
£lf
::
UNKNOWN_PLATFORM_ERROR
 => "æœªçŸ¥å¹³å°é”™è¯¯",

82 
£lf
::
TRANSFER_REQUEST_PARAM_ERROR
 => "å°†å®¢æˆ·ç«¯è¾“å…¥è½¬ä¸ºAPIè¯·æ±‚å‚æ•°é”™è¯¯",

83 
£lf
::
REQUEST_EXCEPTION
 => "æ¥å£éªŒè¯APIå¼‚å¸¸",

84 
£lf
::
PARSE_RESPONSE_EXCEPTION
 => "è§£ææ¥å£è¿”å›å¼‚å¸¸",

85 
£lf
::
PARSE_CONFIG_FILE_EXCEPTION
 => "è§£æå¹³å°æ¥å£é…ç½®æ–‡ä»¶å¼‚å¸¸",

86 
£lf
::
UNKNOWN_EXCEPTION
 => "æœªçŸ¥å¼‚å¸¸",

87 
£lf
::
MARK_COUPON_CONSUMED_ERROR
 => "æ ‡è®°å›¢è´­åˆ¸å·²æ¶ˆè´¹é”™è¯¯",

88 
£lf
::
INVALID_COUPONID_ARG_ERROR
 => "å›¢è´­åˆ¸IDå‚æ•°æ— æ•ˆ",

89 
£lf
::
INVALID_COUPONPWD_ARG_ERROR
 => "å›¢è´­åˆ¸å¯†ç å‚æ•°æ— æ•ˆ",

90 
£lf
::
VALIDATECODE_NOT_MATCH_ERROR
 => "éªŒè¯ç é”™è¯¯",

91 
£lf
::
MALFORMED_COUNT_NUMBER
 => "é”€åˆ¸æ¬¡æ•°æ ¼å¼é”™è¯¯",

92 
£lf
::
JUHUASUAN_LOGIN_EXPIRED
 => "èšåˆ’ç®—ç™»é™†è¶…æœŸ",

93 
£lf
::
PLATFORM_ACCT_NOT_BIND_ERROR
 => "å•†å®¶å¹³å°è´¦æˆ·æ²¡æœ‰ç»‘å®š",

94 
£lf
::
RECORD_COUPON_FAILED_ERROR
 => "æœåŠ¡ç«¯ç™»è®°å›¢è´­åˆ¸å·²æ¶ˆè´¹ç›¸å…³ä¿¡æ¯å¤±è´¥"

106 
public
 
funùiÚ
 
	$g‘_mes§ge
(
$code
 = 
nuÎ
)

108 ià(
$code
 ==ğ
nuÎ
)

109  
£lf
::
$_codeMes§ges
;

111 
$msg
 = 
	`is£t
(
£lf
::
$_codeMes§ges
[
$code
]) ? self::$_codeMessages[$code] : "";

112 
$msg
 = $msg ==ğ""? 
CommÚCodeMsg
::
	`g‘_mes§ge
(
$code
) : $msg;

113  
$msg
;

115 
	}
}

117 şas 
	cV”ifyLogšCodeMsg


121 cÚ¡ 
	mVERIFY_LOGIN_SUCCESS
 = 22000;

122 cÚ¡ 
	mVERIFY_LOGIN_FAIL
 = 22001;

123 cÚ¡ 
	mMYSQL_CONNECT_ERROR
 = 22100;

124 cÚ¡ 
	mMYSQL_SELECT_DB_ERROR
 = 22101;

125 cÚ¡ 
	mINVALID_NAME_PASS
 = 22102;

126 cÚ¡ 
	mERROR_NAME_PASS
 = 22103;

129 
´iv©e
 
	m$_codeMes§ges
 = 
¬¿y
 (

130 
£lf
::
VERIFY_LOGIN_SUCCESS
 => "ç™»é™†éªŒè¯æˆåŠŸ",

131 
£lf
::
VERIFY_LOGIN_FAIL
 => "ç™»é™†éªŒè¯å¤±è´¥",

132 
£lf
::
MYSQL_CONNECT_ERROR
 => "å»ºç«‹æ•°æ®åº“è¿æ¥å¤±è´¥",

133 
£lf
::
MYSQL_SELECT_DB_ERROR
 => "é€‰æ‹©æ•°æ®åº“é”™è¯¯",

134 
£lf
::
INVALID_NAME_PASS
 => "æ— æ•ˆçš„ç”¨æˆ·åå’Œå¯†ç ",

135 
£lf
::
ERROR_NAME_PASS
 => "é”™è¯¯çš„ç”¨æˆ·åå’Œå¯†ç "

147 
public
 
funùiÚ
 
	$g‘_mes§ge
(
$code
 = 
nuÎ
)

149 ià(
$code
 ==ğ
nuÎ
)

150  
£lf
::
$_codeMes§ges
;

152 
$msg
 = 
	`is£t
(
£lf
::
$_codeMes§ges
[
$code
]) ? self::$_codeMessages[$code] : "";

153 
$msg
 = $msg ==ğ""? 
CommÚCodeMsg
::
	`g‘_mes§ge
(
$code
) : $msg;

154  
$msg
;

156 
	}
}

158 şas 
	cChªgePassCodeMsg


162 cÚ¡ 
	mCHANGE_PASS_SUCCESS
 = 23000;

163 cÚ¡ 
	mORIGIN_PASS_NOT_MATCH
 = 23001;

164 cÚ¡ 
	mNEW_PASS_NOT_ALLOWED_ERROR
 = 23002;

165 cÚ¡ 
	mCHANGE_PASS_FAILED
 = 23003;

168 
´iv©e
 
	m$_codeMes§ges
 = 
¬¿y
 (

169 
£lf
::
CHANGE_PASS_SUCCESS
 => "æ›´æ”¹å¯†ç æˆåŠŸ",

170 
£lf
::
ORIGIN_PASS_NOT_MATCH
 => "åŸå§‹å¯†ç ä¸è¾“å…¥å¯†ç ä¸ä¸€è‡´",

171 
£lf
::
NEW_PASS_NOT_ALLOWED_ERROR
 => "æ–°å¯†ç ä¸ç¬¦åˆè¦æ±‚",

172 
£lf
::
CHANGE_PASS_FAILED
 => "æ›´æ–°å¯†ç å¤±è´¥"

184 
public
 
funùiÚ
 
	$g‘_mes§ge
(
$code
 = 
nuÎ
)

186 ià(
$code
 ==ğ
nuÎ
)

187  
£lf
::
$_codeMes§ges
;

189 
$msg
 = 
	`is£t
(
£lf
::
$_codeMes§ges
[
$code
]) ? self::$_codeMessages[$code] : "";

190 
$msg
 = $msg ==ğ""? 
CommÚCodeMsg
::
	`g‘_mes§ge
(
$code
) : $msg;

191  
$msg
;

193 
	}
}

	@common/Exception.php

1 <?
php


11 şas 
	cV”ifyCoupÚ_Exû±iÚ
 
ex‹nds
 
	mExû±iÚ


27 
public
 
funùiÚ
 
	$__cÚ¡ruù
(
$mes§ge
 = 
nuÎ
, 
$code
 =‚ull)

29 
·»Á
::
	`__cÚ¡ruù
(
$mes§ge
, 
$code
);

31 
	}
}

36 şas 
	cV”ifyCoupÚ_Reque¡Exû±iÚ
 
ex‹nds
 
	mV”ifyCoupÚ_Exû±iÚ
 {};

41 şas 
	cV”ifyCoupÚ_P¬£Re¥Ú£Exû±iÚ
 
ex‹nds
 
	mV”ifyCoupÚ_Exû±iÚ
 {};

46 şas 
	cV”ifyCoupÚ_P¬£CÚfigFeExû±iÚ
 
ex‹nds
 
	mV”ifyCoupÚ_Exû±iÚ
 {};

	@common/RESTclient.php

1 <?
php


3 
	g»quœe_Úû
 "HTTP/Request2.php";

5 şas 
	cRESTCl›Á


9 
´iv©e
 
	m$u£r_Çme
 = "";

10 
´iv©e
 
	m$·sswÜd
 = "";

11 
´iv©e
 
	m$»¥Ú£
 = "";

12 
´iv©e
 
	m$»¥Ú£Body
 = "";

13 
´iv©e
 
	m$»¥Ú£H—d”
 = "";

14 
´iv©e
 
	m$»q
 = 
nuÎ
;

15 
´iv©e
 
	m$cu¼_u¾
 = 
nuÎ
;

17 
public
 
funùiÚ
 
__cÚ¡ruù
(
$u¾
 = "", 
$u£r_Çme
 = "", 
$·sswÜd
 = "") {

19 
$this
->
u£r_Çme
 = 
$u£r_Çme
;

20 
	m$this
->
	m·sswÜd
 = 
$·sswÜd
;

21 ià(
	m$u¾
 != "") {

22 
$this
->
ü—‹Reque¡
(
$u¾
, "GET");

23 
	m$this
->
£ndReque¡
();

25  
	mŒue
;

28 
public
 
funùiÚ
 
ü—‹Reque¡
(
$u¾
, 
$m‘hod
 = 'GET', 
$¬r
 = 
nuÎ
) {

30 
$this
->
»q
 =& 
Ãw
 
HTTP_Reque¡2
(
$u¾
);

31 
	g$this
->
	gcu¼_u¾
 = 
$this
->
»q
->
g‘U¾
();

32 ià(
	g$this
->
	gu£r_Çme
 !ğ"" && 
$this
->
·sswÜd
 != "") {

33 
$this
->
»q
->
£tAuth
($this->
u£r_Çme
, $this->
·sswÜd
);

36 
	g$m‘hod
) {

38 
$this
->
»q
->
£tM‘hod
(
HTTP_Reque¡2
::
METHOD_GET
);

41 
$this
->
»q
->
£tM‘hod
(
HTTP_Reque¡2
::
METHOD_POST
);

42 
	g$this
->
addPo¡P¬am‘”
(
$¬r
);

45 
$this
->
»q
->
£tM‘hod
(
HTTP_Reque¡2
::
METHOD_PUT
);

49 
$this
->
»q
->
£tM‘hod
(
HTTP_Reque¡2
::
METHOD_DELETE
);

55 
´iv©e
 
funùiÚ
 
	$addPo¡P¬am‘”
(
$¬r
) {

56 ià(
$¬r
 !ğ
nuÎ
) {

57 
$this
->
»q
->
	`addPo¡P¬am‘”
(
$¬r
);

59 
	}
}

61 
public
 
funùiÚ
 
	$£ndReque¡
() {

62 
$this
->
»¥Ú£
 = $this->
»q
->
	`£nd
();

68 
$this
->
»¥Ú£Body
 = $this->
»¥Ú£
->
	`g‘Body
();

69 
$this
->
»¥Ú£H—d”
 = $this->
»¥Ú£
->
	`g‘H—d”
();

70 
	}
}

72 
public
 
funùiÚ
 
	$g‘Re¥Ú£
() {

73  
$this
->
»¥Ú£Body
;

74 
	}
}

75 
public
 
funùiÚ
 
	$g‘Re¥Ú£H—d”
() {

76  
$this
->
»¥Ú£H—d”
;

77 
	}
}

79 
public
 
funùiÚ
 
	$g‘Re¥Ú£Obj
() {

80  
$this
->
»¥Ú£
;

81 
	}
}

83 
public
 
funùiÚ
 
	$g‘Reque¡H—d”
() {

84  
$this
->
»q
->
	`g‘H—d”s
();

85 
	}
}

86 
public
 
funùiÚ
 
	$g‘U¾
() {

87  
$this
->
cu¼_u¾
;

88 
	}
}

90 
public
 
funùiÚ
 
	$£tU¾
(
$u¾
) {

91 ià(!
$this
->
»q
)

92  
çl£
;

93 
$this
->
»q
->
	`£tU¾
(
$u¾
);

94 
	}
}

96 
public
 
funùiÚ
 
	$£tH—d”
(
$h—d”
)

98 if(
$this
->
»q
)

99 
$this
->
»q
->
	`£tH—d”
(
$h—d”
);

100 
	}
}

102 
public
 
funùiÚ
 
	$g‘H‰pReque¡
()

104  
$this
->
»q
;

105 
	}
}

	@common/checkAuthority.php

1 <?
php


11 
	g»quœe_Úû
 'common.php';

13 ià(!
	$is_·¹Ãr_logš
())

15 
	`»dœeù
(
WEBROOT
.'/verifyLogin/login.html');

16 
ex™
;

17 
	}
}

	@common/class/Database.php

1 <?
php


11 
»quœe_Úû
('../../common/CodeMessages.php');

12 
»quœe_Úû
('../../common/Exception.php');

14 şas 
	cMyTabË


17 cÚ¡ 
	mDBHOST
 = 'localhost';

18 cÚ¡ 
	mDBUSER
 = 'root';

19 cÚ¡ 
	mDBPASS
 = 'ghz86377328';

20 cÚ¡ 
	mDBDATABASE
 = 'lq_verify';

22 
´Ùeùed
 
	m$_dbcÚn
 = 
nuÎ
;

29 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

31 
$this
->
_dbcÚn
 = 
	`mysql_cÚÃù
(
£lf
::
DBHOST
, s–f::
DBUSER
, s–f::
DBPASS
);

32 ià(!
$this
->
_dbcÚn
)

34 
throw
 
Ãw
 
	`Exû±iÚ
(

35 
V”ifyLogšCodeMsg
::
	`g‘_mes§ge
(V”ifyLogšCodeMsg::
MYSQL_CONNECT_ERROR
),

36 
V”ifyLogšCodeMsg
::
MYSQL_CONNECT_ERROR
);

38 ià(!
	`mysql_£Ëù_db
(
£lf
::
DBDATABASE
, 
$this
->
_dbcÚn
))

40 
throw
 
Ãw
 
	`Exû±iÚ
(

41 
V”ifyLogšCodeMsg
::
	`g‘_mes§ge
(V”ifyLogšCodeMsg::
MYSQL_SELECT_DB_ERROR
),

42 
V”ifyLogšCodeMsg
::
MYSQL_SELECT_DB_ERROR
);

46 
	}
}

	@common/class/MyTable.php

1 <?
php


11 
»quœe_Úû
('../common/CodeMessages.php');

12 
»quœe_Úû
('../common/Exception.php');

14 şas 
	cMyTabË


17 cÚ¡ 
	mDBHOST
 = 'localhost';

18 cÚ¡ 
	mDBUSER
 = 'root';

19 cÚ¡ 
	mDBPASS
 = 'ghz86377328';

20 cÚ¡ 
	mDBDATABASE
 = 'lq_verify';

22 
´Ùeùed
 
	m$_bËÇme
 = 
nuÎ
;

23 
´Ùeùed
 
	m$_dbcÚn
 = 
nuÎ
;

30 
public
 
funùiÚ
 
__cÚ¡ruù
(
$bËName
 = "")

32 ià(
$bËName
 !== "")

33 
$this
->
_bËÇme
 = 
$bËName
;

34 
	m$this
->
assu»_dbCÚÃùiÚ
();

37 
´Ùeùed
 
funùiÚ
 
	$assu»_dbCÚÃùiÚ
()

39 
$this
->
_dbcÚn
 = 
	`mysql_cÚÃù
(
£lf
::
DBHOST
, s–f::
DBUSER
, s–f::
DBPASS
);

40 ià(!
$this
->
_dbcÚn
)

42 
throw
 
Ãw
 
	`Exû±iÚ
(

43 
V”ifyLogšCodeMsg
::
	`g‘_mes§ge
(V”ifyLogšCodeMsg::
MYSQL_CONNECT_ERROR
),

44 
V”ifyLogšCodeMsg
::
MYSQL_CONNECT_ERROR
);

46 ià(!
	`mysql_£Ëù_db
(
£lf
::
DBDATABASE
, 
$this
->
_dbcÚn
))

48 
throw
 
Ãw
 
	`Exû±iÚ
(

49 
V”ifyLogšCodeMsg
::
	`g‘_mes§ge
(V”ifyLogšCodeMsg::
MYSQL_SELECT_DB_ERROR
),

50 
V”ifyLogšCodeMsg
::
MYSQL_SELECT_DB_ERROR
);

52 
	`mysql_qu”y
("SET CHARACTER SET 'utf8'", 
$this
->
_dbcÚn
);

53 
	}
}

55 
public
 
funùiÚ
 
	$g‘_dbTabËName
(
$bËName
)

57 ià(
$bËName
 !== "")

58 
$bËName
 = 
£lf
::
DBDATABASE
.".".$tableName;

60  
$bËName
;

61 
	}
}

63 
public
 
funùiÚ
 
	$£t_bËÇme
(
$bËName
)

65 
$this
->
_bËÇme
 = 
$bËName
;

66 
	}
}

69 
public
 
funùiÚ
 
	$g‘_row
(
$cÚd™iÚs
)

71 
$this
->
	`assu»_dbCÚÃùiÚ
();

73 
$£ËùSql
 = "SELECT * FROM ".
$this
->
	`g‘_dbTabËName
($this->
_bËÇme
)." WHERE 1=1 ";

74 
	`fÜ—ch
 (
$cÚd™iÚs
 
as
 
$key
 => 
$v®ue
)

76 
$key
 = 
	`mysql_»®_esÿ³_¡ršg
($key);

77 
$v®ue
 = 
	`mysql_»®_esÿ³_¡ršg
($value);

79 ià(
	`is_¡ršg
(
$v®ue
))

81 
$v®ue
 = "'".$value."'";

83 
$£ËùSql
 .ğ"AND ".
$key
."=".
$v®ue
;

85 
$»suÉ
 = 
	`mysql_qu”y
(
$£ËùSql
);

86 ià(
$»suÉ
 && 
	`mysql_num_rows
($result) > 0)

88  
	`mysql_ãtch_¬¿y
(
$»suÉ
);

91  
nuÎ
;

93 
	}
}

94 
public
 
funùiÚ
 
	$qu”y
(
$sql
)

96 
$this
->
	`assu»_dbCÚÃùiÚ
();

97  
	`mysql_qu”y
(
$sql
);

98 
	}
}

	@common/class/Valite.php

1 <?
php


4 
defše
('WORD_WIDTH',10);

5 
defše
('WORD_HIGHT',13);

6 
defše
('OFFSET_X',7);

7 
defše
('OFFSET_Y',3);

8 
defše
('WORD_SPACING',3);

10 şas 
	cV®™e


12 
public
 
funùiÚ
 
	$£tImage
(
$Image
)

14 
$this
->
ImageP©h
 = 
$Image
;

16 
public
 
funùiÚ
 
	$g‘D©a
()

18  
$d©a
;

19 
	}
}

20 
public
 
funùiÚ
 
	$g‘ResuÉ
()

22  
$D©aA¼ay
;

23 
	}
}

24 
public
 
funùiÚ
 
	$g‘Hec
()

26 
$»s
 = 
	`imageü—‹äomj³g
(
$this
->
ImageP©h
);

27 
$size
 = 
	`g‘imagesize
(
$this
->
ImageP©h
);

28 
$d©a
 = 
	`¬¿y
();

29 
$i
=0; $˜< 
$size
[1]; ++$i)

31 
$j
=0; $j < 
$size
[0]; ++$j)

33 
$rgb
 = 
	`imagecŞÜ©
(
$»s
,
$j
,
$i
);

34 
$rgb¬¿y
 = 
	`imagecŞÜsfÜšdex
(
$»s
, 
$rgb
);

35 if(
$rgb¬¿y
['red'] < 94 || $rgbarray['green']<94

36 || 
$rgb¬¿y
['blue'] < 94)

38 
$d©a
[
$i
][
$j
]=1;

40 
$d©a
[
$i
][
$j
]=0;

47 
$i
=0; $˜< 
$size
[1]; ++$i)

49 
$j
=0; $j < 
$size
[0]; ++$j)

51 
$num
 = 0;

52 if(
$d©a
[
$i
][
$j
] == 1)

55 if(
	`is£t
(
$d©a
[
$i
-1][
$j
])){

56 
$num
 = $num + 
$d©a
[
$i
-1][
$j
];

59 if(
	`is£t
(
$d©a
[
$i
+1][
$j
])){

60 
$num
 = $num + 
$d©a
[
$i
+1][
$j
];

63 if(
	`is£t
(
$d©a
[
$i
][
$j
-1])){

64 
$num
 = $num + 
$d©a
[
$i
][
$j
-1];

67 if(
	`is£t
(
$d©a
[
$i
][
$j
+1])){

68 
$num
 = $num + 
$d©a
[
$i
][
$j
+1];

71 if(
	`is£t
(
$d©a
[
$i
-1][
$j
-1])){

72 
$num
 = $num + 
$d©a
[
$i
-1][
$j
-1];

75 if(
	`is£t
(
$d©a
[
$i
-1][
$j
+1])){

76 
$num
 = $num + 
$d©a
[
$i
-1][
$j
+1];

79 if(
	`is£t
(
$d©a
[
$i
+1][
$j
-1])){

80 
$num
 = $num + 
$d©a
[
$i
+1][
$j
-1];

83 if(
	`is£t
(
$d©a
[
$i
+1][
$j
+1])){

84 
$num
 = $num + 
$d©a
[
$i
+1][
$j
+1];

87 if(
$num
 == 0){

88 
$d©a
[
$i
][
$j
] = 0;

94 
$this
->
D©aA¼ay
 = 
$d©a
;

95 
$this
->
ImageSize
 = 
$size
;

97 
	}
}

98 
public
 
funùiÚ
 
	$run
()

100 
$»suÉ
="";

102 
$d©a
 = 
	`¬¿y
("","","","","","");

103 
$i
=0;$i<6;++$i)

105 
$x
 = (
$i
*(
WORD_WIDTH
+
WORD_SPACING
))+
OFFSET_X
;

106 
$y
 = 
OFFSET_Y
;

107 
$h
 = 
$y
; $h < (
OFFSET_Y
+
WORD_HIGHT
); ++ $h)

109 
$w
 = 
$x
; $w < ($x+
WORD_WIDTH
); ++$w)

111 
$d©a
[
$i
].=
$this
->
D©aA¼ay
[
$h
][
$w
];

117 
	`fÜ—ch
(
$d©a
 
as
 
$numKey
 => 
$numSŒšg
)

119 
$max
=0.0;

120 
$num
 = 0;

121 
	`fÜ—ch
(
$this
->
Keys
 
as
 
$key
 => 
$v®ue
)

123 
$³rûÁ
=0.0;

124 
	`sim¬_‹xt
(
$v®ue
, 
$numSŒšg
,
$³rûÁ
);

125 if(
	`štv®
(
$³rûÁ
è> 
$max
)

127 
$max
 = 
$³rûÁ
;

128 
$num
 = 
$key
;

129 if(
	`štv®
(
$³rûÁ
) > 95)

133 
$»suÉ
.=
$num
;

135 
$this
->
d©a
 = 
$»suÉ
;

137  
$»suÉ
;

138 
	}
}

140 
public
 
funùiÚ
 
	$D¿w
()

142 
$i
=0; $i<
$this
->
ImageSize
[1]; ++$i)

144 
$j
=0; $j<
$this
->
ImageSize
[0]; ++$j)

146 
echo
 
$this
->
D©aA¼ay
[
$i
][
$j
];

148 
echo
 "\n";

150 
	}
}

152 
public
 
funùiÚ
 
	$g‘EachKey
()

154 
$keys
 = 
	`¬¿y
();

155 
$i
=0;$i<6;++$i)

157 
$key
 = "";

158 
$x
 = (
$i
*(
WORD_WIDTH
+
WORD_SPACING
))+
OFFSET_X
;

159 
$y
 = 
OFFSET_Y
;

160 
$h
 = 
$y
; $h < (
OFFSET_Y
+
WORD_HIGHT
); ++ $h)

162 
$w
 = 
$x
; $w < ($x+
WORD_WIDTH
); ++$w)

164 
$key
.=
$this
->
D©aA¼ay
[
$h
][
$w
];

167 
$keys
[
$i
] = 
$key
;

169  
$keys
;

170 
	}
}

171 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

173 
$this
->
Keys
 = 
	`¬¿y
(

190 
	}
}

191 
´Ùeùed
 
	g$ImageP©h
;

192 
´Ùeùed
 
	g$D©aA¼ay
;

193 
´Ùeùed
 
	g$ImageSize
;

194 
´Ùeùed
 
	g$d©a
;

195 
´Ùeùed
 
	g$Keys
;

196 
´Ùeùed
 
	g$NumSŒšgA¼ay
;

	@common/class/ceshi/Valite.php

1 <?
php


3 
defše
('WORD_WIDTH',9);

4 
defše
('WORD_HIGHT',13);

5 
defše
('OFFSET_X',7);

6 
defše
('OFFSET_Y',3);

7 
defše
('WORD_SPACING',4);

9 şas 
	cv®™e


11 
public
 
funùiÚ
 
	$£tImage
(
$Image
)

13 
$this
->
ImageP©h
 = 
$Image
;

15 
public
 
funùiÚ
 
	$g‘D©a
()

17  
$d©a
;

18 
	}
}

19 
public
 
funùiÚ
 
	$g‘ResuÉ
()

21  
$D©aA¼ay
;

22 
	}
}

23 
public
 
funùiÚ
 
	$g‘Hec
()

25 
$»s
 = 
	`imageü—‹äomj³g
(
$this
->
ImageP©h
);

26 
$size
 = 
	`g‘imagesize
(
$this
->
ImageP©h
);

27 
$d©a
 = 
	`¬¿y
();

28 
$i
=0; $˜< 
$size
[1]; ++$i)

30 
$j
=0; $j < 
$size
[0]; ++$j)

32 
$rgb
 = 
	`imagecŞÜ©
(
$»s
,
$j
,
$i
);

33 
$rgb¬¿y
 = 
	`imagecŞÜsfÜšdex
(
$»s
, 
$rgb
);

34 if(
$rgb¬¿y
['red'] < 125 || $rgbarray['green']<125

35 || 
$rgb¬¿y
['blue'] < 125)

37 
$d©a
[
$i
][
$j
]=1;

39 
$d©a
[
$i
][
$j
]=0;

44 
$this
->
D©aA¼ay
 = 
$d©a
;

45 
$this
->
ImageSize
 = 
$size
;

46 
	}
}

47 
public
 
funùiÚ
 
	$run
()

49 
$»suÉ
="";

51 
$d©a
 = 
	`¬¿y
("","","","");

52 
$i
=0;$i<4;++$i)

54 
$x
 = (
$i
*(
WORD_WIDTH
+
WORD_SPACING
))+
OFFSET_X
;

55 
$y
 = 
OFFSET_Y
;

56 
$h
 = 
$y
; $h < (
OFFSET_Y
+
WORD_HIGHT
); ++ $h)

58 
$w
 = 
$x
; $w < ($x+
WORD_WIDTH
); ++$w)

60 
$d©a
[
$i
].=
$this
->
D©aA¼ay
[
$h
][
$w
];

67 
	`fÜ—ch
(
$d©a
 
as
 
$numKey
 => 
$numSŒšg
)

69 
$max
=0.0;

70 
$num
 = 0;

71 
	`fÜ—ch
(
$this
->
Keys
 
as
 
$key
 => 
$v®ue
)

73 
$³rûÁ
=0.0;

74 
	`sim¬_‹xt
(
$v®ue
, 
$numSŒšg
,
$³rûÁ
);

75 if(
	`štv®
(
$³rûÁ
è> 
$max
)

77 
$max
 = 
$³rûÁ
;

78 
$num
 = 
$key
;

79 if(
	`štv®
(
$³rûÁ
) > 95)

83 
$»suÉ
.=
$num
;

85 
$this
->
d©a
 = 
$»suÉ
;

87  
$»suÉ
;

88 
	}
}

90 
public
 
funùiÚ
 
	$D¿w
()

92 
$i
=0; $i<
$this
->
ImageSize
[1]; ++$i)

94 
$j
=0; $j<
$this
->
ImageSize
[0]; ++$j)

96 
echo
 
$this
->
D©aA¼ay
[
$i
][
$j
];

98 
echo
 "\n";

100 
	}
}

101 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

103 
$this
->
Keys
 = 
	`¬¿y
(

116 
	}
}

117 
´Ùeùed
 
	g$ImageP©h
;

118 
´Ùeùed
 
	g$D©aA¼ay
;

119 
´Ùeùed
 
	g$ImageSize
;

120 
´Ùeùed
 
	g$d©a
;

121 
´Ùeùed
 
	g$Keys
;

122 
´Ùeùed
 
	g$NumSŒšgA¼ay
;

	@common/class/ceshi/myValidate.php

1 <?
php


4 
defše
('WORD_WIDTH',10);

5 
defše
('WORD_HIGHT',13);

6 
defše
('OFFSET_X',7);

7 
defše
('OFFSET_Y',3);

8 
defše
('WORD_SPACING',3);

10 şas 
	cv®™e


12 
public
 
funùiÚ
 
	$£tImage
(
$Image
)

14 
$this
->
ImageP©h
 = 
$Image
;

16 
public
 
funùiÚ
 
	$g‘D©a
()

18  
$d©a
;

19 
	}
}

20 
public
 
funùiÚ
 
	$g‘ResuÉ
()

22  
$D©aA¼ay
;

23 
	}
}

24 
public
 
funùiÚ
 
	$g‘Hec
()

26 
$»s
 = 
	`imageü—‹äomj³g
(
$this
->
ImageP©h
);

27 
$size
 = 
	`g‘imagesize
(
$this
->
ImageP©h
);

28 
$d©a
 = 
	`¬¿y
();

29 
$i
=0; $˜< 
$size
[1]; ++$i)

31 
$j
=0; $j < 
$size
[0]; ++$j)

33 
$rgb
 = 
	`imagecŞÜ©
(
$»s
,
$j
,
$i
);

34 
$rgb¬¿y
 = 
	`imagecŞÜsfÜšdex
(
$»s
, 
$rgb
);

35 if(
$rgb¬¿y
['red'] < 94 || $rgbarray['green']<94

36 || 
$rgb¬¿y
['blue'] < 94)

38 
$d©a
[
$i
][
$j
]=1;

40 
$d©a
[
$i
][
$j
]=0;

47 
$i
=0; $˜< 
$size
[1]; ++$i)

49 
$j
=0; $j < 
$size
[0]; ++$j)

51 
$num
 = 0;

52 if(
$d©a
[
$i
][
$j
] == 1)

55 if(
	`is£t
(
$d©a
[
$i
-1][
$j
])){

56 
$num
 = $num + 
$d©a
[
$i
-1][
$j
];

59 if(
	`is£t
(
$d©a
[
$i
+1][
$j
])){

60 
$num
 = $num + 
$d©a
[
$i
+1][
$j
];

63 if(
	`is£t
(
$d©a
[
$i
][
$j
-1])){

64 
$num
 = $num + 
$d©a
[
$i
][
$j
-1];

67 if(
	`is£t
(
$d©a
[
$i
][
$j
+1])){

68 
$num
 = $num + 
$d©a
[
$i
][
$j
+1];

71 if(
	`is£t
(
$d©a
[
$i
-1][
$j
-1])){

72 
$num
 = $num + 
$d©a
[
$i
-1][
$j
-1];

75 if(
	`is£t
(
$d©a
[
$i
-1][
$j
+1])){

76 
$num
 = $num + 
$d©a
[
$i
-1][
$j
+1];

79 if(
	`is£t
(
$d©a
[
$i
+1][
$j
-1])){

80 
$num
 = $num + 
$d©a
[
$i
+1][
$j
-1];

83 if(
	`is£t
(
$d©a
[
$i
+1][
$j
+1])){

84 
$num
 = $num + 
$d©a
[
$i
+1][
$j
+1];

87 if(
$num
 == 0){

88 
$d©a
[
$i
][
$j
] = 0;

94 
$this
->
D©aA¼ay
 = 
$d©a
;

95 
$this
->
ImageSize
 = 
$size
;

97 
	}
}

98 
public
 
funùiÚ
 
	$run
()

100 
$»suÉ
="";

102 
$d©a
 = 
	`¬¿y
("","","","","","");

103 
$i
=0;$i<6;++$i)

105 
$x
 = (
$i
*(
WORD_WIDTH
+
WORD_SPACING
))+
OFFSET_X
;

106 
$y
 = 
OFFSET_Y
;

107 
$h
 = 
$y
; $h < (
OFFSET_Y
+
WORD_HIGHT
); ++ $h)

109 
$w
 = 
$x
; $w < ($x+
WORD_WIDTH
); ++$w)

111 
$d©a
[
$i
].=
$this
->
D©aA¼ay
[
$h
][
$w
];

117 
	`fÜ—ch
(
$d©a
 
as
 
$numKey
 => 
$numSŒšg
)

119 
$max
=0.0;

120 
$num
 = 0;

121 
	`fÜ—ch
(
$this
->
Keys
 
as
 
$key
 => 
$v®ue
)

123 
$³rûÁ
=0.0;

124 
	`sim¬_‹xt
(
$v®ue
, 
$numSŒšg
,
$³rûÁ
);

125 if(
	`štv®
(
$³rûÁ
è> 
$max
)

127 
$max
 = 
$³rûÁ
;

128 
$num
 = 
$key
;

129 if(
	`štv®
(
$³rûÁ
) > 95)

133 
$»suÉ
.=
$num
;

135 
$this
->
d©a
 = 
$»suÉ
;

137  
$»suÉ
;

138 
	}
}

140 
public
 
funùiÚ
 
	$D¿w
()

142 
$i
=0; $i<
$this
->
ImageSize
[1]; ++$i)

144 
$j
=0; $j<
$this
->
ImageSize
[0]; ++$j)

146 
echo
 
$this
->
D©aA¼ay
[
$i
][
$j
];

148 
echo
 "\n";

150 
	}
}

152 
public
 
funùiÚ
 
	$g‘EachKey
()

154 
$keys
 = 
	`¬¿y
();

155 
$i
=0;$i<6;++$i)

157 
$key
 = "";

158 
$x
 = (
$i
*(
WORD_WIDTH
+
WORD_SPACING
))+
OFFSET_X
;

159 
$y
 = 
OFFSET_Y
;

160 
$h
 = 
$y
; $h < (
OFFSET_Y
+
WORD_HIGHT
); ++ $h)

162 
$w
 = 
$x
; $w < ($x+
WORD_WIDTH
); ++$w)

164 
$key
.=
$this
->
D©aA¼ay
[
$h
][
$w
];

167 
$keys
[
$i
] = 
$key
;

169  
$keys
;

170 
	}
}

171 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

173 
$this
->
Keys
 = 
	`¬¿y
(

190 
	}
}

191 
´Ùeùed
 
	g$ImageP©h
;

192 
´Ùeùed
 
	g$D©aA¼ay
;

193 
´Ùeùed
 
	g$ImageSize
;

194 
´Ùeùed
 
	g$d©a
;

195 
´Ùeùed
 
	g$Keys
;

196 
´Ùeùed
 
	g$NumSŒšgA¼ay
;

	@common/class/ceshi/test.php

1 <?
php


3 
šşude
 ('myValidate.php');

5 
	g$v®™e
 = 
Ãw
 
V®™e
();

8 
	g$v®™e
->
£tImage
('/private/var/folders/jw/hpkgc5792xq6d700spxpmd9c0000gn/T/jpgA251Cc');

9 
	g$v®™e
->
g‘Hec
();

10 
	g$v®™e
->
D¿w
();

11 
	g$»suÉ
 = 
$v®™e
->
run
();

12 
echo
 
	g$»suÉ
;

	@common/common.php

1 <?
php


2 
»quœe_Úû
('constants.php');

3 
»quœe_Úû
('utilities.php');

7 
funùiÚ
 
	$»dœeù
(
$u¾
) {

8 if(!
	`em±y
(
$u¾
))

10 
	`h—d”
("Location: {$url}");

12 
ex™
;

13 
	}
}

18 
funùiÚ
 
	$is_·¹Ãr_logš
()

20 
	`£ssiÚ_¡¬t
();

21 ià(
	`is£t
(
$_SESSION
['partnerId']))

22  (
$_SESSION
['partnerId'] > 0);

23  
çl£
;

24 
	}
}

33 
funùiÚ
 
	$üy±_·ss
(
$·ss
)

35 ià(
	`em±y
(
$·ss
))

36  
çl£
;

37 
$§É
 = 
	`sub¡r
(
	`md5
(
$·ss
), 0, 2);

38  
	`md5
(
	`üy±
(
$·ss
, 
$§É
));

39 
	}
}

51 
funùiÚ
 
	$g‘_·geNavHtml
(
$·ge
, 
$tÙ®Pages
, 
$u¾P»fix
, 
$showPagesNums
 = 11)

53 ià(
$tÙ®Pages
 <ğ0 || 
$·ge
 <= 0)

55 ià(
$showPagesNums
 <3 || $showPagesNums%2 === 0)

57 
$·geNavHtml
 = "";

59 
$sideShowPages
 = 
	`æoÜ
(
$showPagesNums
/2);

60 
$¡¬t
 = (
$·ge
 - 
$sideShowPages
) > 1? $page-$sideShowPages : 1;

61 
$’d
 = (
$·ge
 + 
$sideShowPages
è< 
$tÙ®Pages
? $page+$sideShowPages : $totalPages;

63 
$i
 = 
$¡¬t
; $i<=
$’d
; $i++)

65 
$—chPageU¾
 = 
$u¾P»fix
."·ge=".
$i
;

66 
$·geNavHtml
 .= "<a href='$eachPageUrl' id='page_num_$i'>$i</a>&nbsp";

68  
$·geNavHtml
;

69 
	}
}

	@common/constants.php

1 <?
	gphp


5 
defše
('LAIQU_OFFICE_IP', '120.193.28.30');

6 
defše
('WEBROOT','http://localhost:8888/laiqu');

11 
defše
('LQ_OK', 0);

12 
defše
('LQ_FAIL', 1);

	@common/functions/common.funcs.php

1 <?
php


13 
funùiÚ
 
	$g‘_ş›Á_
() {

14 ià(
	`g‘’v
 ( "HTTP_CLIENT_IP" ) && 
	`¡rÿ£cmp
 ( getenv ( "HTTP_CLIENT_IP" ), "unknown" ))

15 
$
 = 
	`g‘’v
 ( "HTTP_CLIENT_IP" );

16 ià(
	`g‘’v
 ( "HTTP_X_FORWARDED_FOR" ) && 
	`¡rÿ£cmp
 ( getenv ( "HTTP_X_FORWARDED_FOR" ), "unknown" ))

17 
$
 = 
	`g‘’v
 ( "HTTP_X_FORWARDED_FOR" );

18 ià(
	`g‘’v
 ( "REMOTE_ADDR" ) && 
	`¡rÿ£cmp
 ( getenv ( "REMOTE_ADDR" ), "unknown" ))

19 
$
 = 
	`g‘’v
 ( "REMOTE_ADDR" );

20 ià(
	`is£t
 ( 
$_SERVER
 ['REMOTE_ADDR'] ) && $_SERVER ['REMOTE_ADDR'] && 
	`¡rÿ£cmp
 ( $_SERVER ['REMOTE_ADDR'], "unknown" ))

21 
$
 = 
$_SERVER
 ['REMOTE_ADDR'];

23 
$
 = "unknown";

24  (
$
);

25 
	}
}

28 
funùiÚ
 
	$fšdCook›
(
$Çme
, 
$cook›s
)

30 
	`fÜ—ch
 (
$cook›s
 
as
 
$cook›
)

32 ià(
$cook›
['Çme'] ==ğ
$Çme
)

34  
$cook›
;

38 
	}
}

	@common/include/errorCatcher.php

1 <?
php


12 
funùiÚ
 
	$ruÁimeE¼ÜHªdËr
(
$”ºo
, 
$”r¡r
, 
$”rfe
, 
$”¾še
)

15 
	`”rÜ_log
(
$”r¡r
);

16 
ex™
;

17 
	}
}

18 
funùiÚ
 
	$exû±iÚHªdËr
(
$exû±iÚ
)

20 
$”r¡r
 = 
$exû±iÚ
->
	`g‘Mes§ge
();

22 
	`”rÜ_log
(
$”r¡r
);

23 
ex™
;

24 
	}
}

25 
£t_”rÜ_hªdËr
('ruÁimeE¼ÜHªdËr', 
E_ERROR
);

26 
£t_exû±iÚ_hªdËr
('exceptionHandler');

	@common/templates/left_nav_bar.php

1 <
div
 
	gşass
="nav">

2 <
p
 
şass
="nav_title">å•†æˆ·ç®¡ç†</p>

3 <
div
 
id
="nav_bg_verifycoupon">

4 <
a
 
şass
="Çv_‹xt" 
h»f
="../v”ifyCoupÚ/šdex.php" cÏss="Çv_bg">æ¶ˆ è´¹ ç™» è®°</a><
br
 />

5 </
div
>

6 <
div
 
id
="Çv_bg_¡©i¡ics"><
a
 
şass
="Çv_‹xt" 
h»f
="../¡©i¡ics/‹amLi¡.php">é¡¹ ç›® ç»Ÿ è®¡</a><
br
 /></div>

7 <!--<
div
 
id
="Çv_bg_comm’ts"><
a
 
şass
="Çv_‹xt" 
h»f
="#">æ¶ˆ è´¹ è¯„ ä»·</a><
br
 /></div>-->

8 <
div
 
id
="Çv_bg_acùmªag”"><
a
 
şass
="Çv_‹xt" 
h»f
="../acùMªag”/chªgePass.php">ä¿® æ”¹ å¯† ç </a><
br
 /></div>

9 <
hr
 
şass
='divide_line' />

10 <
div
 
id
="Çv_bg_ass™" 
şass
="nav_bg_assit_class">

11 <
a
 
şass
="Çv_‹xˆÇv_‹xt_ass™" 
h»f
="../verifyLogin/loginOut.php">é€€ å‡º </a>

12 <
a
 
şass
="Çv_‹xˆÇv_‹xt_ass™" 
h»f
="#">å¸® åŠ©</a>

13 </
div
>

14 </
div
>

	@common/utilities.php

1 <?
php


11 
»quœe_Úû
('CodeMessages.php');

24 
funùiÚ
 
g’_»¥Ú£_jsÚ
(
$codeMsg
, 
$»suÉ
, 
$msg
 = "")

27 ià(
em±y
(
$codeMsg
è|| !
şass_exi¡s
($codeMsg))

29 
$code
 = 
CommÚCodeMsg
::
CODEMSG_CLASS_NOT_EXIST
;

30 
	g$msg
 = 
CommÚCodeMsg
::
g‘_mes§ge
(
$code
);

32 
	g$code
 = 
$»suÉ
;

33 ià(
	g$msg
 == "")

36 
$codeMsgIn¡ªû
 = 
Ãw
 
$codeMsg
();

37 
	g$msg
 = 
$codeMsgIn¡ªû
->
g‘_mes§ge
(
$code
);

40 ià(
em±y
(
$msg
))

42 
	g$code
 = 
CommÚCodeMsg
::
INVALID_ARGUMENT_ERROR
;

43 
	g$msg
 = 
CommÚCodeMsg
::
g‘_mes§ge
(
$code
);

48 
	g$»¥Ú£
['code'] = 
$code
;

49 
	g$»¥Ú£
['msg'] = 
$msg
;

50 
	g$»¥Ú£
['d©eTime'] = 
d©e
("Y-m-d, h:i:s");

52  
jsÚ_’code
(
$»¥Ú£
);

63 
funùiÚ
 
	$ÿl_tÙ®Pages
(
$rowNums
, 
$rowNumsEachPage
)

65 ià(
$rowNums
 > 0)

67 
$tÙ®Pages
 = 
	`û
(
$rowNums
/
$rowNumsEachPage
);

69 
$tÙ®Pages
 = 0;

71  
$tÙ®Pages
;

72 
	}
}

	@cpapi/constants.php

1 <?
php


12 
defše
('ALLOWED_IP','127.0.0.1');

17 
defše
('ACCESS_NOT_ALLOWED',9999);

18 
defše
('UNKNOWN_EXCEPTION',10000);

20 
defše
('COUPON_IS_VALID', 1001);

21 
defše
('COUPON_USED_OK', 1002);

22 
defše
('COUPON_INVALID_USED', 1003);

23 
defše
('COUPON_ENDED', 1004);

24 
defše
('COUPON_INVALID', 1005);

25 
defše
('COUPON_WRONG_PWD', 1006);

29 
defše
("COUPON_VERIFY_OK", 100);

30 
defše
("COUPON_VERIRY_FAILED", 101);

31 
defše
("COUPON_CONSUME_OK", 102);

32 
defše
("COUPON_CONSUME_FAILED", 103);

33 
defše
("COUPON_CONSUME_NOT_EXIST", 104);

34 
defše
("COUPON_CONSUME_USED", 105);

35 
defše
("COUPON_CONSUME_EXPIRED", 106);

36 
defše
("PARTNER_OR_PLATFORM_BIND",107);

37 
defše
("PLATFORM_LOGIN_FAILED", 108);

38 
defše
("PLATFORM_NOT_BIND", 109);

41 
defše
("PARTNER_BINDED", 200);

42 
defše
("PARTNER_NOT_BIND", 201);

43 
defše
("PARTNER_BIND_OK", 202);

44 
defše
("PARTNER_NOT_EXIST", 203);

45 
defše
("PARTNER_UNBIND_OK", 204);

46 
defše
("PARTNER_UNBIND_FAILED", 205);

	@cpapi/cp_init.php

1 <?
php


13 
	g»quœe_Úû
 'constants.php';

14 
	g»quœe_Úû
 'functions.php';

15 
	g»quœe_Úû
 '../module/Coupon.php';

16 
	g»quœe_Úû
 '../module/Order.php';

17 
	g»quœe_Úû
 '../module/Partner.php';

18 
	g»quœe_Úû
 '../module/PartnerPlatforms.php';

19 
	g»quœe_Úû
 '../module/Team.php';

21 @
£ssiÚ_¡¬t
();

22 
	g$mysql
 = 
Ãw
 
MyTabË
();

25 
	g$
 = 
g‘_ş›Á_
();

	@cpapi/functions.php

1 <?
php


11 
	g»quœe_Úû
 '../common/functions/common.funcs.php';

12 
	g»quœe_Úû
 '../common/class/Valite.php';

13 
	g»quœe_Úû
 '../verifyCoupon/VerifyCoupon.php';

14 
	g»quœe_Úû
 '../common/RESTclient.php';

19 
funùiÚ
 
	$g’_»¥Ú£
(
$»suÉ
)

21 
$¡©u£s
 = 
	`¬¿y
(

22 
COUPON_VERIFY_OK
 => 'done',

23 
COUPON_VERIRY_FAILED
 => 'failed',

24 
COUPON_CONSUME_OK
 => 'done',

25 
COUPON_CONSUME_FAILED
 => 'failed',

26 
COUPON_CONSUME_NOT_EXIST
 => 'failed',

27 
COUPON_CONSUME_USED
 => 'failed',

28 
COUPON_CONSUME_EXPIRED
 => 'failed',

29 
PARTNER_BINDED
 => 'done',

30 
PARTNER_NOT_BIND
 => 'failed',

31 
PARTNER_BIND_OK
 => 'done',

32 
PARTNER_NOT_EXIST
 => 'failed',

33 
PARTNER_UNBIND_OK
 => 'done',

34 
PARTNER_UNBIND_FAILED
 => 'failed',

35 
PARTNER_OR_PLATFORM_BIND
=>'failed',

36 
PLATFORM_LOGIN_FAILED
=>'failed',

37 
PLATFORM_NOT_BIND
=>'failed',

38 
UNKNOWN_EXCEPTION
=>'failed'

40 
$»¥Ú£
 = "¡©us=".
$¡©u£s
[
$»suÉ
]."&result=$result";

41  
$»¥Ú£
;

42 
	}
}

46 
funùiÚ
 
	$do_logšPÏtfÜm
(
$¶©fÜm
,
$·¹ÃrId
)

48 
$»suÉ
 = 
çl£
;

49 ià(
$¶©fÜm
 === 'juhuasuan')

52 
$ŒyTimes
 = 5;

53 
$i
=0; $˜< 
$ŒyTimes
; $i++)

55 
$»suÉ
 = 
	`logš_¶©fÜm
('juhuasuª', 
$·¹ÃrId
);

56 ià(
$»suÉ
 === "platform_not_bind")

60 ià(
$»suÉ
 !ğ
çl£
)

66  
$»suÉ
;

67 
	}
}

71 
funùiÚ
 
	$logš_¶©fÜm
(
$¶©fÜm
, 
$·¹ÃrId
)

73 ià(
$¶©fÜm
 === 'juhuasuan')

76 
$sucûss
 = 
çl£
;

77 
$ÿ±chaJ£s
 = 
	`g‘_logš_v®id©e_img·th_j£s
(
$¶©fÜm
);

78 
$ÿ±chaP©h
 = 
$ÿ±chaJ£s
['captchaPath'];

79 
$j£ssiÚid
 = 
$ÿ±chaJ£s
['jsessionid'];

81 
$v®id©eCode
 = 
	`decode_ÿ±cha
(
$ÿ±chaP©h
);

82 
	`uÆšk
(
$ÿ±chaP©h
);

84 
$logšU¾
 = "http://59.151.29.121/shopUsed/shopLogin.do";

86 
$·¿ms
 = 
	`g‘_juhuasuª_logš_·¿ms
(
$·¹ÃrId
);

87 ià(
$·¿ms
 ==ğ
nuÎ
)

91 
$·¿ms
['mod–.v®id©eCode'] = 
$v®id©eCode
;

92 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

93 
$»¡
->
	`ü—‹Reque¡
(
$logšU¾
,'POST',
$·¿ms
);

96 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

97 
$»q
->
	`£tCook›J¬
();

98 
$»q
->
	`addCook›
("JSESSIONID", 
$j£ssiÚid
);

99 
$»¡
->
	`£ndReque¡
();

100 
$»¥Ú£
 = 
$»¡
->
	`g‘Re¥Ú£
();

101 
	`un£t
(
$»¡
);

102 
$sucûss
 = 
	`is_logš_sucûss
(
$»¥Ú£
, 
$¶©fÜm
);

104 ià(
$sucûss
 ==ğ
Œue
)

106 
$sucûss
 = 
$j£ssiÚid
;

108  
$sucûss
;

110 
	}
}

112 
funùiÚ
 
	$g‘_juhuasuª_logš_·¿ms
(
$·¹ÃrId
)

114 
$·¹ÃrPÏtfÜms
 = 
Ãw
 
	`P¬Š”PÏtfÜms
();

115 ià(
$·¹ÃrId
 < 0)

117  
nuÎ
;

119 
$µRow
 = 
$·¹ÃrPÏtfÜms
->
	`g‘_row
(

120 
	`¬¿y
(

121 "·¹Ãr_id" => 
$·¹ÃrId
,

126 ià(
$µRow
 ==ğ
nuÎ
) { ‚ull; }

128 
$·¿ms
 = 
	`¬¿y
 (

129 "mod–.sign" => 
$µRow
['p_username'],

130 "mod–.·sswÜd" => 
$µRow
['p_password'],

131 "mod–.‹rmš®Id" => 
$µRow
['p_terminalid']);

132  
$·¿ms
;

133 
	}
}

136 
funùiÚ
 
	$g‘_logš_v®id©e_img·th_j£s
(
$¶©fÜm
)

138 
$tmp_ÿ±cha_Çme
 = '';

139 ià(
$¶©fÜm
 === "juhuasuan")

141 
$ÿ±chaU¾
 = 'h‰p://59.151.29.121/v®id©eCode.do?'.
	`d©e
(
	`mktime
());

142 
$imgSuffix
 = 'jpg';

145 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

146 
$»¡
->
	`ü—‹Reque¡
(
$ÿ±chaU¾
);

147 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

148 
$»¡
->
	`£ndReque¡
();

149 
$»¥Ú£Obj
 = 
$»¡
->
	`g‘Re¥Ú£Obj
();

150 
$j£ssiÚid
 = 
	`fšdCook›
("JSESSIONID", 
$»¥Ú£Obj
->
	`g‘Cook›s
());

151 ià(
$j£ssiÚid
 != '')

153 
$»q
->
	`addCook›
("JSESSIONID", 
$j£ssiÚid
['value']);

155 
$tmp_ÿ±cha_Çme
 = 
	`‹m²am
(
	`sys_g‘_‹mp_dœ
(),
$imgSuffix
);

156 
	`fe_put_cÚ‹Ás
(
$tmp_ÿ±cha_Çme
, 
$»¡
->
	`g‘Re¥Ú£
());

157  
	`¬¿y
(

158 "ÿ±chaP©h"=>
$tmp_ÿ±cha_Çme
,

159 "j£ssiÚid"=>
$j£ssiÚid
['value']);

160 
	}
}

163 
funùiÚ
 
	$is_logš_sucûss
(
$»¥Ú£
, 
$¶©fÜm
)

165 ià(
$¶©fÜm
 === 'juhuasuan')

168 iàĞ1 !=ğ
	`´eg_m©ch
('/g‘Li¡\(\"shİU£d\/h—d”s\.do\"\)/', 
$»¥Ú£
))

170  
çl£
;

172  
Œue
;

174 
	}
}

177 
funùiÚ
 
	$doV”ifyCoupÚ
(
$»que¡
)

179 
$¶©fÜm
 = 
$»que¡
['platform'];

180 
$v”ifyCoupÚ
 = 
Ãw
 
	`V”ifyCoupÚ
();

182 
$v”ifyCoupÚ
->
	`š™
(
$¶©fÜm
);

184 
$šputs
 = 
$v”ifyCoupÚ
->
	`š™_v”ifyIÅuts
(
$»que¡
);

185 
$coupÚId
 = 
$šputs
['couponId'];

186 ià(
$¶©fÜm
 === 'juhuasuan')

188 
$šputs
['‹rmš®id'] = 
$»que¡
['terminalId'];

191 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

192 
$·¿ms
 = 
$v”ifyCoupÚ
->
	`g‘_»que¡P¬ams
(
$šputs
);

194 ià(
$v”ifyCoupÚ
->
	`g‘_h‰pM‘hod
() == 'POST') {

195 
$»¡
->
	`ü—‹Reque¡
(
$v”ifyCoupÚ
->
	`g‘_­iU¾
(), 'POST', 
$·¿ms
);

197 
$»¡
->
	`ü—‹Reque¡
(
$v”ifyCoupÚ
->
	`g‘_­iU¾
());

198 
$u¾
 = 
$»¡
->
	`g‘U¾
();

199 
$u¾
->
	`£tQu”yV¬ŸbËs
(
$·¿ms
);

201 
$»¥Ú£
 = '';

204 ià(
$¶©fÜm
 === "juhuasuan")

206 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

207 
$»q
->
	`addCook›
("JSESSIONID", 
$»que¡
['jsessionid']);

210 
$»¡
->
	`£ndReque¡
();

211 
$»¥Ú£
 = 
$»¡
->
	`g‘Re¥Ú£
();

212 
$»¥Ú£Code
 = 
$v”ifyCoupÚ
->
	`g‘_»¥Ú£Code
(
$»¥Ú£
);

213  
$»¥Ú£Code
;

214 
	}
}

216 
funùiÚ
 
	$decode_ÿ±cha
(
$ÿ±chaP©h
)

218 
$v®™e
 = 
Ãw
 
	`V®™e
();

220 
$v®™e
->
	`£tImage
(
$ÿ±chaP©h
);

221 
$v®™e
->
	`g‘Hec
();

222 
$v®id©eCode
 = 
$v®™e
->
	`run
();

224  
$v®id©eCode
;

225 
	}
}

228 
funùiÚ
 
	$»cÜd_cÚsumed_coupÚ
(
$»cÜdP¬ams
)

230 
$coupÚId
 = 
$»cÜdP¬ams
['couponId'];

231 
$¶©fÜm
 = 
$»cÜdP¬ams
['platform'];

232 
$cÚsumed_times
 = 
$»cÜdP¬ams
['consumed_times'];

233 
$·¹ÃrId
 = 
$»cÜdP¬ams
['partnerId'];

234 
$j£ssiÚid
 = 
$»cÜdP¬ams
['jsessionid'];

236 
$coupÚ
 = 
Ãw
 
	`CoupÚ
();

237 
$cÚd™iÚs
 = 
	`¬¿y
(

238 "¶©fÜm_coupÚ_id"=>
$coupÚId
,

239 "¶©fÜm_key"=>
$¶©fÜm
);

240 
$cÚsumedCoupÚs
 = 
$coupÚ
->
	`g‘_row
(
$cÚd™iÚs
);

242 ià(!
	`is_num”ic
(
$cÚsumed_times
) || $consumed_times < 1)

244  
çl£
;

246 ià(
$cÚsumedCoupÚs
 !=ğ
nuÎ
 && 
$¶©fÜm
 === "juhuasuan")

248  
$coupÚ
->
	`cÚsume_coupÚ
(
$cÚsumedCoupÚs
['id'], 
$cÚsumed_times
);

249 } ià(
$¶©fÜm
 === "juhuasuan")

252 
$Üd”Info
 = 
	`»cÜd_Üd”
(
$»cÜdP¬ams
);

255 ifĞ
$Üd”Info
 ==ğ
çl£
)

257  
çl£
;

260 
$š£¹CoupÚ
 = 
	`¬¿y
(

261 "¶©fÜm_key" => 
$Üd”Info
['platform_key'],

262 "·¹Ãr_id" => 
$·¹ÃrId
,

263 "‹am_id" => 
$Üd”Info
['team_id'],

264 "Üd”_id" => 
$Üd”Info
['id'],

266 "cÚsume_time" => 
	`mktime
(),

267 "ü—‹_time" => 
	`mktime
(),

268 "cÚsume_times" => 
$cÚsumed_times
,

269 "¶©fÜm_coupÚ_id" => 
$coupÚId
,

270 "cÚsum”_mobe" => 
$Üd”Info
['consumer_mobile'],

273  
$coupÚ
->
	`š£¹_coupÚ
(
$š£¹CoupÚ
);

275 
	}
}

277 
funùiÚ
 
	$»cÜd_Üd”
(
$»cÜdP¬ams
)

279 
$coupÚId
 = 
$»cÜdP¬ams
['couponId'];

280 
$¶©fÜm
 = 
$»cÜdP¬ams
['platform'];

281 
$cÚsumed_times
 = 
$»cÜdP¬ams
['consumed_times'];

282 
$·¹ÃrId
 = 
$»cÜdP¬ams
['partnerId'];

283 
$j£ssiÚid
 = 
$»cÜdP¬ams
['jsessionid'];

286 
$Üd”Info
 = 
	`g‘_Üd”Info
(
$»cÜdP¬ams
);

287 ià(!
	`is_¬¿y
(
$Üd”Info
è|| 
	`em±y
($orderInfo))

289  
çl£
;

292 
$Üd”Info
['¶©fÜm_key'] = 
$¶©fÜm
;

293 
$Üd”Info
['cÚsume_times'] = 
$cÚsumed_times
;

294 
$Üd”Info
['·¹Ãr_id'] = 
$·¹ÃrId
;

295 
$Üd”Info
['¶©fÜm_coupÚ_id'] = 
$coupÚId
;

297 
$Üd”Id
 = 
$Üd”Info
['platform_order_id'];

298 
$Üd”
 = 
Ãw
 
	`Ord”
();

299 
$cÚd™iÚs
 = 
	`¬¿y
(

300 "¶©fÜm_Üd”_id"=>
$Üd”Id
,

301 "¶©fÜm_key"=>
$¶©fÜm
);

302 
$»cÜdedOrd”
 = 
$Üd”
->
	`g‘_row
(
$cÚd™iÚs
);

304 ià(
$»cÜdedOrd”
 !=ğ
nuÎ
 && 
$¶©fÜm
 === "juhuasuan")

306 
$»cÜdedOrd”
['cÚsum”_mobe'] = 
$Üd”Info
['consumer_mobile'];

307  
$»cÜdedOrd”
;

308 } if(
$¶©fÜm
 === "juhuasuan")

310 
$»cÜdedT—m
 = 
	`»cÜd_‹am_by_Üd”
(
$Üd”Info
);

311 
$Üd”Info
['‹am_id'] = 
$»cÜdedT—m
['id'];

313 
$š£¹Ord”
 = 
	`¬¿y
(

314 "‹am_id" => 
$Üd”Info
['team_id'],

315 "ü—‹_time" => 
	`mktime
(),

316 "¶©fÜm_Üd”_id" => 
$Üd”Info
['platform_order_id'],

317 "¶©fÜm_key" => 
$Üd”Info
['platform_key']

319 
$Üd”In£¹ed
 = 
$Üd”
->
	`š£¹_Üd”
(
$š£¹Ord”
);

321 
$Üd”In£¹ed
['cÚsum”_mobe'] = 
$Üd”Info
['consumer_mobile'];

322  
$Üd”In£¹ed
;

324 
	}
}

327 
funùiÚ
 
	$»cÜd_‹am_by_Üd”
(
$Üd”Info
)

329 
$‹am
 = 
Ãw
 
	`T—m
();

330 ià(
	`is_¬¿y
(
$Üd”Info
è&& !
	`em±y
($orderInfo))

333 
$‹amRow
 = 
$‹am
->
	`g‘_row
(

334 
	`¬¿y
("t™Ë"=>
$Üd”Info
['title'],

335 "¶©fÜm_key"=>
$Üd”Info
['platform_key']));

337 ià(!
	`is_¬¿y
(
$‹amRow
è|| 
	`em±y
($teamRow))

339 
$‹amInfo
 = 
	`¬¿y
(

340 "t™Ë" => 
$Üd”Info
['title'],

341 "¶©fÜm_key" => 
$Üd”Info
['platform_key'],

342 "summ¬y" => 
$Üd”Info
['summary'],

343 "·¹Ãr_id" => 
$Üd”Info
['partner_id'],

344 "‹am_´iû" => 
$Üd”Info
['team_price']

346  
$‹am
->
	`š£¹_‹am
(
$‹amInfo
);

348  
$‹amRow
;

351  
çl£
;

353 
	}
}

356 
funùiÚ
 
	$g‘_Üd”Info
(
$»cÜdP¬ams
)

358 
$coupÚId
 = 
$»cÜdP¬ams
['couponId'];

359 
$¶©fÜm
 = 
$»cÜdP¬ams
['platform'];

360 
$cÚsumed_times
 = 
$»cÜdP¬ams
['consumed_times'];

361 
$·¹ÃrId
 = 
$»cÜdP¬ams
['partnerId'];

362 
$j£ssiÚid
 = 
$»cÜdP¬ams
['jsessionid'];

364 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

365 
$ÏiquOrd”
 = 
	`¬¿y
();

367 ià(
$¶©fÜm
 === "juhuasuan")

369 
$·¿ms
 = 
	`¬¿y
("mod–.ass™Code" => 
$coupÚId
);

370 
$»¡
->
	`ü—‹Reque¡
("h‰p://59.151.29.121/shİU£d/li¡.do", 'POST', 
$·¿ms
);

371 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

372 
$»q
->
	`addCook›
("JSESSIONID", 
$j£ssiÚid
);

373 
$»¡
->
	`£ndReque¡
();

374 
$»¥Ú£
 = 
$»¡
->
	`g‘Re¥Ú£
();

376 
$»¥Ú£
 = 
	`tidy_ugly_jsÚ
($»¥Ú£,
$¶©fÜm
);

377 
$»suÉ
 = 
	`jsÚ_decode
(
$»¥Ú£
);

379 ià(
$»suÉ
->
sucûss
 ==ğ
çl£
 && $»suÉ->
¡©us
 === 302)

381  
V”ifyCoupÚCodeMsg
::
JUHUASUAN_LOGIN_EXPIRED
;

383 ià(
	`is£t
(
$»suÉ
->
d©a
è&& 
	`couÁ
($result->data) > 0)

385 
$Üd”
 = 
$»suÉ
->
d©a
[0];

386 
$ÏiquOrd”
 = 
	`cÚv”t_Üd”
(
$Üd”
, 
$¶©fÜm
);

387 } ià(
	`is£t
(
$»suÉ
->
d©a
)){

388  
V”ifyCoupÚCodeMsg
::
COUPON_NOT_EXIST
;

392  
$ÏiquOrd”
;

393 
	}
}

396 
funùiÚ
 
	$cÚv”t_Üd”
(
$Üd”Info
, 
$¶©fÜm
)

398 
$Üd”
 = 
	`¬¿y
();

399 ià(
$¶©fÜm
 === "juhuasuan")

401 
$Üd”
['t™Ë'] = 
$Üd”Info
->
´oduù
;

402 
$Üd”
['summ¬y'] = 
$Üd”Info
->
desütiÚ
;

404 
$Üd”
['‹am_´iû'] = 
	`æßtv®
(
	`sub¡r
(
$Üd”Info
->
·ym’t
, 3));

405 
$Üd”
['¶©fÜm_key'] = 
$¶©fÜm
;

406 
$Üd”
['¶©fÜm_Üd”_id'] = 
$Üd”Info
->
obaoId
;

407 
$Üd”
['cÚsum”_mobe'] = 
$Üd”Info
->
»ûiMobe
;

410  
$Üd”
;

412 
	}
}

415 
funùiÚ
 
	$tidy_ugly_jsÚ
(
$uglyJsÚ
, 
$¶©fÜm
)

417 
$b—utifulJsÚ
 = "";

418 ià(
$¶©fÜm
 === "juhuasuan")

421 
$uglyJsÚ
 = 
	`´eg_»¶aû
('/items\s*:\s*\[[^<]+?\]/','', $uglyJson);

422 
$uglyJsÚ
 = 
	`´eg_»¶aû
('/\s*:\s*/',':', $uglyJson);

424 
$uglyJsÚ
 = 
	`´eg_»¶aû_ÿÎback
('/([\{,]\s*)([[\w\d]+)(\s*:)/',"add_double_quote", $uglyJson);

426 
$b—utifulJsÚ
 = 
	`´eg_»¶aû
('/(,\s*)([\}\]])/','${2}',
$uglyJsÚ
);

428 
$b—utifulJsÚ
 = 
	`´eg_»¶aû
("/'(.*)'/",'"${1}"', $beautifulJson);

431  
$b—utifulJsÚ
;

432 
	}
}

433 
funùiÚ
 
	$add_doubË_quÙe
(
$m©ches
)

436  
$m©ches
[1].'"'.$matches[2].'":';

437 
	}
}

	@cpapi/telapi.php

1 <?
php


16 
	g»quœe
 'cp_init.php';

18 
funùiÚ
 
	$ruÁimeE¼ÜHªdËr
(
$”ºo
, 
$”r¡r
, 
$”rfe
, 
$”¾še
)

21 
$code
 = 
UNKNOWN_EXCEPTION
;

23 
	`”rÜ_log
(
$”r¡r
);

24 
	`d›
(
	`g’_»¥Ú£
(
UNKNOWN_EXCEPTION
));

26 
	}
}

27 
funùiÚ
 
	$exû±iÚHªdËr
(
$exû±iÚ
)

29 
$code
 = 
UNKNOWN_EXCEPTION
;

30 
	`d›
(
	`g’_»¥Ú£
(
$code
));

31 
	}
}

32 
£t_”rÜ_hªdËr
('ruÁimeE¼ÜHªdËr', 
E_ERROR
);

33 
£t_exû±iÚ_hªdËr
('exceptionHandler');

35 
	g$aùiÚ
 = 
¡¹Şow”
(
Œim
(
$_REQUEST
['action']));

37 
	g$ÿÎ”id
 = 
add¦ashes
(
Œim
(
$_REQUEST
['callerid']));

38 
	g$cidL’gth
 = 
¡¾’
(
$ÿÎ”id
);

39 ià(
	g$cidL’gth
 =ğ12 || 
$cidL’gth
 == 9 ||

40 
sub¡r
(
$ÿÎ”id
, 0, 1) === '0')

42 
$ÿÎ”id
 = 
sub¡r
($callerid,1);

46 if(
	g$aùiÚ
=='consume')

49 
$coupÚId
 = 
add¦ashes
(
Œim
(
$_REQUEST
['couponid']));

50 
	g$cÚsumeTimes
 = 
add¦ashes
(
Œim
(
$_REQUEST
['consumetimes']));

51 
	g$¶©fÜm
 = 
add¦ashes
(
Œim
(
$_REQUEST
['platform']));

54 
	g$·¹ÃrSql
 = "SELECT….id‡ ·¹Ãr_id,p.·¹Ãr_acù,µ.p_‹rmš®id FROM ".
$mysql
->
g‘_dbTabËName
("partner")."…,".$mysql->get_dbTableName("partner_platforms")."…p,";

55 
	g$·¹ÃrSql
 .ğ
$mysql
->
g‘_dbTabËName
("partner_bind")."…b ";

56 
	g$·¹ÃrSql
 .ğ" WHERE….·¹Ãr_acùõb.·¹Ãr_acù‡nd…b.phÚ’um='$ÿÎ”id'‡nd….idõp.·¹Ãr_id‡nd…p.¶©fÜm_key='".
$¶©fÜm
."'‡nd…p.status=1";

57 
	g$·¹ÃrResuÉ
 = 
$mysql
->
qu”y
(
$·¹ÃrSql
);

58 ià(!
	g$·¹ÃrResuÉ
 && 
mysql_num_rows
(
$·¹ÃrSql
) > 0)

60 
echo
 
g’_»¥Ú£
(
PARTNER_OR_PLATFORM_BIND
);

61 
	gex™
;

63 
	g$·¹ÃrRow
 = 
mysql_ãtch_¬¿y
(
$·¹ÃrResuÉ
);

64 
	g$·¹ÃrId
 = 
$·¹ÃrRow
['partner_id'];

65 
	g$·¹ÃrAcù
 = 
$·¹ÃrRow
['partner_acct'];

66 
	g$‹rmš®Id
 = 
$·¹ÃrRow
['p_terminalid'];

69 
	g$logšResuÉ
 = 
do_logšPÏtfÜm
(
$¶©fÜm
,
$·¹ÃrId
);

71 ià(
	g$logšResuÉ
 ==ğ
çl£
)

73 
echo
 
g’_»¥Ú£
(
PLATFORM_LOGIN_FAILED
);

74 
	gex™
;

76 ià(
	g$logšResuÉ
 === "platform_not_bind")

78 
echo
 
g’_»¥Ú£
(
PLATFORM_NOT_BIND
);

79 
	gex™
;

82 
	g$j£ssiÚid
 = 
$logšResuÉ
;

83 
	g$v”ifyP¬ams
 = 
¬¿y
(

84 "¶©fÜm"=>
$¶©fÜm
,

85 "coupÚId"=>
$coupÚId
);

86 ià(
	g$¶©fÜm
 === "juhuasuan")

88 
$v”ifyP¬ams
['j£ssiÚid'] = 
$j£ssiÚid
;

89 
	g$v”ifyP¬ams
['cÚsumeCouÁ'] = 
$cÚsumeTimes
;

90 
	g$v”ifyP¬ams
['‹rmš®Id']=
$‹rmš®Id
;

92 
	g$»¥Ú£Code
 = 
doV”ifyCoupÚ
(
$v”ifyP¬ams
);

94 ià(
	g$»¥Ú£Code
 ==ğ
V”ifyCoupÚCodeMsg
::
VERIFY_COUPON_SUCCESS
)

96 
$‹lRe¥Ú£Code
 = 
COUPON_CONSUME_OK
;

98 
	g$»cÜdP¬ams
 = 
¬¿y
(

99 "coupÚId" => 
$coupÚId
,

100 "¶©fÜm" => 
$¶©fÜm
,

101 "cÚsumed_times" => 
$cÚsumeTimes
,

102 "·¹ÃrId" => 
$·¹ÃrId
,

103 "j£ssiÚid" => 
$j£ssiÚid
);

104 
»cÜd_cÚsumed_coupÚ
(
$»cÜdP¬ams
);

107 
	g$‹lRe¥Ú£Code
 = 
COUPON_CONSUME_FAILED
;

109 
echo
 
g’_»¥Ú£
(
$‹lRe¥Ú£Code
);

110 
	gex™
;

112 
–£if
 (
$aùiÚ
 === 'check-partner')

114 
$mysql
->
£t_bËÇme
('partner_bind');

115 
	g$cÚd™iÚs
 = 
¬¿y
("phÚ’um"=>
$ÿÎ”id
, "status"=>'bind');

116 
	g$»suÉ
 = 
$mysql
->
g‘_row
(
$cÚd™iÚs
);

117 ià(
	g$»suÉ
) {

119 
echo
 
g’_»¥Ú£
(
PARTNER_BINDED
);

122 
echo
 
g’_»¥Ú£
(
PARTNER_NOT_BIND
);

124 
	gex™
;

126 
–£if
 (
$aùiÚ
 === 'bind-partner')

128 
$acù
 = 
add¦ashes
(
Œim
(
$_REQUEST
['acct']));

130 
	g$mysql
->
£t_bËÇme
('partner');

131 
	g$cÚd
 = 
¬¿y
("·¹Ãr_acù"=>
$acù
);

132 
	g$»suÉ
 = 
$mysql
->
g‘_row
(
$cÚd
);

133 ià(!
	g$»suÉ
) {

134 
echo
 
g’_»¥Ú£
(
PARTNER_NOT_EXIST
);

137 
	g$mysql
->
£t_bËÇme
('partner_bind');

138 
	g$cÚd
 = 
¬¿y
("·¹Ãr_acù"=>
$acù
, 'phÚ’um'=>
$ÿÎ”id
);

139 
	g$checkResuÉ
 = 
$mysql
->
g‘_row
(
$cÚd
);

141 ià(
	g$checkResuÉ
)

143 
	g$bšdSql
 = "UPDATE ".
$mysql
->
g‘_dbTabËName
("partner_bind")." set status='bind' where…artner_acct='$acct'‡nd…honenum='$callerid'";

144 
	g$mysql
->
qu”y
(
$bšdSql
);

146 
	g$š£¹Sql
 = "INSERT INTO ".
$mysql
->
g‘_dbTabËName
("partner_bind")."(partner_acct,…honenum, status)";

147 
	g$š£¹Sql
 .= " VALUES('$acct','$callerid','bind')";

148 
	g$mysql
->
qu”y
(
$š£¹Sql
);

150 
echo
 
g’_»¥Ú£
(
PARTNER_BIND_OK
);

152 
	gex™
;

154 
–£if
 (
$aùiÚ
 === 'unbind-partner')

156 
$unbšdSql
 = "UPDATE ".
$mysql
->
g‘_dbTabËName
('partner_bind')." set status='unbind' where…honenum='$callerid'";

157 
	g$»suÉ
 = 
$mysql
->
qu”y
(
$unbšdSql
);

158 ià(
	g$»suÉ
)

159 
echo
 
g’_»¥Ú£
(
PARTNER_UNBIND_OK
);

161 
echo
 
g’_»¥Ú£
(
PARTNER_UNBIND_FAILED
);

165 
h—d”
("Content-Type:text/html; charset=utf-8");

166 
	gecho
 "éæ³•è®¿é—®";

167 
	gex™
;

	@index.php

1 <?
php


2 
»quœe_Úû
('common/checkAuthority.php');

4 
»dœeù
(
WEBROOT
.'/verifyCoupon/index.php');

	@module/Coupon.php

1 <?
php


11 
»quœe_Úû
('../common/class/MyTable.php');

12 
»quœe_Úû
('../common/Exception.php');

13 
»quœe_Úû
('../common/CodeMessages.php');

15 şas 
	cCoupÚ
 
ex‹nds
 
	mMyTabË


18 cÚ¡ 
	mCOUPON_TABLE
 = 'coupon';

19 cÚ¡ 
	mTEAM_TABLE
 = 'team';

20 cÚ¡ 
	mORDER_TABLE
 = 'order';

21 cÚ¡ 
	mUSER_TABLE
 = 'user';

29 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

31 
·»Á
::
	`__cÚ¡ruù
(
£lf
::
COUPON_TABLE
);

43 
public
 
funùiÚ
 
	$g‘_cÚsumedCoupÚs
(
$£¬chF›lds
, 
$¡¬t
, 
$off£t
)

45 
	`fÜ—ch
 (
$£¬chF›lds
 
as
 
$f›ldKey
 => 
$f›ldV®ue
)

47 
$$f›ldKey
 = 
	`is_¡ršg
(
$f›ldV®ue
)?
	`mysql_»®_esÿ³_¡ršg
($fieldValue): $fieldValue;

50 ià(
$¡¬t
 < 0) $start = 0;

51 ià(
$off£t
 <= 0) $offset = 6;

53 
$£Ëù
 = "select c.order_id‡s orderId,.title‡seamTitle, c.id‡s couponId,";

54 
$£Ëù
 .= "u.username‡s username, u.email‡sƒmail, o.subbranch‡s subbranch, c.consume_time‡s consumeTime,c.consume_times‡s consumeTimes,c.platform_coupon_id‡s…latformCouponId,c.consumer_mobile‡s consumerMobile";

55 
$£Ëù
 .ğ' from '.
£lf
::
DBDATABASE
.'.'.£lf::
TEAM_TABLE
.','.£lf::DBDATABASE.'.'.£lf::
ORDER_TABLE
.' o,';

56 
$£Ëù
 .ğ
£lf
::
DBDATABASE
.'.'.£lf::
COUPON_TABLE
.' c†eá još '.£lf::DBDATABASE.'.'.£lf::
USER_TABLE
.' u on c.user_id=u.id';

57 
$sql
 = 
$£Ëù
." WHERE c.consume='Y' ";

58 ià(
	`couÁ
(
£¬chF–ds
) > 0)

60 ià(
$·¹ÃrId
 > 0)

61 
$sql
 .= " AND c.partner_id=$partnerId";

62 ià(
$‹amId
 > 0)

63 
$sql
 .= " AND c.team_id=$teamId ";

64 ià(!
	`em±y
(
$¶©fÜm
))

65 
$sql
 .= " AND c.platform_key='$platform'";

66 ià(
$Üd”Id
 > 0)

67 
$sql
 .= " AND c.order_id=$orderId";

68 ià(
$coupÚId
 > 0)

69 
$sql
 .= " AND c.platform_coupon_id=$couponId";

70 ià(!
	`em±y
(
$mobe
))

71 
$sql
 .= " AND c.consumer_mobile='$mobile'";

73 
$sql
 .= " AND.id=c.team_id AND o.id=c.order_id ";

75 
$sql
 .= " order by c.consume_time desc";

76 
$sql
 .= " LIMIT $start,$offset";

78 
$»suÉ
 = 
	`mysql_qu”y
(
$sql
);

79 ià(
	`mysql_num_rows
(
$»suÉ
) < 1)

80  
	`¬¿y
();

82  
$this
->
	`·r£_coupÚLi¡
(
$»suÉ
);

83 
	}
}

92 
public
 
funùiÚ
 
	$g‘_cÚsumedCoupÚNums
(
$£¬chF›lds
)

94 
$this
->
	`assu»_dbCÚÃùiÚ
();

95 
	`fÜ—ch
 (
$£¬chF›lds
 
as
 
$f›ldKey
 => 
$f›ldV®ue
)

97 
$$f›ldKey
 = 
	`is_¡ršg
(
$f›ldV®ue
)?
	`mysql_»®_esÿ³_¡ršg
($fieldValue): $fieldValue;

100 
$sql
 = "SELECT couÁ(*èa coupÚNum FROM ".
$this
->
	`g‘_dbTabËName
(
£lf
::
COUPON_TABLE
).'‡s c,';

101 
$sql
 .ğ
$this
->
	`g‘_dbTabËName
(
£lf
::
USER_TABLE
).'‡s u';

102 
$sql
 .= " WHERE consume='Y'";

104 ià(
	`couÁ
(
$£¬chF›lds
) > 0)

106 
$sql
 .ğ
$·¹ÃrId
>0 ? " AND c.partner_id=".$partnerId : "";

107 
$sql
 .ğ!
	`em±y
(
$¶©fÜm
)? " AND c.platform_key='$platform'" : "";

108 
$sql
 .ğ
$‹amId
>0 ? " AND c.team_id=".$teamId : "";

109 
$sql
 .ğ
$Üd”Id
>0 ? " AND c.order_id=".$orderId : "";

110 
$sql
 .ğ
$coupÚId
>0 ? " AND c.platform_coupon_id=".$couponId : "";

111 
$sql
 .ğ!
	`em±y
(
$mobe
) ? " AND c.mobile='$mobile'" : "";

114 
$coupÚNums
 = 0;

115 
$»suÉ
 = 
	`mysql_qu”y
(
$sql
);

116 ià(
	`is_»sourû
(
$»suÉ
è&& 
	`mysql_num_rows
($result) > 0)

118 
$couÁRow
 = 
	`mysql_ãtch_¬¿y
(
$»suÉ
);

119 
$coupÚNums
 = 
$couÁRow
['couponNums'];

122  
$coupÚNums
;

123 
	}
}

131 
public
 
funùiÚ
 
	$cÚsume_coupÚ
(
$coupÚId
, 
$cÚsumed_times
 = 1)

133 ià(
$coupÚId
 <ğ0 || !
	`is_num”ic
(
$cÚsumed_times
) || $consumed_times < 1)

135 
throw
 
Ãw
 
	`V”ifyCoupÚ_Exû±iÚ
(

136 
CommÚCodeMsg
::
	`g‘_mes§ge
(CommÚCodeMsg::
INVALID_ARGUMENT_ERROR
),

137 
CommÚCodeMsg
::
INVALID_ARGUMENT_ERROR
);

140 
$upd©e
 = 'UPDATE '.
$this
->
	`g‘_dbTabËName
(
£lf
::
COUPON_TABLE
);

141 
$upd©e
 .ğ" s‘ cÚsume='Y',cÚsume_time=UNIX_TIMESTAMP(),cÚsume_times=cÚsume_times+".
$cÚsumed_times
;

142 
$wh”e
 = " WHERE id=".
$coupÚId
;

143 
$sql
 = 
$upd©e
.
$wh”e
;

145  
	`mysql_qu”y
(
$sql
);

146 
	}
}

154 
´iv©e
 
funùiÚ
 
	$·r£_coupÚLi¡
(
$»suÉ
)

156 
$cÚsumedCoupÚLi¡
 = 
	`¬¿y
();

157 
$coupÚNums
 = 
	`mysql_num_rows
(
$»suÉ
);

158 ià(
$coupÚNums
 > 0)

160 
$cÚsumedCoupÚ
 = 
	`mysql_ãtch_¬¿y
(
$»suÉ
))

162 
	`¬¿y_push
(
$cÚsumedCoupÚLi¡
, 
$cÚsumedCoupÚ
);

165  
$cÚsumedCoupÚLi¡
;

166 
	}
}

175 
public
 
funùiÚ
 
	$š£¹_coupÚ
(
$coupÚInfo
)

177 
$this
->
	`assu»_dbCÚÃùiÚ
();

178 
$š£¹Sql
 = "INSERT INTO ".
$this
->
	`g‘_dbTabËName
(
£lf
::
COUPON_TABLE
);

179 
$keys
 = "(";

180 
$v®ues
 = " VALUES(";

181 
	`fÜ—ch
(
$coupÚInfo
 
as
 
$key
 => 
$v®ue
)

183 
$keys
 .ğ
$key
 . ",";

185 ià(
	`is_¡ršg
(
$v®ues
))

187 
$v®ues
 .ğ"'" . 
$v®ue
 . "'" . ",";

191 
$v®ues
 .ğ
$v®ue
. ",";

196 
$keys
 = 
	`sub¡r
($keys, 0, -1) . ")";

197 
$v®ues
 = 
	`sub¡r
($values, 0, -1) . ")";

199 
$š£¹Sql
 .ğ
$keys
 . 
$v®ues
;

200 
$»suÉ
 = 
	`mysql_qu”y
(
$š£¹Sql
);

201 ià(!
$»suÉ
) {

202  
nuÎ
;

204 
$š£¹edcoupÚId
 = 
	`mysql_š£¹_id
();

205 
$coupÚInfo
['id'] = 
$š£¹edcoupÚId
;

207  
$coupÚInfo
;

208 
	}
}

	@module/Order.php

1 <?
php


11 
»quœe_Úû
('../common/class/MyTable.php');

12 
»quœe_Úû
('../common/Exception.php');

13 
»quœe_Úû
('../common/CodeMessages.php');

15 şas 
	cOrd”
 
ex‹nds
 
	mMyTabË


18 cÚ¡ 
	mCOUPON_TABLE
 = 'coupon';

19 cÚ¡ 
	mTEAM_TABLE
 = 'team';

20 cÚ¡ 
	mORDER_TABLE
 = 'order';

21 cÚ¡ 
	mUSER_TABLE
 = 'user';

29 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

31 
·»Á
::
	`__cÚ¡ruù
(
£lf
::
ORDER_TABLE
);

41 
public
 
funùiÚ
 
	$š£¹_Üd”
(
$Üd”Info
)

43 
$this
->
	`assu»_dbCÚÃùiÚ
();

44 
$š£¹Sql
 = "INSERT INTO ".
$this
->
	`g‘_dbTabËName
(
£lf
::
ORDER_TABLE
);

45 
$keys
 = "(";

46 
$v®ues
 = " VALUES(";

47 
	`fÜ—ch
(
$Üd”Info
 
as
 
$key
 => 
$v®ue
)

49 
$keys
 .ğ
$key
 . ",";

51 ià(
	`is_¡ršg
(
$v®ues
))

53 
$v®ues
 .ğ"'" . 
$v®ue
 . "'" . ",";

57 
$v®ues
 .ğ
$v®ue
. ",";

63 
$keys
 = 
	`sub¡r
($keys, 0, -1) . ")";

64 
$v®ues
 = 
	`sub¡r
($values, 0, -1) . ")";

66 
$š£¹Sql
 .ğ
$keys
 . 
$v®ues
;

67 
$»suÉ
 = 
	`mysql_qu”y
(
$š£¹Sql
);

68 ià(!
$»suÉ
) {

69  
nuÎ
;

71 
$š£¹edOrd”Id
 = 
	`mysql_š£¹_id
();

72 
$Üd”Info
['id'] = 
$š£¹edOrd”Id
;

74  
$Üd”Info
;

75 
	}
}

	@module/Partner.php

1 <?
php


11 
»quœe_Úû
('../common/Exception.php');

12 
»quœe_Úû
('../common/class/MyTable.php');

13 
»quœe_Úû
('../common/common.php');

15 şas 
	cP¬Š”
 
ex‹nds
 
	mMyTabË


18 cÚ¡ 
	mPARTNER_TABLE
 = 'partner';

23 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

25 
·»Á
::
	`__cÚ¡ruù
();

35 
public
 
funùiÚ
 
	$chªgePass
(
$·¹ÃrId
, 
$ÜigšPasswd
, 
$ÃwPasswd
)

37 
$this
->
	`assu»_dbCÚÃùiÚ
();

38 
$ÜigšPasswd
 = 
	`mysql_»®_esÿ³_¡ršg
($originPasswd);

39 
$ÃwPasswd
 = 
	`mysql_»®_esÿ³_¡ršg
($newPasswd);

40 ià(
	`¡¾’
(
$ÃwPasswd
) < 6 || strlen($newPasswd) > 16)

42 
throw
 
Ãw
 
	`Exû±iÚ
(

43 
ChªgePassCodeMsg
::
	`g‘_mes§ge
(ChªgePassCodeMsg::
NEW_PASS_NOT_ALLOWED_ERROR
),

44 
ChªgePassCodeMsg
::
NEW_PASS_NOT_ALLOWED_ERROR
);

46 ià(!
	`em±y
(
$ÜigšPasswd
))

48 
$ÜigšPasswd
 = 
	`üy±_·ss
($originPasswd);

49 
$£ËùSql
 = "SELECT * FROM ".
$this
->
	`g‘_dbTabËName
(
£lf
::
PARTNER_TABLE
)." WHERE id=".
$·¹ÃrId
.

50 " AND…asswÜd='".
$ÜigšPasswd
."'";

51 
$»suÉ
 = 
	`mysql_qu”y
(
$£ËùSql
);

52 ià(
$»suÉ
 && 
	`mysql_num_rows
($result) == 1)

54 
$upd©eSql
 = "UPDATE ".
$this
->
	`g‘_dbTabËName
(
£lf
::
PARTNER_TABLE
)." SET";

55 
$upd©eSql
 .ğ"…asswÜd='".
	`üy±_·ss
(
$ÃwPasswd
)."'"." WHERE id=".
$·¹ÃrId
;

56  
	`mysql_qu”y
(
$upd©eSql
)? 
LQ_OK
: 
LQ_FAIL
;

60 
throw
 
Ãw
 
	`Exû±iÚ
(

61 
ChªgePassCodeMsg
::
	`g‘_mes§ge
(ChªgePassCodeMsg::
ORIGIN_PASS_NOT_MATCH
),

62 
ChªgePassCodeMsg
::
ORIGIN_PASS_NOT_MATCH
);

63 
	}
}

	@module/PartnerPlatforms.php

1 <?
php


11 
»quœe_Úû
('../common/Exception.php');

12 
»quœe_Úû
('../common/class/MyTable.php');

13 
»quœe_Úû
('../common/common.php');

15 şas 
	cP¬Š”PÏtfÜms
 
ex‹nds
 
	mMyTabË


18 cÚ¡ 
	mPARTNET_PLATFORMS_TABLE
 = 'partner_platforms';

23 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

25 
·»Á
::
	`__cÚ¡ruù
(
£lf
::
PARTNET_PLATFORMS_TABLE
);

28 
	}
}

	@module/Team.php

1 <?
php


11 
»quœe_Úû
('../common/class/MyTable.php');

13 şas 
	cT—m
 
ex‹nds
 
	mMyTabË


16 cÚ¡ 
	mTEAM_TABLE
 = 'team';

17 cÚ¡ 
	mPLATFORM_TABLE
 = 'platform';

25 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

27 
·»Á
::
	`__cÚ¡ruù
(
£lf
::
TEAM_TABLE
);

36 
public
 
funùiÚ
 
	$g‘_‹ams
(
$£¬chF›lds
, 
$¡¬t
, 
$off£t
)

38 
	`fÜ—ch
 (
$£¬chF›lds
 
as
 
$f›ldKey
 => 
$f›ldV®ue
)

40 
$$f›ldKey
 = 
	`is_¡ršg
(
$f›ldV®ue
)?
	`mysql_»®_esÿ³_¡ršg
($fieldValue): $fieldValue;

43 ià(
$·¹ÃrId
 <= 0)

45 
throw
 
Ãw
 
	`Exû±iÚ
(

46 
CommÚCodeMsg
::
	`g‘_mes§ge
(CommÚCodeMsg::
INVALID_ARGUMENT_ERROR
),

47 
CommÚCodeMsg
::
INVALID_ARGUEMENT
);

49 ià(
$¡¬t
 < 0) $start = 0;

50 ià(
$off£t
 <= 0) $offset = 4;

52 
$£Ëù
 = "select.id‡seamId,.title‡seamTitle,….title‡s…latformTitle,.begin_time‡s beginTime,";

53 
$£Ëù
 .= "t.end_time‡sƒndTime,.now_num‡s‚owNum,.min_num‡s minNum,.team_price‡seamPrice,";

54 
$£Ëù
 .= "t.market_price‡s marketPrice,.platform_key‡s…latformKey,";

55 
$£Ëù
 .= "t.expire_time‡sƒxpireTime,.state";

56 
$£Ëù
 .ğ' from '.
£lf
::
DBDATABASE
.'.'.£lf::
TEAM_TABLE
.','.£lf::DBDATABASE.'.'.£lf::
PLATFORM_TABLE
.'…';

57 
$sql
 = 
$£Ëù
." WHERE.partner_id=$partnerId AND.platform_key=p.key ";

58 
$sql
 .= "order by.state desc,t.expire_time desc,t.id desc ";

59 
$sql
 .= "LIMIT $start,$offset ";

61 
$»suÉ
 = 
	`mysql_qu”y
(
$sql
);

62 ià(
	`mysql_num_rows
(
$»suÉ
) < 1)

63  
	`¬¿y
();

65  
$this
->
	`·r£_‹amLi¡
(
$»suÉ
);

66 
	}
}

75 
public
 
funùiÚ
 
	$g‘_‹amNums
(
$£¬chF›lds
)

77 
$this
->
	`assu»_dbCÚÃùiÚ
();

78 
	`fÜ—ch
 (
$£¬chF›lds
 
as
 
$f›ldKey
 => 
$f›ldV®ue
)

80 
$$f›ldKey
 = 
	`is_¡ršg
(
$f›ldV®ue
)?
	`mysql_»®_esÿ³_¡ršg
($fieldValue): $fieldValue;

83 
$sql
 = "SELECT couÁ(*èa ‹amNum FROM ".
$this
->
	`g‘_dbTabËName
(
£lf
::
TEAM_TABLE
);

84 
$sql
 .= " WHERE…artner_id=$partnerId";

86 
$‹amNums
 = 0;

87 
$»suÉ
 = 
	`mysql_qu”y
(
$sql
);

88 ià(
	`is_»sourû
(
$»suÉ
è&& 
	`mysql_num_rows
($result) > 0)

90 
$‹amRow
 = 
	`mysql_ãtch_¬¿y
(
$»suÉ
);

91 
$‹amNums
 = 
$‹amRow
['teamNums'];

94  
$‹amNums
;

95 
	}
}

103 
´iv©e
 
funùiÚ
 
	$·r£_‹amLi¡
(
$»suÉ
)

105 
$‹amLi¡
 = 
	`¬¿y
();

106 
$‹amNums
 = 
	`mysql_num_rows
(
$»suÉ
);

107 ià(
$‹amNums
 > 0)

109 
$‹am
ğ
	`mysql_ãtch_¬¿y
(
$»suÉ
))

111 
	`¬¿y_push
(
$‹amLi¡
, 
$‹am
);

114  
$‹amLi¡
;

115 
	}
}

117 
public
 
funùiÚ
 
	$š£¹_‹am
(
$‹amInfo
)

119 
$this
->
	`assu»_dbCÚÃùiÚ
();

120 
$š£¹Sql
 = "INSERT INTO ".
$this
->
	`g‘_dbTabËName
(
£lf
::
TEAM_TABLE
);

121 
$keys
 = "(";

122 
$v®ues
 = " VALUES(";

123 
	`fÜ—ch
(
$‹amInfo
 
as
 
$key
 => 
$v®ue
)

125 
$keys
 .ğ
$key
 . ",";

127 ià(
	`is_¡ršg
(
$v®ues
))

129 
$v®ues
 .ğ"'" . 
$v®ue
 . "'" . ",";

133 
$v®ues
 .ğ
$v®ue
. ",";

137 
$keys
 = 
	`sub¡r
($keys, 0, -1) . ")";

138 
$v®ues
 = 
	`sub¡r
($values, 0, -1) . ")";

140 
$š£¹Sql
 .ğ
$keys
 . 
$v®ues
;

141 
$»suÉ
 = 
	`mysql_qu”y
(
$š£¹Sql
);

142 ià(!
$»suÉ
) {

143  
nuÎ
;

145 
$š£¹T—mId
 = 
	`mysql_š£¹_id
();

146 
$‹amInfo
['id'] = 
$š£¹T—mId
;

148  
$‹amInfo
;

149 
	}
}

	@old_trial/CommonDefine.php

1 <?
php


2 
defše
('PLATFORM_360BUY', 0);

3 
defše
('VERITY_TYPE_COUPON_PASSWD', 0);

4 
defše
('FILE_NAME_GROUP_DIR_LIST', 'groupon_apis_list.conf');

5 
defše
('REQUEST_METHOD', 'REST');

6 
defše
('RESPONSE_TYPE', 'XML');

	@old_trial/VerifyCoupon.php

1 <?
php


2 
»quœe_Úû
("CommonDefine.php");

3 
»quœe_Úû
("VerifyFunction_def.php");

5 
	g$»suÉ
 = 
v”ify_coupÚ
(
$_REQUEST
);

6 ià(
	g$»suÉ
 =ğ
çl£
)

7 
echo
 'å‘é€éªŒè¯è¯·æ±‚å¤±è´¥!';

9 
echo
 
	g$»suÉ
;

	@old_trial/VerifyCoupon_laiqu.php

1 <?
php


2 
	g$u¾
 = "http://www.laiquwang.com/api/verify.php?".

3 "b¬code=".
$CoupÚId
;

5 
	g$»suÉ
 = @
fe_g‘_cÚ‹Á
(
$u¾
);

6 ià(!
	g$»suÉ
)

8 
	g$»suÉ
 = @
fe_g‘_cÚ‹Á
(
$u¾
);

9 ià(!
	g$»suÉ
)

10 
d›
('æ¥å£è°ƒç”¨å¤±è´¥!');

13 
funùiÚ
 
	$·r£_ÏiquResuÉ
(
$»suÉ
)

16 
	}
}

	@old_trial/VerifyFunction_def.php

1 <?
php


2 
funùiÚ
 
	$v”ify_coupÚ
(
$v”ifyD©a
)

4 
$iPÏtfÜm
 = 
$v”ifyD©a
["platform"];

5 
$aGroupÚDœLi¡
 = 
	`decode_cÚfFeIÁoA¼ay
('./groupÚ_­is_cÚfs/'.
FILE_NAME_GROUP_DIR_LIST
);

7 
$¡rV”ifyCoupÚReque¡Xml
 = "";

8 
$¡rV”ifyCoupÚReque¡CÚf
 = "";

9 
$¡rV”ifyCoupÚRe¥Ú£CÚf
 = "";

11 
	`š™_cÚfP©hs
(
$iPÏtfÜm
,

12 
$aGroupÚDœLi¡
,

13 &
$¡rV”ifyCoupÚReque¡Xml
,

14 &
$¡rV”ifyCoupÚReque¡CÚf
,

15 &
$¡rV”ifyCoupÚRe¥Ú£CÚf
);

17 
$v”ifyResuÉ
 = 
	`£nd_v”ifyReque¡
(
$v”ifyD©a
,

18 
$¡rV”ifyCoupÚReque¡Xml
,

19 
$¡rV”ifyCoupÚReque¡CÚf
);

20  
$v”ifyResuÉ
;

21 
	}
}

23 
funùiÚ
 
	$decode_cÚfFeIÁoA¼ay
(
$feName
)

26 
$aCÚ‹Á
 = 
	`fe_g‘_cÚ‹Ás
(
$feName
);

27  
	`jsÚ_decode
(
$aCÚ‹Á
, 
Œue
);

28 
	}
}

30 
funùiÚ
 
	$š™_cÚfP©hs
(

31 
$iPÏtfÜm
,

32 
$aGroupÚDœLi¡
,

33 
$¡rV”ifyCoupÚReque¡Xml
,

34 
$¡rV”ifyCoupÚReque¡CÚf
,

35 
$¡rV”ifyCoupÚRe¥Ú£CÚf
 )

38 
$roÙDœ
 = './groupÚ_­is_cÚfs/' . 
$aGroupÚDœLi¡
[
$iPÏtfÜm
];

40 
$¡rV”ifyCoupÚReque¡Xml
 = 
$roÙDœ
 . '/apis/verifyCouponRequest.xml';

41 
$¡rV”ifyCoupÚReque¡CÚf
 = 
$roÙDœ
 . '/confs/verifyCouponRequest.conf';

42 
$¡rV”ifyCoupÚRe¥Ú£CÚf
 = 
$roÙDœ
 . '/confs/verifyCouponResponse.conf';

43 
	}
}

45 
funùiÚ
 
	$£nd_v”ifyReque¡
(

46 
$aV”ifyD©a
,

47 
$¡rV”ifyCoupÚReque¡Xml
,

48 
$¡rV”ifyCoupÚReque¡CÚf
)

50 
$aReque¡IÅuts
 = 
	`decode_cÚfFeIÁoA¼ay
(
$¡rV”ifyCoupÚReque¡CÚf
);

51 
$xml
 = @
	`sim¶exml_lßd_fe
(
$¡rV”ifyCoupÚReque¡Xml
);

52 ià(!
$xml
)

54 
$xml
 = @
	`sim¶exml_lßd_fe
(
$¡rV”ifyCoupÚReque¡Xml
);

55 ià(!
$xml
)

56  
çl£
;

59 
	`fÜ—ch
(
$aReque¡IÅuts
 
as
 
$šput
)

63 
echo
 
$aV”ifyD©a
[
$šput
];

64 
$xml
->
CoupÚId
[0]->
node_v®ue
 = 
$aV”ifyD©a
[
$šput
];

71 
echo
 
$xml
->
	`asXML
();

73 
	}
}

	@old_trial/soapAndRest_sp.php

1 <?
php


8 
funùiÚ
 
	$brow£NodeS—rch
(
$brow£Node
, 
$·ge
, 
$mode
) {

9 
$this
->
S”viû
 = "AWSECommerceService";

10 
$this
->
O³¿tiÚ
 = "I‹mS—rch"; $this->
AWSAcûssKeyId
 = 
DEVTAG
;

11 
$this
->
AssocŸ‹Tag
 = 
ASSOCIATEID
;

12 
$this
->
Brow£Node
 = 
$brow£Node
; $this->
Re¥Ú£Group
 = "Large";

13 
$this
->
S—rchIndex
ğ
$mode
;

14 
$this
->
SÜt
= "salesrank";

15 
$this
->
TÙ®Pages
ğ
$·ge
;

16 if(
METHOD
=='SOAP') {

17 
$sßpş›Á
 = 
Ãw
 
	`nusßp_ş›Á
( 'http://ecs.amazonaws.com/AWSECommerceService/AWSECommerceService.wsdl', 'wsdl');

19 
$sßp_´oxy
 = 
$sßpş›Á
->
	`g‘Proxy
();

21 
$»que¡
 = 
	`¬¿y
 ('S”viû' => 
$this
->
S”viû
,

22 'O³¿tiÚ' => 
$this
->
O³¿tiÚ
, 'Brow£Node' => $this->
Brow£Node
,

23 'Re¥Ú£Group' => 
$this
->
Re¥Ú£Group
, 'S—rchIndex' => $this->
S—rchIndex
,

24 'SÜt' => 
$this
->
SÜt
, 'TÙ®Pages' => $this->
TÙ®Pages
);

26 
$·¿m‘”s
 = 
	`¬¿y
('AWSAcûssKeyId' => 
DEVTAG
, 'AssocŸ‹Tag' => 
ASSOCIATEID
, 'Reque¡'=>¬¿y(
$»que¡
));

29 
$»suÉ
 = 
$sßp_´oxy
->
	`I‹mS—rch
(
$·¿m‘”s
);

30 if(
	`isSOAPE¼Ü
(
jjkjkkjjhhkkjkjjkdd
@
aj
@aj@
aj$»suÉ
)) {

31  
çl£
;

33 
$this
->
tÙ®ResuÉs
 = 
$»suÉ
['TotalResults'];

34 
	`fÜ—ch
(
$»suÉ
['I‹ms']['I‹m'] 
as
 
$´oduù
) {

35 
$this
->
´oduùs
[] = 
Ãw
 
	`Produù
(
$´oduù
);

37 
	`un£t
(
$sßpş›Á
);

38 
	`un£t
(
$sßp_´oxy
);

41 ï¿¼
$this
->
u¾
 = "h‰p://ecs.amazÚaws.com/Úÿ/xml?". "S”viû=".$this->
S”viû
. "&O³¿tiÚ=".$this->
O³¿tiÚ
. "&AssocŸ‹Tag=".$this->
AssocŸ‹Tag
. "&AWSAcûssKeyId=".$this->
AWSAcûssKeyId
. "&Brow£Node=".$this->
Brow£Node
. "&Re¥Ú£Group=".$this->
Re¥Ú£Group
.

42 "&S—rchIndex=".
$this
->
S—rchIndex
. "&SÜt=".$this->
SÜt
. "&TÙ®Pages=".$this->
TÙ®Pages
;

43 
$this
->
	`·r£XML
();

45  
$this
->
´oduùs
;

46 
	}
}

49 
funùiÚ
 
	$·r£XML
()

52 
$xml
 = @
	`sim¶exml_lßd_fe
(
$this
->
u¾
);

53 if(!
$xml
) {

55 
$xml
 = @
	`sim¶exml_lßd_fe
(
$this
->
u¾
);

56 if(!
$xml
)

58  
çl£
;

61 
$this
->
tÙ®ResuÉs
 = (
š‹g”
)
$xml
->
TÙ®ResuÉs
;

62 
	`fÜ—ch
(
$xml
->
I‹ms
->
I‹m
 
as
 
$´oduùXML
) {

63 
$this
->
´oduùs
[] = 
Ãw
 
	`Produù
(
$´oduùXML
);

66 
	}
}

	@old_trial/test_360buyRest.php

1 <?
php


2 
	g»quœe_Úû
 'RESTclient.php';

3 
defše
('METHOD', 'GET');

5 
	g$»¡
 = 
Ãw
 
RESTş›Á
();

7 
	g$šputs
 = 
¬¿y
();

13 
	g$u¾Addr
 = 'http://api.douban.com/book/subject/1220562?apikey=01ba41401a376797052ec3c04ea636c5';

14 ià(
	gMETHOD
 == 'POST') {

15 
$»¡
->
ü—‹Reque¡
("$u¾Addr", "POST", 
$šputs
);

17 
	g$»¡
->
ü—‹Reque¡
(
$u¾Addr
);

18 
	g$u¾
 = 
$»¡
->
g‘U¾
();

19 
	g$u¾
->
£tQu”yV¬ŸbËs
(
$šputs
);

21 
	g$»¡
->
£ndReque¡
();

22 
	g$ouut
 = 
$»¡
->
g‘Re¥Ú£
();

24 
	g$xml
 = 
sim¶exml_lßd_¡ršg
(
$ouut
);

25 
echo
 
	g$xml
->
	gt™Ë
;

	@old_trial/test_RestClient.php

1 <?
php


2 
	g»quœe_Úû
 'RESTclient.php';

4 
	g$¶©fÜm
 = 'laiqu';

5 
	g$rg‘Api
 = 'verifyCoupon';

8 
	g$m‘hod
 = '';

9 
	g$»que¡M‘hod
 = '';

10 
	g$»que¡Ty³
 = '';

11 
	g$­iU¾
 = "";

12 
	g$»que¡P¬ams
 = 
nuÎ
;

13 
	g$»que¡P¬amsStic
 = 
nuÎ
;

14 
	g$»suÉTag
 = 
nuÎ
;

15 
	g$codeSucûss
 = 200;

17 
·r£_¶©fÜm_cÚfs
(
$¶©fÜm
);

19 
	g$»¡
 = 
Ãw
 
RESTş›Á
();

21 
	g$šputs
['couponId'] = '24902218';

22 
	g$·¿ms
 = 
g‘_»que¡P¬ams
(
$šputs
);

24 ià(
	g$»que¡M‘hod
 == 'POST') {

25 
$»¡
->
ü—‹Reque¡
(
$­iU¾
, "POST", 
$·¿ms
);

27 
	g$»¡
->
ü—‹Reque¡
(
$­iU¾
);

28 
	g$u¾
 = 
$»¡
->
g‘U¾
();

29 
	g$u¾
->
£tQu”yV¬ŸbËs
(
$·¿ms
);

31 
	g$»¡
->
£ndReque¡
();

32 
	g$»¥Ú£
 = 
$»¡
->
g‘Re¥Ú£
();

33 
	g$»suÉ
 = 
·r£_¶©fÜm_»¥Ú£
(
$»¥Ú£
, 
$m‘hod
, 
$»que¡Ty³
, 
$»suÉTag
, 
$codeSucûss
);

35 ià(!
	g$»suÉ
)

36 
	gecho
 'call‡pi failed!';

38 
echo
 
	g$»suÉ
;

40 <?
php


41 
funùiÚ
 
	$·r£_¶©fÜm_»¥Ú£
(
$»¥Ú£
, 
$m‘hod
, 
$»que¡Ty³
, 
$»suÉTag
, 
$codeSucûss
)

43 ià(
$m‘hod
 != 'REST')

44 
	`d›
('ç›®å‰åªæ”¯æŒRESTfulæ¥å£çš„å¹³å°!');

45 ià(
$»que¡Ty³
 == 'LAIQU')

47 
$»suÉ
 = 
	`g‘_»¥Ú£Code_Ïiqu
(
$»¥Ú£
, 
$»suÉTag
, 
$codeSucûss
);

49  
$»suÉ
;

50 
	}
}

52 
funùiÚ
 
	$g‘_»¥Ú£Code_Ïiqu
(
$»¥Ú£
, 
$»suÉTag
, 
$codeSucûss
)

54 
	`´eg_m©ch_®l
("/(<([\w]+)[^>]*>)(.*?)(<\/\\2>)/", 
$»¥Ú£
, 
$m©ches
, 
PREG_SET_ORDER
);

55 
	`fÜ—ch
 (
$m©ches
 
as
 
$v®
) {

56 ià(
$v®
[2] =ğ
$»suÉTag
)

58  
$v®
[3] =ğ
$codeSucûss
 ? 'éªŒè¯æˆåŠŸ!':'éªŒè¯å¤±è´¥';

61  
çl£
;

62 
	}
}

64 
funùiÚ
 
	$·r£_¶©fÜm_cÚfs
(
$¶©fÜm
)

66 
glob®
 
$m‘hod
;

67 
glob®
 
$»que¡M‘hod
;

68 
glob®
 
$»que¡Ty³
;

69 
glob®
 
$­iU¾
;

70 
glob®
 
$»que¡P¬ams
;

71 
glob®
 
$»que¡P¬amsStic
;

72 
glob®
 
$»suÉTag
;

73 
glob®
 
$codeSucûss
;

75 
$cÚfigFeName
 = "¶©fÜm_­i_cÚfs/" . 
$¶©fÜm
 . ".conf";

76 
$cÚ‹Á
 = 
	`fe_g‘_cÚ‹Ás
(
$cÚfigFeName
);

77 
$cÚfigs
 = 
	`jsÚ_decode
(
$cÚ‹Á
);

78 
	`fÜ—ch
 (
$cÚfigs
 
as
 
$key
 => 
$v®ue
)

80 
glob®
 
$$key
;

81 
$$key
 = 
$v®ue
;

83 
$­iU¾
 = 
$$rg‘Api
->
­iU¾
;

84 
$»que¡P¬ams
 = 
$$rg‘Api
->
»que¡P¬ams
;

85 
$»que¡P¬amsStic
 = 
$$rg‘Api
->
»que¡P¬amsStic
;

86 
$»suÉTag
 = 
$$rg‘Api
->
»¥Ú£ResuÉ
->
»suÉTag
;

87 
$codeSucûss
 = 
$$rg‘Api
->
»¥Ú£ResuÉStic
->
codeSucûss
;

88 
	}
}

90 
funùiÚ
 
	$g‘_»que¡P¬ams
(
$šputs
)

92 
$·¿ms
 = 
	`¬¿y
();

93 
glob®
 
$»que¡P¬ams
;

94 
glob®
 
$»que¡P¬amsStic
;

95 
	`fÜ—ch
 (
$»que¡P¬ams
 
as
 
$key
 => 
$v®ue
)

98 
$·¿ms
[
$v®ue
] = 
$šputs
[
$key
];

100 ià(
$»¥Ú£ResuÉStic
)

103 
	`fÜ—ch
 (
$»que¡P¬amsStic
 
as
 
$key
 => 
$v®ue
)

105 
$·¿ms
[
$key
] = 
$v®ue
;

108  
$·¿ms
;

109 
	}
}

	@statistics/consumedCoupons.php

1 ï»¿<?
php


2 
»quœe_Úû
('../common/checkAuthority.php');

3 
»quœe_Úû
('../common/include/errorCatcher.php');

4 
»quœe_Úû
('../module/Coupon.php');

5 
»quœe_Úû
('../common/common.php');

7 
defše
("TABLE_ROW_NUMS", 6);

9 
	g$®lowPageShowNums
 = 6;

10 
	g$·¹ÃrId
 = 
$_SESSION
['partnerId'];

11 
	g$Üd”Id
 = 0;

14 if(
is£t
(
$_GET
['fromTeamPage']))

16 
	g$_SESSION
['äomT—mPage'] = 
$_GET
['fromTeamPage'];

18 
	g$äomT—mPage
 = 
is£t
(
$_SESSION
['fromTeamPage'])? $_SESSION['fromTeamPage'] : 1;

19 if(
is£t
(
$_GET
['teamId']))

21 
	g$_SESSION
['‹amId'] = 
$_GET
['teamId'];

23 
	g$‹amId
 = 
is£t
(
$_SESSION
['teamId'])? $_SESSION['teamId']: 0;

24 if(
is£t
(
$_GET
['platform']))

26 
	g$_SESSION
['¶©fÜm'] = 
$_GET
['platform'];

28 
	g$¶©fÜm
 = 
is£t
(
$_SESSION
['platform'])? $_SESSION['platform']: '';

30 
	g$Üd”Id
 = 
is£t
(
$_GET
['orderId'])? $_GET['orderId']: 0;

31 
	g$coupÚId
 = 
is£t
(
$_GET
['couponId'])? $_GET['couponId']: 0;

32 
	g$mobe
 = 
is£t
(
$_GET
['mobile'])? $_GET['mobile']: '';

34 
	g$·ge
 = 1;

35 ià(
is£t
(
$_GET
['·ge']è&& 
	g$_GET
['page'] > 0)

36 
	g$·ge
 = 
$_GET
['page'];

37 
	g$¡¬t
 = (
$·ge
-1)*
TABLE_ROW_NUMS
;

39 
	g$coupÚ
 = 
Ãw
 
CoupÚ
();

41 
	g$£¬chF›lds
 = 
¬¿y
(

42 '·¹ÃrId' => 
$·¹ÃrId
,

43 '‹amId' => 
$‹amId
,

44 '¶©fÜm' => 
$¶©fÜm
,

45 'Üd”Id' => 
$Üd”Id
,

46 'coupÚId' => 
$coupÚId
,

47 'mobe' => 
$mobe
);

48 
	g$coupÚLi¡
 = 
$coupÚ
->
g‘_cÚsumedCoupÚs
(
$£¬chF›lds
, 
$¡¬t
, 
TABLE_ROW_NUMS
);

49 
	g$coupÚTÙ®Nums
 = 
$coupÚ
->
g‘_cÚsumedCoupÚNums
(
$£¬chF›lds
);

50 
	g$tÙ®Pages
 = 
ÿl_tÙ®Pages
(
$coupÚTÙ®Nums
, 
TABLE_ROW_NUMS
);

53 <
html
 
	gxmÊs
="http://www.w3.org/1999/xhtml">

54 <
h—d
>

55 <
t™Ë
>éªŒè¯å¹³å°</title>

56 <
m‘a
 
h‰p
-
equiv
="CÚ‹Á-Ty³" 
cÚ‹Á
="text/html; charset=utf-8">

58 <
lšk
 
h»f
="../css/com_css.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

59 <
lšk
 
h»f
="css/coupÚ_css.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

60 <
süt
 
¤c
='../js/jquery.min.js'></script>

61 <
süt
 
¤c
='../js/common_funcs.js'></script>

62 <
süt
 
¤c
='js/consumedCoupon.js'></script>

63 </
h—d
>

64 <
body
>

67 <
div
 
şass
="maš" 
id
="main">

71 <
div
 
şass
="top_blank">

72 </
div
>

74 <
div
 
şass
="top">

75 <
img
 
¤c
="../images/logo.jpg" />

76 </
div
>

78 <
div
 
şass
="body">

80 <
div
 
şass
="body_l">

81 <
div
 
şass
="nav">

83 <?
php


84 
»quœe
 '../common/templates/left_nav_bar.php';

87 </
	gdiv
>

89 <
div
 
	gşass
="serv">

90 <
div
 
şass
="‹l" 
h»f
="javascript:void(0);"> </div>

91 <
a
 
şass
="online_qq"></a>

92 </
div
>

94 </
div
>

96 <
div
 
şass
="body_r fl">

97 <
p
 
şass
="t™Ë_r"
i
>><
a
 
h»f
="‹amLi¡.php" 
¡yË
="cŞÜ:#çad08;">é¡¹ç›®åˆ—è¡¨</a>&
nb¥
>å·²æ¶ˆè´¹åˆ¸åˆ—è¡¨</p>

99 <
div
 
şass
="title_line"></div>

101 <
div
 
şass
="search" >

102 <
a
 
şass
="back_‹xˆæ" 
h»f
="teamList.php?page=<?phpƒcho $fromTeamPage; ?>">è¿”å›</a>

103 <
p
 
şass
="search_text fl">è®¢å•å·</p>

104 <
šput
 
şass
="Üd”Id fl" 
Çme
="" 
id
="Üd”IdS—rch" 
v®ue
=""/>

106 <
p
 
şass
="search_text fl">åˆ¸å·</p>

107 <
šput
 
şass
="coupÚId fl" 
Çme
="" 
id
="coupÚIdS—rch" 
v®ue
=""/>

109 <
p
 
şass
="search_text fl">æ‰‹æœºå·</p>

110 <
šput
 
şass
="U£ºamæ" 
Çme
="" 
id
="mobeS—rch" 
v®ue
=""/>

112 <
a
 
şass
="£¬ch_bu‰Ú fl" 
ty³
="" 
v®ue
="" 
Çme
="" 
id
="£¬chCoupÚ" 
h»f
="javasüt:void(0);"><
img
 
¤c
="../images/search.jpg" /></a>

114 </
div
>

119 <
div
 
şass
="table">

120 <
div
 
şass
="table_title">

121 <
div
 
şass
="1 fl">

122 <
p
 
şass
="table_title_text">è®¢å•å·</p>

123 </
div
>

124 <
div
 
şass
="t2 fl">

125 <
p
 
şass
="table_title_text">é¡¹ç›®åç§°</p>

126 </
div
>

127 <
div
 
şass
="t3 fl">

128 <
p
 
şass
="table_title_text">åˆ¸å·</p>

129 </
div
>

130 <
div
 
şass
="t4 fl">

131 <
p
 
şass
="table_title_text">è´­ä¹°è€…æ‰‹æœºå·</p>

132 </
div
>

133 <
div
 
şass
="t1 fl">

134 <
p
 
şass
="table_title_text">é”€åˆ¸æ¬¡æ•°</p>

135 </
div
>

136 <
div
 
şass
="t5 fl">

137 <
p
 
şass
="table_title_text">æ¶ˆè´¹æ—¶é—´</p>

138 </
div
>

139 </
div
>

141 <?
php


142 
$htmlCoupÚLi¡
 = '';

143 
	g$i
=0; $˜< 
couÁ
(
$coupÚLi¡
); $i++)

145 
	g$cÚsumeCoupÚ
 = 
$coupÚLi¡
[
$i
];

146 ià(
	g$i
%2 == 0)

147 
$oddCÏss
 = " item_bg";

149 
	g$oddCÏss
 = "";

150 
	g$htmlCoupÚLi¡
 .= "<div class='table_item_1' id='couponRowWrap_{$i}'>

151 <
div
 
şass
='item1 fl$oddClass'>

152 <
a
 
şass
='bË_™em_‹xˆ'>{
$cÚsumeCoupÚ
['orderId']}</a>

153 </
div
>

154 <
div
 
şass
='item2 fl$oddClass'>

155 <
a
 
şass
='bË_™em_‹xt' >{
$cÚsumeCoupÚ
['teamTitle']}</a>

156 </
div
>

157 <
div
 
şass
='item3 fl$oddClass'>

158 <
a
 
şass
='bË_™em_‹xt' >{
$cÚsumeCoupÚ
['platformCouponId']}</a>

159 </
div
>

160 <
div
 
şass
='item4 fl$oddClass'>

161 <
a
 
şass
='bË_™em_‹xt' >{
$cÚsumeCoupÚ
['consumerMobile']}</a>

162 </
div
>

163 <
div
 
şass
='item1 fl$oddClass'>

164 <
a
 
şass
='bË_™em_‹xt' >{
$cÚsumeCoupÚ
['consumeTimes']}</a>

165 </
div
>

166 <
div
 
şass
='item6 fl$oddClass'>

167 <
a
 
şass
='table_item_text' >";

168 
$htmlCoupÚLi¡
 .ğ
d©e
('Y-m-d',
$cÚsumeCoupÚ
['consumeTime']).

169 "<b¸/>".
d©e
('h:i:s',
$cÚsumeCoupÚ
['consumeTime'])."</a> </div> </div>";

171 
echo
 
	g$htmlCoupÚLi¡
;

174 </
	gdiv
>

175 <
šput
 
	gty³
='hidd’' 
id
='·ge' <?
php
 
echo
 "v®ue=".
$·ge
; ?> />

176 <
šput
 
	gty³
='hidd’' 
id
='Üd”Id' <?
php
 ià(
$Üd”Id
 >0è
echo
 "value=".$orderId; ?> />

177 <
šput
 
	gty³
='hidd’' 
id
='coupÚId' <?
php
 ià(
$coupÚId
 >0è
echo
 "value=".$couponId; ?> />

178 <
šput
 
	gty³
='hidd’' 
id
='mobe' <?
php
 ià(
$mobe
 !==''è
echo
 "value='".$mobile."'"; ?> />

179 <
šput
 
	gty³
='hidd’' 
id
='cÚsumedCoupÚNums' <?
php
 
echo
 "v®ue=".
$cÚsumedCoupÚNums
; ?> />

181 <
div
 
	gşass
="page_turn">

182 <
a
 
şass
="tuº_‹xˆæ" 
h»f
="javasüt:void(0);" 
id
='goPrevPage'> ä¸Šä¸€é¡µ </a>

183 <
div
 
şass
="page fl">

184 <
p
 
şass
="tuº_‹xt" 
id
='·geG­'>&
nb¥


185 <?
php


186 
$showPageNums
 = 11;

187 
	g$u¾P»fix
 = "consumedCoupons.php?action=search";

188 ià(
	g$Üd”Id
 > 0è
	g$u¾P»fix
 .= "&orderId=$orderId";

189 ià(
	g$coupÚId
 > 0è
	g$u¾P»fix
 .= "&couponId=$couponId";

190 ià(
	g$mobe
 !=ğ""è
$u¾P»fix
 .= "&mobile=$mobile";

191 
	g$u¾P»fix
 .= "&";

192 
echo
 
g‘_·geNavHtml
(
$·ge
, 
$tÙ®Pages
, 
$u¾P»fix
, 
$showPageNums
);

194 &
	gnb¥
</
	gp
>

195 </
	gdiv
>

196 <
a
 
	gşass
="tuºexˆæ" 
h»f
="javasüt:void(0);" 
id
='goNextPage'> ä¸‹ä¸€é¡µ </a>

197 </
div
>

199 </
div
>

205 </
div
>

207 <
div
 
şass
="footer">

211 <
div
 
şass
="bottom_line ">

212 </
div
>

214 <
p
 
şass
="footer_text">æ¥ è¶£ ç½‘ ç»œ ç§‘ æŠ€ æœ‰ é™ å…¬ å¸</p>

216 </
div
>

218 </
div
>

230 </
body
>

231 </
html
>

	@statistics/teamList.php

1 ï»¿<?
php


2 
»quœe_Úû
('../common/checkAuthority.php');

3 
»quœe_Úû
('../common/include/errorCatcher.php');

4 
»quœe_Úû
('../module/Team.php');

5 
»quœe_Úû
('../common/common.php');

7 
defše
("TABLE_ROW_NUMS", 4);

9 
	g$·¹ÃrId
 = 
$_SESSION
['partnerId'];

10 
	g$Üd”Id
 = 0;

11 
	g$®lowPageShowNums
 = 6;

13 
	g$·ge
 = 1;

14 ià(
is£t
(
$_GET
['·ge']è&& 
	g$_GET
['page'] > 0)

15 
	g$·ge
 = 
$_GET
['page'];

16 
	g$¡¬t
 = (
$·ge
-1)*
TABLE_ROW_NUMS
;

18 
	g$‹am
 = 
Ãw
 
T—m
();

20 
	g$£¬chF›lds
 = 
¬¿y
(

21 '·¹ÃrId' => 
$·¹ÃrId
);

22 
	g$‹amLi¡
 = 
$‹am
->
g‘_‹ams
(
$£¬chF›lds
, 
$¡¬t
, 
TABLE_ROW_NUMS
);

23 
	g$‹amNums
 = 
$‹am
->
g‘_‹amNums
(
$£¬chF›lds
);

24 
	g$tÙ®Pages
 = 
ÿl_tÙ®Pages
(
$‹amNums
, 
TABLE_ROW_NUMS
);

27 <
html
 
	gxmÊs
="http://www.w3.org/1999/xhtml">

28 <
h—d
>

29 <
t™Ë
>éªŒè¯å¹³å°</title>

30 <
m‘a
 
h‰p
-
equiv
="CÚ‹Á-Ty³" 
cÚ‹Á
="text/html; charset=utf-8">

32 <
lšk
 
h»f
="../css/com_css.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

33 <
lšk
 
h»f
="css/couÁ_css.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

35 <
süt
 
¤c
='../js/jquery.min.js'></script>

36 <
süt
 
¤c
='js/teamList.js'></script>

37 <
süt
 
¤c
="../js/common_funcs.js"></script>

38 </
h—d
>

39 <
body
>

42 <
div
 
şass
="maš" 
id
="main">

46 <
div
 
şass
="top_blank">

47 </
div
>

49 <
div
 
şass
="top">

50 <
img
 
¤c
="../images/logo.jpg" />

51 </
div
>

53 <
div
 
şass
="body">

55 <
div
 
şass
="body_l">

56 <
div
 
şass
="nav">

59 <?
php


60 
»quœe
 '../common/templates/left_nav_bar.php';

62 </
	gdiv
>

64 <
div
 
	gşass
="serv">

65 <
div
 
şass
="‹l" 
h»f
="javascript:void(0);"> </div>

66 <
a
 
şass
="online_qq"></a>

67 </
div
>

69 </
div
>

71 <
div
 
şass
="body_r fr">

72 <
p
 
şass
="title_r">>é¡¹ç›®åˆ—è¡¨</p>

74 <
div
 
şass
="title_line"></div>

76 <
div
 
şass
="table">

77 <
div
 
şass
="table_title">

78 <
div
 
şass
="1 fl">

79 <
p
 
şass
="bË_t™Ë_‹xt">é¡¹ç›®
ID
</p>

80 </
div
>

81 <
div
 
şass
="t2 fl">

82 <
p
 
şass
="table_title_text">é¡¹ç›®åç§°</p>

83 </
div
>

84 <
div
 
şass
="t3 fl">

85 <
p
 
şass
="table_title_text">å¹³å°</p>

86 </
div
>

87 <
div
 
şass
="t3 fl">

88 <
p
 
şass
="table_title_text">æ—¥æœŸ</p>

89 </
div
>

90 <
div
 
şass
="t1 fl">

91 <
p
 
şass
="table_title_text">æˆäº¤</p>

92 </
div
>

93 <
div
 
şass
="t1 fl">

94 <
p
 
şass
="table_title_text">å›¢è´­ä»·</p>

95 </
div
>

96 <
div
 
şass
="t4 fl">

97 <
p
 
şass
="table_title_text">æ“ä½œ</p>

98 </
div
>

99 </
div
>

101 <!--<
div
 
şass
="table_item">-->

102 <?
php


103 
$nuÎD©aSŒšg
 = '/';

104 
	g$htmlT—mLi¡
 = '';

105 
	g$i
 = 0; $˜< 
couÁ
(
$‹amLi¡
); $i++)

107 
fÜ—ch
 (
$‹amLi¡
[
$i
] 
as
 
$key
 => 
$v®ue
)

109 
$$key
 = 
$v®ue
;

111 ià(
	g$i
%2 != 0)

112 
$oddEv’CÏss
 = ' item_bg';

114 
	g$oddEv’CÏss
 = '';

116 
	g$htmlT—mLi¡
 .= "<div class='table_item_1' id='teamRowWrap_{$i}'>

117 <
div
 
şass
='item1 fl{$oddEvenClass}'>";

118 ià(
time
()< 
$expœeTime
 && 
$¡©e
 == 'undone')

119 
$htmlT—mLi¡
 .= "<div class='new_ico '></div>";

120 
	g$htmlT—mLi¡
 .="<a class='table_item_id ' >{$teamId}</a>

121 </
div
>

122 <
div
 
şass
='item2 fl{$oddEvenClass}'>

123 <
a
 
şass
='bË_™em_‹xt' >{
$‹amT™Ë
}</a>

124 </
div
>

125 <
div
 
şass
='item3 fl{$oddEvenClass}'>

126 <
a
 
şass
='bË_™em_icØæ' ><
img
 
¤c
='../images/logo_‹am_{$¶©fÜmKey}.jpg' 
®t
='$¶©fÜmT™Ë' 
t™Ë
='$platformTitle'/></a>

127 </
div
> <div 
şass
='item4 fl{$oddEvenClass}'>

128 <
a
 
şass
='table_item_text' >";

129 
$begšTimeSŒšg
 = 
$’dTimeSŒšg
 = 
$nuÎD©aSŒšg
;

130 ià(
	g$begšTime
 >0è
	g$begšTimeSŒšg
 = 
d©e
('Y-m-d',
$begšTime
);

131 ià(
	g$’dTime
 >0è
	g$’dTimeSŒšg
 = 
d©e
('Y-m-d',
$’dTime
);

132 
	g$htmlT—mLi¡
 .ğ
$begšTimeSŒšg
.'<b¸/>'.
$’dTimeSŒšg
;

133 
	g$htmlT—mLi¡
 .="</a></div>

134 <
div
 
şass
='item1 fl{$oddEvenClass}'>

135 <
a
 
şass
='bË_™em_‹xt' >{
$nowNum
}/{
$mšNum
}</a>

136 </
div
>

137 <
div
 
şass
='item6 fl{$oddEvenClass}'>

138 <
a
 
şass
='bË_™em_‹xt' >ï¿¥{
$‹amPriû
}";

139 ià(
$m¬k‘Priû
 > 0è
$htmlT—mLi¡
 .="<br />ï¿¥{$marketPrice}";

140 
	g$htmlT—mLi¡
.="</a>

141 </
div
>

142 <
div
 
şass
='item7 fl{$oddEvenClass}'>

143 <
div
 
şass
='n_1'>

144 <
a
 
şass
='bË_™em_‹xˆxf' 
h»f
='cÚsumedCoupÚs.php?‹amId={$‹amId}&¶©fÜm={$¶©fÜmKey}&äomT—mPage={$·ge}'>å·²æ¶ˆè´¹</a><
p
 class='table_item_text fl_line'> | </p><a class='table_item_text xz' href='javascript:void(0);'>ä¸‹è½½</a>

145 </
div
>

146 <
br
/><
div
 
şass
='n_2'>

147 <
a
 
şass
='bË_™em_‹xt' 
h»f
='javascript:void(0);'>ç»Ÿè®¡</a>

148 </
div
></div></div>";

150 
echo
 
	g$htmlT—mLi¡
;

154 </
	gdiv
>

155 <
šput
 
	gty³
='hidd’' 
id
='·ge' <?
php
 
echo
 "v®ue=".
$·ge
; ?> />

156 <
šput
 
	gty³
='hidd’' 
id
='‹amNums' <?
php
 
echo
 "v®ue=".
$‹amNums
; ?> />

158 <
div
 
	gşass
="page_turn">

159 <
a
 
şass
="tuº_‹xˆæ" 
h»f
="javasüt:void(0);" 
id
='goPrevPage'> ä¸Šä¸€é¡µ </a>

160 <
div
 
şass
="page fl">

161 <
p
 
şass
="tuº_‹xt" 
id
='·geG­'>&
nb¥


162 <?
php


163 
$showPageNums
 = 11;

164 
	g$u¾P»fix
 = "teamList.php?";

165 
echo
 
g‘_·geNavHtml
(
$·ge
, 
$tÙ®Pages
, 
$u¾P»fix
, 
$showPageNums
);

168 &
	gnb¥
</
	gp
>

169 </
	gdiv
>

170 <
a
 
	gşass
="tuºexˆæ" 
h»f
="javasüt:void(0);" 
id
='goNextPage'> ä¸‹ä¸€é¡µ </a>

171 </
div
>

173 </
div
>

179 </
div
>

181 <
div
 
şass
="footer">

185 <
div
 
şass
="bottom_line ">

186 </
div
>

188 <
p
 
şass
="footer_text">æ¥ è¶£ ç½‘ ç»œ ç§‘ æŠ€ æœ‰ é™ å…¬ å¸</p>

190 </
div
>

192 </
div
>

204 </
body
>

205 </
html
>

	@verifyCoupon/VerifyCoupon.php

1 <?
php


13 
»quœe_Úû
('../common/Exception.php');

14 
»quœe_Úû
('../common/CodeMessages.php');

19 şas 
	cV”ifyCoupÚ


25 cÚ¡ 
	mTARGET_API
 = 'verifyCoupon';

29 
´iv©e
 
	m$_suµÜtPÏtfÜms
 = 
¬¿y
("laiqu", "juhuasuan");

31 
´iv©e
 
	m$_¶©fÜm
 = '';

32 
´iv©e
 
	m$_»que¡M‘hod
 = '';

33 
´iv©e
 
	m$_h‰pM‘hod
 = '';

34 
´iv©e
 
	m$_»¥Ú£Ty³
 = '';

35 
´iv©e
 
	m$_­iU¾
 = '';

36 
´iv©e
 
	m$_»que¡P¬ams
 = 
¬¿y
();

37 
´iv©e
 
	m$_»que¡P¬amsStic
 = 
¬¿y
();

38 
´iv©e
 
	m$_codeTag
 = '';

39 
´iv©e
 
	m$_codeSucûss
 = '';

40 
´iv©e
 
	m$_coupÚId
 = 0;

54 
public
 
funùiÚ
 
	$š™
(
$¶©fÜm
)

56 iàĞ!
$this
->
	`is_suµÜ‹d
(
$¶©fÜm
) )

58 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

59 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
UNKNOWN_PLATFORM_ERROR
),

60 
V”ifyCoupÚCodeMsg
::
UNKNOWN_PLATFORM_ERROR
);

62 
$this
->
_¶©fÜm
 = 
$¶©fÜm
;

64 
$cÚfigFeName
 = "../¶©fÜm_­i_cÚfs/" . 
$this
->
_¶©fÜm
 . ".conf";

65 
$cÚ‹Á
 = 
	`fe_g‘_cÚ‹Ás
(
$cÚfigFeName
);

66 
$cÚfigs
 = 
	`jsÚ_decode
(
$cÚ‹Á
);

68 ià(
$cÚfigs
 =ğ
nuÎ
)

70 
throw
 
Ãw
 
	`V”ifyCoupÚ_P¬£CÚfigFeExû±iÚ
(

71 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
PARSE_CONFIG_FILE_ERROR
),

72 
V”ifyCoupÚCodeMsg
::
PARSE_CONFIG_FILE_ERROR
);

75 
$this
->
_»que¡M‘hod
 = 
$cÚfigs
->
»que¡M‘hod
;

76 
$this
->
_h‰pM‘hod
 = 
$cÚfigs
->
h‰pM‘hod
;

77 
$this
->
_»¥Ú£Ty³
 = 
$cÚfigs
->
»¥Ú£Ty³
;

78 
$rg‘Api
 = 
£lf
::
TARGET_API
;

79 
$rg‘ApiCÚfs
 = 
$cÚfigs
->
$rg‘Api
;

81 
$this
->
_­iU¾
 = 
$rg‘ApiCÚfs
->
­iU¾
;

82 
$this
->
_»que¡P¬ams
 = 
$rg‘ApiCÚfs
->
»que¡P¬ams
;

83 
$this
->
_»que¡P¬amsStic
 = 
$rg‘ApiCÚfs
->
»que¡P¬amsStic
;

84 
$this
->
_codeTag
 = 
$rg‘ApiCÚfs
->
»¥Ú£ResuÉ
->
codeTag
;

85 
$this
->
_codeSucûss
 = 
$rg‘ApiCÚfs
->
»¥Ú£ResuÉStic
->
codeSucûss
;

87  
Œue
;

99 
public
 
funùiÚ
 
	$is_suµÜ‹d
(
$¶©fÜm
)

101 ià(
$¶©fÜm
 == '')

102  
çl£
;

103 
	`fÜ—ch
 (
$this
->
_suµÜtPÏtfÜms
 
as
 
$suµÜt
)

105 ià(
$¶©fÜm
 =ğ
$suµÜt
)

106  
Œue
;

109  
çl£
;

110 
	}
}

122 
public
 
funùiÚ
 
	$š™_v”ifyIÅuts
(
$»que¡
)

124 ià(!
	`is£t
(
$»que¡
['couponId']) || $request['couponId'] == '')

126 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

127 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
INVALID_COUPONID_ARG_ERROR
),

128 
V”ifyCoupÚCodeMsg
::
INVALID_COUPONID_ARG_ERROR
);

130 
$šputs
['coupÚId'] = 
$»que¡
['couponId'];

132 ià(
	`is£t
(
$this
->
_»que¡P¬ams
->
coupÚPwd
))

134 ià(
$»que¡
['couponPwd'] == '')

136 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

137 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
INVALID_COUPONPWD_ARG_ERROR
),

138 
V”ifyCoupÚCodeMsg
::
INVALID_COUPONPWD_ARG_ERROR
);

141 
$šputs
['coupÚPwd'] = 
$»que¡
['couponPwd'];

144 ià(
	`is£t
(
$this
->
_»que¡P¬ams
->
cÚsumeCouÁ
))

146 
$cÚsumeCouÁ
 = 
$»que¡
['consumeCount'];

147 ià(
$cÚsumeCouÁ
 ==ğ"" || !
	`is_num”ic
($cÚsumeCouÁè|| 
	`štv®
($consumeCount) < 1)

149 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

150 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
MALFORMED_COUNT_NUMBER
),

151 
V”ifyCoupÚCodeMsg
::
MALFORMED_COUNT_NUMBER
);

154 
$šputs
['cÚsumeCouÁ'] = 
$cÚsumeCouÁ
;

157  
$šputs
;

158 
	}
}

170 
public
 
funùiÚ
 
	$g‘_»¥Ú£Code
(
$»¥Ú£
)

172 
$»¥Ú£Code
 = "";

173 ià((
$»¥Ú£
 =ğ"" && 
$this
->
_»¥Ú£Ty³
 !== "JUHUASUAN") || $this->_responseType == "" ||

174 
$this
->
_codeTag
 =ğ"" || $this->
_codeSucûss
 == "")

176 
throw
 
Ãw
 
	`V”ifyCoupÚ_P¬£Re¥Ú£Exû±iÚ
(

177 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
PARSE_RESPONSE_EXCEPTION
),

178 
V”ifyCoupÚCodeMsg
::
PARSE_RESPONSE_EXCEPTION
);

181 
$codeTag
 = 
$this
->
_codeTag
;

182 
$»¥Ú£Ty³
 = 
	`¡¹ouµ”
(
$this
->
_»¥Ú£Ty³
);

183 ià(
$»¥Ú£Ty³
== "LAIQU")

185 
	`´eg_m©ch_®l
("/(<([\w]+)[^>]*>)(.*?)(<\/\\2>)/", 
$»¥Ú£
, 
$m©ches
, 
PREG_SET_ORDER
);

186 
	`fÜ—ch
 (
$m©ches
 
as
 
$v®
) {

187 ià(
$v®
[2] =ğ
$this
->
_codeTag
)

189 
$»¥Ú£Code
 = 
$v®
[3];

192 } ià(
$»¥Ú£Ty³
 == "XML")

194 
$xmlRe¥Ú£
 = 
	`sim¶exml_lßd_¡ršg
(
$»¥Ú£
);

195 
$»¥Ú£Code
 = 
$xmlRe¥Ú£
->
$codeTag
;

196 } ià(
$»¥Ú£Ty³
 === "JSON")

198 
$jsÚRe¥Ú£
 = 
	`jsÚ_decode
(
$»¥Ú£
);

199 
$»¥Ú£Code
 = 
$jsÚRe¥Ú£
->
$codeTag
;

200 } ià(
$»¥Ú£Ty³
 === "JUHUASUAN")

204 ià(
çl£
 ==ğ
	`¡ros
(
$»¥Ú£
, "false"))

206 
$»¥Ú£Code
 = "true";

207 } ià(
çl£
 !=ğ
	`¡½os
(
$»¥Ú£
, "302")){

209 
$»¥Ú£Code
 = "login_expired";

211 
$»¥Ú£Code
 = "false";

215 ià(
$»¥Ú£Code
 == '')

217 
throw
 
Ãw
 
	`V”ifyCoupÚ_P¬£Re¥Ú£Exû±iÚ
(

218 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
PARSE_RESPONSE_EXCEPTION
),

219 
V”ifyCoupÚCodeMsg
::
PARSE_RESPONSE_EXCEPTION
);

221 ià(
$»¥Ú£Code
 =ğ
$this
->
_codeSucûss
)

223  
V”ifyCoupÚCodeMsg
::
VERIFY_COUPON_SUCCESS
;

225 ià(
$»¥Ú£Code
 === "login_expired")

227  
V”ifyCoupÚCodeMsg
::
JUHUASUAN_LOGIN_EXPIRED
;

230  
V”ifyCoupÚCodeMsg
::
VERIFY_COUPON_FAIL
;

232 
	}
}

244 
public
 
funùiÚ
 
	$g‘_»que¡P¬ams
(
$šputs
)

246 ià(!
	`is_¬¿y
(
$šputs
))

248 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

249 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
TRANSFER_REQUEST_PARAM_ERROR
),

250 
V”ifyCoupÚCodeMsg
::
TRANSFER_REQUEST_PARAM_ERROR
);

253 
$·¿ms
 = 
	`¬¿y
();

254 
	`fÜ—ch
 (
$this
->
_»que¡P¬ams
 
as
 
$key
 => 
$v®ue
)

257 ià(!
	`is£t
(
$šputs
[
$key
]))

259 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

260 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
TRANSFER_REQUEST_PARAM_ERROR
),

261 
V”ifyCoupÚCodeMsg
::
TRANSFER_REQUEST_PARAM_ERROR
);

264 
$·¿ms
[
$v®ue
] = 
$šputs
[
$key
];

266 ià(
$this
->
_»que¡P¬amsStic
 !ğ
nuÎ
)

269 
	`fÜ—ch
 (
$this
->
_»que¡P¬amsStic
 
as
 
$key
 => 
$v®ue
)

271 
$·¿ms
[
$key
] = 
$v®ue
;

274  
$·¿ms
;

275 
	}
}

286 
public
 
funùiÚ
 
g’_»¥Ú£_jsÚ
(
$»suÉ
, 
$msg
 = "")

289 
$code
 = 
$»suÉ
;

290 ià(
	g$msg
 == "")

293 
$msg
 = 
V”ifyCoupÚCodeMsg
::
g‘_mes§ge
(
$code
);

296 ià(
em±y
(
$msg
))

298 
	g$code
 = 
CommÚCodeMsg
::
INVALID_ARGUMENT_ERROR
;

299 
	g$msg
 = 
CommÚCodeMsg
::
g‘_mes§ge
(
$code
);

303 ià(
	g$code
 ==ğ
V”ifyCoupÚCodeMsg
::
VERIFY_COUPON_SUCCESS
)

305 
$»¥Ú£
['sucûss'] = 
Œue
;

307 
	g$»¥Ú£
['sucûss'] = 
çl£
;

309 
	g$»¥Ú£
['code'] = 
$code
;

310 
	g$»¥Ú£
['msg'] = 
$msg
;

312  
jsÚ_’code
(
$»¥Ú£
);

317 
public
 
funùiÚ
 
	$g‘_¶©fÜm
()

319  
$this
->
_¶©fÜm
;

320 
	}
}

324 
public
 
funùiÚ
 
	$g‘_»que¡M‘hod
()

326  
$this
->
_»que¡M‘hod
;

327 
	}
}

331 
public
 
funùiÚ
 
	$g‘_h‰pM‘hod
()

333  
$this
->
_h‰pM‘hod
;

334 
	}
}

338 
public
 
funùiÚ
 
	$g‘_»¥Ú£Ty³
()

340  
$this
->
_»¥Ú£Ty³
;

341 
	}
}

345 
public
 
funùiÚ
 
	$g‘_­iU¾
()

347  
$this
->
_­iU¾
;

348 
	}
}

352 
public
 
funùiÚ
 
	$g‘_codeTag
()

354  
$this
->
_codeTag
;

355 
	}
}

359 
public
 
funùiÚ
 
	$g‘_codeSucûss
()

361  
$this
->
_codeSucûss
;

362 
	}
}

	@verifyCoupon/VerifyCoupon_funcs.php

1 <?
php


9 
funùiÚ
 
	$š™_v”ifyIÅuts
(
$»que¡
)

11 
$šputs
 = 
	`¬¿y
();

14 
$šputs
['coupÚId'] = 
$»que¡
['couponId'];

15 ià(
$»que¡
['couponPwd'] != '')

16 
$šputs
['coupÚPwd'] = 
$»que¡
['couponPwd'];

17  
$šputs
;

18 
	}
}

30 
funùiÚ
 
	$·r£_¶©fÜm_»¥Ú£
(
$»¥Ú£
, 
$»que¡M‘hod
, 
$»¥Ú£Ty³
, 
$codeTag
, 
$codeSucûss
)

32 ià(
$»que¡M‘hod
 != 'REST')

33  
CODE_ERROR_ONLY_SUPPORT_REST
;

34  
	`g‘_»¥Ú£Code
(
$»¥Ú£
, 
$»¥Ú£Ty³
, 
$codeTag
, 
$codeSucûss
);

35 
	}
}

37 
funùiÚ
 
	$g‘_»¥Ú£Code
(
$»¥Ú£
, 
$»¥Ú£Ty³
, 
$codeTag
, 
$codeSucûss
)

39 
$»¥Ú£Code
 = "";

40 ià(
$»¥Ú£
 =ğ"" || 
$»¥Ú£Ty³
 == "" ||

41 
$codeTag
 =ğ"" || 
$codeSucûss
 == "")

42  
CODE_ERROR_API_CALL
;

44 ià(
$»¥Ú£Ty³
 == "LAIQU")

46 
	`´eg_m©ch_®l
("/(<([\w]+)[^>]*>)(.*?)(<\/\\2>)/", 
$»¥Ú£
, 
$m©ches
, 
PREG_SET_ORDER
);

47 
	`fÜ—ch
 (
$m©ches
 
as
 
$v®
) {

48 ià(
$v®
[2] =ğ
$codeTag
)

50 
$»¥Ú£Code
 = 
$v®
[3];

53 } ià(
$»¥Ú£Ty³
 == "XML")

55 
$xmlRe¥Ú£
 = 
	`sim¶exml_lßd_¡ršg
(
$»¥Ú£
);

56 
$»¥Ú£Code
 = 
$xmlRe¥Ú£
->
$code
;

59 ià(
$»¥Ú£Code
 == '')

60  
CODE_ERROR_API_CALL
;

62  
$»¥Ú£Code
 =ğ
$codeSucûss
 ? 
CODE_SUCCESS_VERIFY_COUPON
:
CODE_FAIL_VERIFY_COUPON
;

63 
	}
}

72 
funùiÚ
 
	$·r£_¶©fÜm_cÚfs
(
$¶©fÜm
)

74 
glob®
 
$»que¡M‘hod
;

75 
glob®
 
$h‰pM‘hod
;

76 
glob®
 
$»¥Ú£Ty³
;

77 
glob®
 
$­iU¾
;

78 
glob®
 
$»que¡P¬ams
;

79 
glob®
 
$»que¡P¬amsStic
;

80 
glob®
 
$codeTag
;

81 
glob®
 
$codeSucûss
;

83 
$cÚfigFeName
 = "¶©fÜm_­i_cÚfs/" . 
$¶©fÜm
 . ".conf";

84 
$cÚ‹Á
 = 
	`fe_g‘_cÚ‹Ás
(
$cÚfigFeName
);

85 
$cÚfigs
 = 
	`jsÚ_decode
(
$cÚ‹Á
);

86 
	`fÜ—ch
 (
$cÚfigs
 
as
 
$key
 => 
$v®ue
)

88 
glob®
 
$$key
;

89 
$$key
 = 
$v®ue
;

91 
$­iU¾
 = 
$$rg‘Api
->
­iU¾
;

92 
$»que¡P¬ams
 = 
$$rg‘Api
->
»que¡P¬ams
;

93 
$»que¡P¬amsStic
 = 
$$rg‘Api
->
»que¡P¬amsStic
;

94 
$codeTag
 = 
$$rg‘Api
->
»¥Ú£ResuÉ
->
codeTag
;

95 
$codeSucûss
 = 
$$rg‘Api
->
»¥Ú£ResuÉStic
->
codeSucûss
;

96 
	}
}

105 
funùiÚ
 
	$g‘_»que¡P¬ams
(
$šputs
)

107 
$·¿ms
 = 
	`¬¿y
();

108 
glob®
 
$»que¡P¬ams
;

109 
glob®
 
$»que¡P¬amsStic
;

110 
	`fÜ—ch
 (
$»que¡P¬ams
 
as
 
$key
 => 
$v®ue
)

113 
$·¿ms
[
$v®ue
] = 
$šputs
[
$key
];

115 ià(
$»que¡P¬amsStic
 !ğ
nuÎ
)

118 
	`fÜ—ch
 (
$»que¡P¬amsStic
 
as
 
$key
 => 
$v®ue
)

120 
$·¿ms
[
$key
] = 
$v®ue
;

123  
$·¿ms
;

124 
	}
}

133 
funùiÚ
 
	$g’_»¥Ú£_jsÚ
(
$»suÉ
)

135 
glob®
 
$codeMes§ges
;

136 
$»¥Ú£
 = 
	`¬¿y
();

138 ià(!
$»suÉ
 || 
$codeMes§ges
[$result] == '')

139 
$»suÉ
 = 
CODE_ERROR_UNKNOWN
;

141 
$»¥Ú£
['code'] = 
$»suÉ
;

142 
$»¥Ú£
['msg'] = 
$codeMes§ges
[
$»suÉ
];

143 
$»¥Ú£
['d©eTime'] = 
	`d©e
("Y-m-d, h:i:s");

145  
	`jsÚ_’code
(
$»¥Ú£
);

146 
	}
}

	@verifyCoupon/doVerifyCoupon.php

1 <?
php


10 
	g»quœe_Úû
 '../common/checkAuthority.php';

11 
	g»quœe_Úû
 '../common/RESTclient.php';

12 
	g»quœe_Úû
 'VerifyCoupon.php';

13 
	g»quœe_Úû
 '../common/CodeMessages.php';

14 
	g»quœe_Úû
 'functions.php';

16 
funùiÚ
 
	$ruÁimeE¼ÜHªdËr
(
$”ºo
, 
$”r¡r
, 
$”rfe
, 
$”¾še
)

19 
$code
 = 
CommÚCodeMsg
::
SYSTEM_RUNTIME_ERROR
;

21 
	`”rÜ_log
(
$”r¡r
);

22 
	`d›
(
V”ifyCoupÚ
::
	`g’_»¥Ú£_jsÚ
(
$code
));

24 
	}
}

25 
funùiÚ
 
	$exû±iÚHªdËr
(
$exû±iÚ
)

27 
$code
 = 
$exû±iÚ
->
	`g‘Code
();

28 
$v”ifyMsg
 = 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(
$code
);

29 ià(
	`em±y
(
$v”ifyMsg
))

31 
$code
 = 
CommÚCodeMsg
::
UNCAUGHT_FATAL_ERROR
;

32 
$”r¡r
 = 
$exû±iÚ
->
	`g‘Mes§ge
();

34 
	`”rÜ_log
(
$”r¡r
);

36 
	`d›
(
V”ifyCoupÚ
::
	`g’_»¥Ú£_jsÚ
(
$code
));

37 
	}
}

38 
£t_”rÜ_hªdËr
('ruÁimeE¼ÜHªdËr', 
E_ERROR
);

39 
£t_exû±iÚ_hªdËr
('exceptionHandler');

41 
	g$¶©fÜm
 = 
$_REQUEST
['platform'];

44 ià(
is£t
(
$_REQUEST
['aùiÚ']è&& 
	g$_REQUEST
['aùiÚ'] ==ğ'v®id©eCode' && 
$¶©fÜm
 === 'juhuasuan')

46 
$»¡
 = 
Ãw
 
RESTş›Á
();

47 
	g$»¡
->
ü—‹Reque¡
('h‰p://59.151.29.121/v®id©eCode.do?'.
d©e
(
mktime
()), 'GET');

48 
	g$»q
 = 
$»¡
->
g‘H‰pReque¡
();

50 
	g$»¡
->
£ndReque¡
();

51 
	g$»¥Ú£Obj
 = 
$»¡
->
g‘Re¥Ú£Obj
();

52 
	g$j£ssiÚid
 = 
fšdCook›
("JSESSIONID", 
$»¥Ú£Obj
->
g‘Cook›s
());

53 ià(
	g$j£ssiÚid
 != '')

55 
$»q
->
addCook›
("JSESSIONID", 
$j£ssiÚid
['value']);

57 
	g$_SESSION
['JSESSIONID'] = 
$j£ssiÚid
['value'];

59 
h—d”
("Content-Type:image/jpeg");

60 
echo
 
	g$»¡
->
g‘Re¥Ú£
();

61 
un£t
(
$»¡
);

62 
	gex™
;

64 ià(
is£t
(
$_REQUEST
['aùiÚ']è&& 
	g$_REQUEST
['aùiÚ'] ==ğ'isjulogš' && 
$¶©fÜm
 === 'juhuasuan')

66 ià(
is£t
(
$_SESSION
['JSESSIONID']) && $_SESSION['JSESSIONID'] !== "")

68 
$sucûss
 = 
Œue
;

70 
	g$sucûss
 = 
çl£
;

72 
echo
 
jsÚ_’code
(
¬¿y
("sucûss"=>
$sucûss
));

73 
	gex™
;

75 ià(
is£t
(
$_REQUEST
['aùiÚ']è&& 
	g$_REQUEST
['aùiÚ'] ==ğ'julogš' && 
$¶©fÜm
 === 'juhuasuan')

77 
$v®id©eCode
 = 
$_REQUEST
['validatecode'];

78 
	g$sucûss
 = 
çl£
;

80 ià(
	g$v®id©eCode
 !== "")

82 
$sucûss
 = 
logš_¶©fÜm
(
$¶©fÜm
);

84 ià(
	g$sucûss
 === "juhuasuan_not_bind")

86 
$sucûss
 = 
V”ifyCoupÚCodeMsg
::
PLATFORM_ACCT_NOT_BIND_ERROR
;

89 
echo
 
jsÚ_’code
(
¬¿y
("sucûss" => 
$sucûss
));

90 
	gex™
;

93 
	g$»¥Ú£Code
 = 
doV”ifyCoupÚ
(
$_REQUEST
);

94 
	g$coupÚId
 = 
$_REQUEST
['couponId'];

95 ià(
	g$¶©fÜm
 === 'juhuasuan')

97 
$cÚsumed_times
 = 
$_REQUEST
['consumeCount'];

101 ià(
	g$»¥Ú£Code
 ==ğ
V”ifyCoupÚCodeMsg
::
JUHUASUAN_LOGIN_EXPIRED
)

104 
$ŒyTimes
 = 10;

105 
	g$couÁ
 = 0;

106 !
logš_¶©fÜm
('juhuasuan'))

108 ià(++
	g$couÁ
 ==ğ
$ŒyTimes
 ) ;

110 ià(
	g$couÁ
 < 
	g$ŒyTimes
)

112 
	g$»¥Ú£Code
 = 
doV”ifyCoupÚ
(
$_REQUEST
);

116 ià(
	g$»¥Ú£Code
 ==ğ
V”ifyCoupÚCodeMsg
::
VERIFY_COUPON_SUCCESS
)

118 ià(!
»cÜd_cÚsumed_coupÚ
(
$coupÚId
, 
$¶©fÜm
, 
$cÚsumed_times
))

120 
$»¥Ú£Code
 = 
V”ifyCoupÚCodeMsg
::
RECORD_COUPON_FAILED_ERROR
;

123 ià(
	g$»¥Ú£Code
 ==ğ
V”ifyCoupÚCodeMsg
::
RECORD_COUPON_FAILED_ERROR
)

125 
$»¥Ú£
 = 
V”ifyCoupÚ
::
g’_»¥Ú£_jsÚ
(

126 
V”ifyCoupÚCodeMsg
::
RECORD_COUPON_FAILED_ERROR
,

127 "E¼ÜCode: ".
V”ifyCoupÚCodeMsg
::
RECORD_COUPON_FAILED_ERROR
." å¹³å°:".
$¶©fÜm
."ç¼–å·ä¸º".
$coupÚId
."çš„å·²æ¶ˆè´¹çš„å›¢è´­åˆ¸åœ¨æœ¬åœ°ç™»è®°å¤±è´¥!");

130 
	g$»¥Ú£
 = 
V”ifyCoupÚ
::
g’_»¥Ú£_jsÚ
(
$»¥Ú£Code
);

132 
	g$»¥Ú£W™hCoupÚInfo
 = 
addCoupÚInfoToV”ifyRe¥Ú£
(
$»¥Ú£
, 
$coupÚId
, 
$¶©fÜm
, 
$cÚsumed_times
);

133 
echo
 
	g$»¥Ú£W™hCoupÚInfo
;

134 
un£t
(
$»¡
);

	@verifyCoupon/functions.php

1 <?
php


12 
	g»quœe_Úû
 '../module/PartnerPlatforms.php';

13 
	g»quœe_Úû
 '../module/Order.php';

14 
	g»quœe_Úû
 '../module/Team.php';

15 
	g»quœe_Úû
 '../module/Coupon.php';

16 
	g»quœe_Úû
 '../common/class/Valite.php';

17 
	g»quœe_Úû
 'VerifyCoupon.php';

18 
	g»quœe_Úû
 '../common/RESTclient.php';

21 
funùiÚ
 
	$fšdCook›
(
$Çme
, 
$cook›s
)

23 
	`fÜ—ch
 (
$cook›s
 
as
 
$cook›
)

25 ià(
$cook›
['Çme'] ==ğ
$Çme
)

27  
$cook›
;

31 
	}
}

35 
funùiÚ
 
	$d—l_w™h_¶©fÜm
(
$»que¡
)

37 
$¶©fÜm
 = 
$»que¡
['platform'];

39 ià(
$¶©fÜm
 === 'juhuasuan')

41 
$v®id©eCode
 = 
$»que¡
['validateCode'];

42 ià(
$v®id©eCode
 ==ğ"" || !
	`logš_¶©fÜm
(
$¶©fÜm
))

44  
V”ifyCoupÚCodeMsg
::
VALIDATECODE_NOT_MATCH_ERROR
;

46 ià(
	`logš_¶©fÜm
(
$¶©fÜm
) === "juhuasuan_not_bind")

48  
V”ifyCoupÚCodeMsg
::
PLATFORM_ACCT_NOT_BIND_ERROR
;

50  
Œue
;

52 
	}
}

55 
funùiÚ
 
	$g‘_logš_v®id©e_img_·th
(
$¶©fÜm
)

57 
$tmp_ÿ±cha_Çme
 = '';

58 ià(
$¶©fÜm
 === "juhuasuan")

60 
$ÿ±chaU¾
 = 'h‰p://59.151.29.121/v®id©eCode.do?'.
	`d©e
(
	`mktime
());

61 
$imgSuffix
 = 'jpg';

64 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

65 
$»¡
->
	`ü—‹Reque¡
(
$ÿ±chaU¾
);

66 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

68 
$»¡
->
	`£ndReque¡
();

69 
$»¥Ú£Obj
 = 
$»¡
->
	`g‘Re¥Ú£Obj
();

70 
$j£ssiÚid
 = 
	`fšdCook›
("JSESSIONID", 
$»¥Ú£Obj
->
	`g‘Cook›s
());

71 ià(
$j£ssiÚid
 != '')

73 
$»q
->
	`addCook›
("JSESSIONID", 
$j£ssiÚid
['value']);

75 
$_SESSION
['JSESSIONID'] = 
$j£ssiÚid
['value'];

77 
$tmp_ÿ±cha_Çme
 = 
	`‹m²am
(
	`sys_g‘_‹mp_dœ
(),
$imgSuffix
);

78 
	`fe_put_cÚ‹Ás
(
$tmp_ÿ±cha_Çme
, 
$»¡
->
	`g‘Re¥Ú£
());

79  
$tmp_ÿ±cha_Çme
;

80 
	}
}

82 
funùiÚ
 
	$decode_ÿ±cha
(
$ÿ±chaP©h
)

84 
$v®™e
 = 
Ãw
 
	`V®™e
();

86 
$v®™e
->
	`£tImage
(
$ÿ±chaP©h
);

87 
$v®™e
->
	`g‘Hec
();

88 
$v®id©eCode
 = 
$v®™e
->
	`run
();

90  
$v®id©eCode
;

91 
	}
}

93 
funùiÚ
 
	$logš_¶©fÜm
(
$¶©fÜm
)

95 ià(
$¶©fÜm
 === 'juhuasuan')

98 
$sucûss
 = 
çl£
;

99 
$ÿ±chaP©h
 = 
	`g‘_logš_v®id©e_img_·th
(
$¶©fÜm
);

100 
$v®id©eCode
 = 
	`decode_ÿ±cha
(
$ÿ±chaP©h
);

101 
	`uÆšk
(
$ÿ±chaP©h
);

103 
$logšU¾
 = "http://59.151.29.121/shopUsed/shopLogin.do";

105 
$·¿ms
 = 
	`g‘_juhuasuª_logš_·¿ms
();

106 ià(
$·¿ms
 ==ğ
nuÎ
)

110 
$·¿ms
['mod–.v®id©eCode'] = 
$v®id©eCode
;

111 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

112 
$»¡
->
	`ü—‹Reque¡
(
$logšU¾
,'POST',
$·¿ms
);

115 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

116 
$»q
->
	`£tCook›J¬
();

117 
$»q
->
	`addCook›
("JSESSIONID", 
$_SESSION
['JSESSIONID']);

118 
$»¡
->
	`£ndReque¡
();

119 
$»¥Ú£
 = 
$»¡
->
	`g‘Re¥Ú£
();

120 
	`un£t
(
$»¡
);

121 
$sucûss
 = 
	`is_logš_sucûss
(
$»¥Ú£
, 
$¶©fÜm
);

123 ià(
$sucûss
 ==ğ
Œue
)

125 
$_SESSION
['·¹Ãr_'.
$¶©fÜm
] = 
	`¬¿y
(

126 "p_u£ºame" => 
$·¿ms
['model.sign'],

127 "p_·sswÜd" => 
$·¿ms
['model.password'],

128 "p_‹rmš®id" => 
$·¿ms
['model.terminalId']);

130  
$sucûss
;

132 
	}
}

134 
funùiÚ
 
	$doV”ifyCoupÚ
(
$»que¡
)

136 
$¶©fÜm
 = 
$»que¡
['platform'];

137 
$v”ifyCoupÚ
 = 
Ãw
 
	`V”ifyCoupÚ
();

139 
$v”ifyCoupÚ
->
	`š™
(
$¶©fÜm
);

141 
$šputs
 = 
$v”ifyCoupÚ
->
	`š™_v”ifyIÅuts
(
$»que¡
);

142 
$coupÚId
 = 
$šputs
['couponId'];

143 ià(
$¶©fÜm
 ==ğ'juhuasuª' && 
	`is£t
(
$_SESSION
['partner_'.$platform]))

145 
$šputs
['‹rmš®id'] = 
$_SESSION
['·¹Ãr_'.
$¶©fÜm
]['p_terminalid'];

148 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

149 
$·¿ms
 = 
$v”ifyCoupÚ
->
	`g‘_»que¡P¬ams
(
$šputs
);

151 ià(
$v”ifyCoupÚ
->
	`g‘_h‰pM‘hod
() == 'POST') {

152 
$»¡
->
	`ü—‹Reque¡
(
$v”ifyCoupÚ
->
	`g‘_­iU¾
(), 'POST', 
$·¿ms
);

154 
$»¡
->
	`ü—‹Reque¡
(
$v”ifyCoupÚ
->
	`g‘_­iU¾
());

155 
$u¾
 = 
$»¡
->
	`g‘U¾
();

156 
$u¾
->
	`£tQu”yV¬ŸbËs
(
$·¿ms
);

158 
$»¥Ú£
 = '';

161 ià(
$¶©fÜm
 === "juhuasuan")

163 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

164 
$»q
->
	`addCook›
("JSESSIONID", 
$_SESSION
['JSESSIONID']);

165 
$cÚsumed_times
 = 
$»que¡
['consumeCount'];

168 
$»¡
->
	`£ndReque¡
();

169 
$»¥Ú£
 = 
$»¡
->
	`g‘Re¥Ú£
();

170 
$»¥Ú£Code
 = 
$v”ifyCoupÚ
->
	`g‘_»¥Ú£Code
(
$»¥Ú£
);

171  
$»¥Ú£Code
;

172 
	}
}

175 
funùiÚ
 
	$is_logš_sucûss
(
$»¥Ú£
, 
$¶©fÜm
)

177 ià(
$¶©fÜm
 === 'juhuasuan')

180 iàĞ1 !=ğ
	`´eg_m©ch
('/g‘Li¡\(\"shİU£d\/h—d”s\.do\"\)/', 
$»¥Ú£
))

182  
çl£
;

184  
Œue
;

186 
	}
}

188 
funùiÚ
 
	$g‘_juhuasuª_logš_·¿ms
()

190 
$·¹ÃrPÏtfÜms
 = 
Ãw
 
	`P¬Š”PÏtfÜms
();

191 ià(!
	`is£t
(
$_SESSION
['partnerId']))

193  
nuÎ
;

195 
$µRow
 = 
$·¹ÃrPÏtfÜms
->
	`g‘_row
(

196 
	`¬¿y
("·¹Ãr_id" => 
$_SESSION
['partnerId'],

200 ià(
$µRow
 ==ğ
nuÎ
) { ‚ull; }

202 
$·¿ms
 = 
	`¬¿y
 (

203 "mod–.sign" => 
$µRow
['p_username'],

204 "mod–.·sswÜd" => 
$µRow
['p_password'],

205 "mod–.‹rmš®Id" => 
$µRow
['p_terminalid']);

206  
$·¿ms
;

207 
	}
}

210 
funùiÚ
 
	$»cÜd_cÚsumed_coupÚ
(
$coupÚId
, 
$¶©fÜm
, 
$cÚsumed_times
=1)

212 
$coupÚ
 = 
Ãw
 
	`CoupÚ
();

213 
$cÚd™iÚs
 = 
	`¬¿y
(

214 "¶©fÜm_coupÚ_id"=>
$coupÚId
,

215 "¶©fÜm_key"=>
$¶©fÜm
);

216 
$cÚsumedCoupÚs
 = 
$coupÚ
->
	`g‘_row
(
$cÚd™iÚs
);

218 ià(!
	`is_num”ic
(
$cÚsumed_times
) || $consumed_times < 1)

220  
çl£
;

222 ià(
$cÚsumedCoupÚs
 !=ğ
nuÎ
 && 
$¶©fÜm
 === "juhuasuan")

224  
$coupÚ
->
	`cÚsume_coupÚ
(
$cÚsumedCoupÚs
['id'], 
$cÚsumed_times
);

225 } ià(
$¶©fÜm
 === "juhuasuan")

228 
$Üd”Info
 = 
	`»cÜd_Üd”
(
$coupÚId
, 
$¶©fÜm
, 
$cÚsumed_times
);

231 ifĞ
$Üd”Info
 ==ğ
çl£
)

233  
çl£
;

236 
$š£¹CoupÚ
 = 
	`¬¿y
(

237 "¶©fÜm_key" => 
$Üd”Info
['platform_key'],

238 "·¹Ãr_id" => 
$_SESSION
['partnerId'],

239 "‹am_id" => 
$Üd”Info
['team_id'],

240 "Üd”_id" => 
$Üd”Info
['id'],

242 "cÚsume_time" => 
	`mktime
(),

243 "ü—‹_time" => 
	`mktime
(),

244 "cÚsume_times" => 
$cÚsumed_times
,

245 "¶©fÜm_coupÚ_id" => 
$coupÚId
,

246 "cÚsum”_mobe" => 
$Üd”Info
['consumer_mobile'],

249  
$coupÚ
->
	`š£¹_coupÚ
(
$š£¹CoupÚ
);

251 
	}
}

253 
funùiÚ
 
	$»cÜd_Üd”
(
$coupÚId
,
$¶©fÜm
, 
$cÚsumed_times
 = 1)

256 
$Üd”Info
 = 
	`g‘_Üd”Info
(
$coupÚId
, 
$¶©fÜm
);

257 ià(!
	`is_¬¿y
(
$Üd”Info
è|| 
	`em±y
($orderInfo))

259  
çl£
;

262 
$Üd”Info
['¶©fÜm_key'] = 
$¶©fÜm
;

263 
$Üd”Info
['cÚsume_times'] = 
$cÚsumed_times
;

264 
$Üd”Info
['·¹Ãr_id'] = 
$_SESSION
['partnerId'];

265 
$Üd”Info
['¶©fÜm_coupÚ_id'] = 
$coupÚId
;

267 
$Üd”Id
 = 
$Üd”Info
['platform_order_id'];

268 
$Üd”
 = 
Ãw
 
	`Ord”
();

269 
$cÚd™iÚs
 = 
	`¬¿y
(

270 "¶©fÜm_Üd”_id"=>
$Üd”Id
,

271 "¶©fÜm_key"=>
$¶©fÜm
);

272 
$»cÜdedOrd”
 = 
$Üd”
->
	`g‘_row
(
$cÚd™iÚs
);

274 ià(
$»cÜdedOrd”
 !=ğ
nuÎ
 && 
$¶©fÜm
 === "juhuasuan")

276 
$»cÜdedOrd”
['cÚsum”_mobe'] = 
$Üd”Info
['consumer_mobile'];

277  
$»cÜdedOrd”
;

278 } if(
$¶©fÜm
 === "juhuasuan")

280 
$»cÜdedT—m
 = 
	`»cÜd_‹am_by_Üd”
(
$Üd”Info
);

281 
$Üd”Info
['‹am_id'] = 
$»cÜdedT—m
['id'];

283 
$š£¹Ord”
 = 
	`¬¿y
(

284 "‹am_id" => 
$Üd”Info
['team_id'],

285 "ü—‹_time" => 
	`mktime
(),

286 "¶©fÜm_Üd”_id" => 
$Üd”Info
['platform_order_id'],

287 "¶©fÜm_key" => 
$Üd”Info
['platform_key']

289 
$Üd”In£¹ed
 = 
$Üd”
->
	`š£¹_Üd”
(
$š£¹Ord”
);

290 
$Üd”In£¹ed
['cÚsum”_mobe'] = 
$Üd”Info
['consumer_mobile'];

291  
$Üd”In£¹ed
;

293 
	}
}

296 
funùiÚ
 
	$»cÜd_‹am_by_Üd”
(
$Üd”Info
)

298 
$‹am
 = 
Ãw
 
	`T—m
();

299 ià(
	`is_¬¿y
(
$Üd”Info
è&& !
	`em±y
($orderInfo))

302 
$‹amRow
 = 
$‹am
->
	`g‘_row
(

303 
	`¬¿y
("t™Ë"=>
$Üd”Info
['title'],

304 "¶©fÜm_key"=>
$Üd”Info
['platform_key']));

306 ià(!
	`is_¬¿y
(
$‹amRow
è|| 
	`em±y
($teamRow))

308 
$‹amInfo
 = 
	`¬¿y
(

309 "t™Ë" => 
$Üd”Info
['title'],

310 "¶©fÜm_key" => 
$Üd”Info
['platform_key'],

311 "summ¬y" => 
$Üd”Info
['summary'],

312 "·¹Ãr_id" => 
$Üd”Info
['partner_id'],

313 "‹am_´iû" => 
$Üd”Info
['team_price']

315  
$‹am
->
	`š£¹_‹am
(
$‹amInfo
);

317  
$‹amRow
;

320  
çl£
;

322 
	}
}

325 
funùiÚ
 
	$g‘_Üd”Info
(
$coupÚId
, 
$¶©fÜm
)

327 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

328 
$ÏiquOrd”
 = 
	`¬¿y
();

330 ià(
$¶©fÜm
 === "juhuasuan")

332 
$·¿ms
 = 
	`¬¿y
("mod–.ass™Code" => 
$coupÚId
);

333 
$»¡
->
	`ü—‹Reque¡
("h‰p://59.151.29.121/shİU£d/li¡.do", 'POST', 
$·¿ms
);

334 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

335 
$»q
->
	`addCook›
("JSESSIONID", 
$_SESSION
['JSESSIONID']);

336 
$»¡
->
	`£ndReque¡
();

337 
$»¥Ú£
 = 
$»¡
->
	`g‘Re¥Ú£
();

339 
$»¥Ú£
 = 
	`tidy_ugly_jsÚ
($»¥Ú£,
$¶©fÜm
);

340 
$»suÉ
 = 
	`jsÚ_decode
(
$»¥Ú£
);

342 ià(
$»suÉ
->
sucûss
 ==ğ
çl£
 && $»suÉ->
¡©us
 === 302)

344  
V”ifyCoupÚCodeMsg
::
JUHUASUAN_LOGIN_EXPIRED
;

346 ià(
	`is£t
(
$»suÉ
->
d©a
è&& 
	`couÁ
($result->data) > 0)

348 
$Üd”
 = 
$»suÉ
->
d©a
[0];

349 
$ÏiquOrd”
 = 
	`cÚv”t_Üd”
(
$Üd”
, 
$¶©fÜm
);

350 } ià(
	`is£t
(
$»suÉ
->
d©a
)){

351  
V”ifyCoupÚCodeMsg
::
COUPON_NOT_EXIST
;

355  
$ÏiquOrd”
;

356 
	}
}

359 
funùiÚ
 
	$cÚv”t_Üd”
(
$Üd”Info
, 
$¶©fÜm
)

361 
$Üd”
 = 
	`¬¿y
();

362 ià(
$¶©fÜm
 === "juhuasuan")

364 
$Üd”
['t™Ë'] = 
$Üd”Info
->
´oduù
;

365 
$Üd”
['summ¬y'] = 
$Üd”Info
->
desütiÚ
;

367 
$Üd”
['‹am_´iû'] = 
	`æßtv®
(
	`sub¡r
(
$Üd”Info
->
·ym’t
, 3));

368 
$Üd”
['¶©fÜm_key'] = 
$¶©fÜm
;

369 
$Üd”
['¶©fÜm_Üd”_id'] = 
$Üd”Info
->
obaoId
;

370 
$Üd”
['cÚsum”_mobe'] = 
$Üd”Info
->
»ûiMobe
;

373  
$Üd”
;

375 
	}
}

378 
funùiÚ
 
	$tidy_ugly_jsÚ
(
$uglyJsÚ
, 
$¶©fÜm
)

380 
$b—utifulJsÚ
 = "";

381 ià(
$¶©fÜm
 === "juhuasuan")

384 
$uglyJsÚ
 = 
	`´eg_»¶aû
('/items\s*:\s*\[[^<]+?\]/','', $uglyJson);

385 
$uglyJsÚ
 = 
	`´eg_»¶aû
('/\s*:\s*/',':', $uglyJson);

387 
$uglyJsÚ
 = 
	`´eg_»¶aû_ÿÎback
('/([\{,]\s*)([[\w\d]+)(\s*:)/',"add_double_quote", $uglyJson);

389 
$b—utifulJsÚ
 = 
	`´eg_»¶aû
('/(,\s*)([\}\]])/','${2}',
$uglyJsÚ
);

391 
$b—utifulJsÚ
 = 
	`´eg_»¶aû
("/'(.*)'/",'"${1}"', $beautifulJson);

394  
$b—utifulJsÚ
;

395 
	}
}

396 
funùiÚ
 
	$add_doubË_quÙe
(
$m©ches
)

399  
$m©ches
[1].'"'.$matches[2].'":';

400 
	}
}

403 
funùiÚ
 
	$addCoupÚInfoToV”ifyRe¥Ú£
(
$»¥Ú£
, 
$coupÚId
, 
$¶©fÜm
, 
$cÚsumed_times
)

405 
$»¥Ú£Obj
 = 
	`jsÚ_decode
(
$»¥Ú£
);

406 ià(
$»¥Ú£Obj
->
sucûss
 ==ğ
çl£
)

408  
$»¥Ú£
;

411 
$coupÚ
 = 
Ãw
 
	`CoupÚ
();

412 
$·¿ms
 = 
	`¬¿y
('¶©fÜm_coupÚ_id'=>
$coupÚId
, '¶©fÜm_key'=>
$¶©fÜm
);

413 
$coupÚRow
 = 
$coupÚ
->
	`g‘_row
(
$·¿ms
);

414 ià(
$coupÚRow
 ==ğ
nuÎ
)

416  
$»¥Ú£
;

418 
$»¥Ú£Obj
->
coupÚId
 = 
$coupÚId
;

419 
$»¥Ú£Obj
->
¶©fÜm
 = 
$¶©fÜm
;

420 
$»¥Ú£Obj
->
‹amId
 = 
$coupÚRow
['team_id'];

421 
$»¥Ú£Obj
->
Üd”Id
 = 
$coupÚRow
['order_id'];

422 
$»¥Ú£Obj
->
cÚsum”Mobe
 = 
$coupÚRow
['consumer_mobile'];

423 
$»¥Ú£Obj
->
cÚsumedTimes
 = 
$coupÚRow
['consumedTimes'];

424 
$»¥Ú£Obj
->
d©eTime
 = 
	`¡ráime
('%Y-%m-%d %H:%M:%S',
$coupÚRow
['consume_time']);

426 
$‹am
 = 
Ãw
 
	`T—m
();

427 
$·¿ms
 = 
	`¬¿y
('id'=>
$coupÚRow
['team_id']);

428 
$‹amRow
 = 
$‹am
->
	`g‘_row
(
$·¿ms
);

429 ià(
$coupÚRow
 ==ğ
nuÎ
)

431 
$»¥Ú£Obj
->
‹amT™Ë
 = "æœªçŸ¥é¡¹ç›®";

433 
$»¥Ú£Obj
->
‹amT™Ë
 = 
$‹amRow
['title'];

435  
	`jsÚ_’code
(
$»¥Ú£Obj
);

436 
	}
}

	@verifyCoupon/index.php

1 ï»¿<?
php
 
»quœe_Úû
('../common/checkAuthority.php'); ?>

2 <
html
 
	gxmÊs
="http://www.w3.org/1999/xhtml">

3 <
h—d
>

4 <
t™Ë
>éªŒè¯å¹³å°</title>

5 <
m‘a
 
h‰p
-
equiv
="CÚ‹Á-Ty³" 
cÚ‹Á
="text/html; charset=utf-8">

6 <
lšk
 
h»f
="css/check_css.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

8 <
lšk
 
h»f
="../css/com_css.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

9 <
lšk
 
h»f
="../css/sim¶emod®.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

10 </
h—d
>

11 <
body
>

12 <
süt
 
¤c
="../js/jquery.min.js"></script>

13 <
süt
 
¤c
="../js/jquery.simplemodal.js"></script>

14 <
süt
 
¤c
="../js/common_funcs.js"></script>

15 <
süt
 
¤c
="js/verifyCoupon.js"></script>

17 <
div
 
şass
="maš" 
id
="main">

21 <
div
 
şass
="top_blank">

22 </
div
>

24 <
div
 
şass
="top">

25 <
img
 
¤c
="../images/logo.jpg" />

26 </
div
>

28 <
div
 
şass
="body">

30 <
div
 
şass
="body_l">

31 <
div
 
şass
="nav">

33 <?
php


34 
»quœe
 '../common/templates/left_nav_bar.php';

36 </
	gdiv
>

38 <
div
 
	gşass
="serv">

39 <
div
 
şass
="‹l" 
h»f
="#"> </div>

40 <
a
 
şass
="online_qq"></a>

41 </
div
>

43 </
div
>

45 <
div
 
şass
="body_r" > <!--è¿™é‡Œçš„
body_r
 æ˜¯åŸæ¥çš„
body
 -->

47 <
div
 
şass
="fl fl_1">

48 <
fÜm
 
aùiÚ
="" 
m‘hod
="g‘" 
acû±
-
ch¬£t
="utf-8">

50 <
div
 
şass
="platform_b">

51 <
£Ëù
 
şass
="¶©fÜm" 
Çme
="¶©fÜm" 
id
="platform">

52 <
İtiÚ
 
v®ue
="juhuasuan">èšåˆ’ç®—</option>

53 <
İtiÚ
 
v®ue
="laiqu">æ¥è¶£</option>

54 <!-- <
İtiÚ
 
v®ue
="360buy">äº¬ä¸œ</option> -->

55 </
£Ëù
>

56 </
div
>

58 <
div
 
şass
="coupÚId_b" 
Çme
="coupÚIdW¿µ”" 
id
="couponIdWrapper">

59 <
šput
 
şass
="coupÚId" 
Çme
="coupÚId" 
id
="coupÚId" 
v®ue
="åˆ¸å·"/>

60 </
div
>

62 <
div
 
şass
="coupÚPwd_b" 
Çme
="coupÚPwdW¿µ”" 
id
="couponPwdWrapper">

63 <
šput
 
şass
="coupÚPwd" 
Çme
="coupÚPwd" 
id
="coupÚPwd" 
v®ue
="å¯†ç "/>

64 </
div
>

66 <
div
 
şass
="button">

67 <
a
 
şass
="»£t" 
ty³
="»£t" 
v®ue
="" 
Çme
="»£t" 
id
="»£t" 
h»f
="javascript:void(0);"></a>

68 <
a
 
şass
="subm™" 
ty³
="subm™" 
v®ue
="" 
Çme
="subm™" 
id
="subm™" 
h»f
="javascript:void(0);"></a>

69 </
div
>

70 </
fÜm
>

71 </
div
>

73 <
div
 
şass
="mid">

74 </
div
>

77 <
div
 
şass
="fr fr_1">

79 <
p
 
şass
="‹xt_1"><
b
>éªŒè¯ç»“æœï¼š</b></p>

81 <
div
 
Çme
="imageRe¥Ú£" 
id
="imageRe¥Ú£" 
şass
="imageResponse" ></div>

82 <
div
 
şass
="line"></div>

83 <
p
 
şass
="‹xt_2_3" 
Çme
="msgRe¥Ú£" 
id
="msgResponse">è¯·åœ¨å·¦è¾¹è¾“å…¥æ¡†ä¸­è¾“å…¥ç›¸åº”çš„åˆ¸å·åŠå¯†ç ã€‚</p>

86 </
div
>

89 </
div
>

92 </
div
>

95 <
div
 
şass
="footer">

97 <
div
 
şass
="bottom_1">

98 </
div
>

100 <
div
 
şass
="bottom_line">

102 </
div
>

104 <
p
 
şass
="footer_text">æ¥ è¶£ ç½‘ ç»œ ç§‘ æŠ€ æœ‰ é™ å…¬ å¸</p>

106 </
div
>

108 </
div
>

110 </
body
>

111 </
html
>

	@verifyCoupon/v1000/Exception.php

1 <?
php


18 şas 
	cV”ifyCoupÚ_Exû±iÚ
 
ex‹nds
 
	mPEAR_Exû±iÚ


22 cÚ¡ 
	mCODE_SUCCESS_VERIFY_COUPON
 = 200;

25 cÚ¡ 
	mCODE_FAIL_VERIFY_COUPON
 = 300;

28 cÚ¡ 
	mCODE_ERROR_API_CALL
 = 400;

29 cÚ¡ 
	mCODE_ERROR_PARSE_RESPONSR
 = 401;

30 cÚ¡ 
	mCODE_ERROR_ONLY_SUPPORT_REST
 = 402;

31 cÚ¡ 
	mCODE_ERROR_UNIVERSAL_SERVER
 = 403;

32 cÚ¡ 
	mCODE_ERROR_UNKNOWN
 = 404;

33 cÚ¡ 
	mCODE_ERROR_INVALID_ARG
 = 405;

36 
´iv©e
 
	m$_codeMes§ges
 = 
¬¿y
 (

37 
£lf
::
CODE_SUCCESS_VERIFY_COUPON
 => "éªŒè¯æˆåŠŸ",

38 
£lf
::
CODE_FAIL_VERIFY_COUPON
 => "éªŒè¯å¤±è´¥",

39 
£lf
::
CODE_ERROR_API_CALL
 => "æ¥å£è°ƒç”¨å‡ºé”™",

40 
£lf
::
CODE_ERROR_PARSE_RESPONSE
 => "è§£ææ¥å£è¿”å›å‡ºé”™",

41 
£lf
::
CODE_ERROR_ONLY_SUPPORT_REST
 => "å¹³å°ç›®å‰åªæ”¯æŒRESTfulæ¥å£çš„å¹³å°",

42 
£lf
::
CODE_ERROR_UNIVERSAL_SERVER
 => "éªŒè¯å¹³å°åç«¯é€šç”¨é”™è¯¯",

43 
£lf
::
CODE_ERROR_UNKNOWN
 => "æœªçŸ¥é”™è¯¯",

44 
£lf
::
CODE_ERROR_INVALID_ARG
 => "æ— æ•ˆçš„å‚æ•°"

55 
public
 
funùiÚ
 
	$__cÚ¡ruù
(
$mes§ge
 = 
nuÎ
, 
$code
 =‚ull)

57 ià(
$mes§ge
 !ğ
nuÎ
 && 
$code
 ==‚ull)

59 
Œy
 {

60 
$mes§ge
 = 
£lf
::
	`g‘_mes§ge
(
$code
);

61 
·»Á
::
	`__cÚ¡ruù
(
$mes§ge
, 
$code
);

63 
	`ÿtch
 (
PEAR_Exû±iÚ
 
$´
)

65 
throw
 
$´
;

68 
·»Á
::
	`__cÚ¡ruù
(
$mes§ge
, 
$code
);

81 
public
 
funùiÚ
 
	$g‘_mes§ge
(
$code
 = 
nuÎ
)

83 ià(
$code
 =ğ
nuÎ
)

84  
£lf
::
$_codeMes§ges
;

86 ià(! 
	`is£t
(
£lf
::
$_codeMes§ges
[
$code
]))

87 
throw
 
Ãw
 
	`PEAR_Exû±iÚ
(
£lf
::
	`$_codeMes§ge
(£lf::
CODE_ERROR_INVALID_ARG
),

88 
£lf
::
CODE_ERROR_INVALID_ARG
);

90  
£lf
::
$_codeMes§ges
[
$code
];

91 
	}
}

	@verifyCoupon/v1000/VerifyCoupon.php

1 <?
php


10 şas 
	cV”ifyCoupÚ


14 cÚ¡ 
	mCODE_SUCCESS_VERIFY_COUPON
 = 200;

17 cÚ¡ 
	mCODE_FAIL_VERIFY_COUPON
 = 300;

20 cÚ¡ 
	mCODE_ERROR_API_CALL
 = 400;

21 cÚ¡ 
	mCODE_ERROR_PARSE_RESPONSR
 = 401;

22 cÚ¡ 
	mCODE_ERROR_ONLY_SUPPORT_REST
 = 402;

23 cÚ¡ 
	mCODE_ERROR_UNIVERSAL_SERVER
 = 403;

24 cÚ¡ 
	mCODE_ERROR_UNKNOWN
 = 404;

27 cÚ¡ 
	mTARGET_API
 = 'verifyCoupon';

30 
´iv©e
 
	m$_codeMes§ges
 = 
¬¿y
 (

31 
£lf
::
CODE_SUCCESS_VERIFY_COUPON
 => "éªŒè¯æˆåŠŸ",

32 
£lf
::
CODE_FAIL_VERIFY_COUPON
 => "éªŒè¯å¤±è´¥",

33 
£lf
::
CODE_ERROR_API_CALL
 => "æ¥å£è°ƒç”¨å‡ºé”™",

34 
£lf
::
CODE_ERROR_PARSE_RESPONSE
 => "è§£ææ¥å£è¿”å›å‡ºé”™",

35 
£lf
::
CODE_ERROR_ONLY_SUPPORT_REST
 => "å¹³å°ç›®å‰åªæ”¯æŒRESTfulæ¥å£çš„å¹³å°",

36 
£lf
::
CODE_ERROR_UNIVERSAL_SERVER
 => "éªŒè¯å¹³å°åç«¯é€šç”¨é”™è¯¯",

37 
£lf
::
CODE_ERROR_UNKNOWN
 => "æœªçŸ¥é”™è¯¯");

40 
´iv©e
 
	m$_suµÜtPÏtfÜms
 = 
¬¿y
("laiqu", "360buy");

42 
´iv©e
 
	m$_¶©fÜm
 = '';

43 
´iv©e
 
	m$_»que¡M‘hod
 = '';

44 
´iv©e
 
	m$_h‰pM‘hod
 = '';

45 
´iv©e
 
	m$_»¥Ú£Ty³
 = '';

46 
´iv©e
 
	m$_­iU¾
 = '';

47 
´iv©e
 
	m$_»que¡P¬ams
 = 
¬¿y
();

48 
´iv©e
 
	m$_»que¡P¬amsStic
 = 
¬¿y
();

49 
´iv©e
 
	m$_codeTag
 = '';

50 
´iv©e
 
	m$_codeSucûss
 = '';

63 
public
 
funùiÚ
 
	$š™
(
$¶©fÜm
)

65 iàĞ!
$this
->
	`is_suµÜ‹d
(
$¶©fÜm
) )

66  
çl£
;

67 
$this
->
_¶©fÜm
 = 
$¶©fÜm
;

69 
$cÚfigFeName
 = "¶©fÜm_­i_cÚfs/" . 
$this
->
_¶©fÜm
 . ".conf";

70 
$cÚ‹Á
 = 
	`fe_g‘_cÚ‹Ás
(
$cÚfigFeName
);

71 
$cÚfigs
 = 
	`jsÚ_decode
(
$cÚ‹Á
);

73 ià(!
	`is£t
(
$cÚfigs
))

74  
çl£
;

76 
$this
->
_»que¡M‘hod
 = 
$cÚfigs
->
»que¡M‘hod
;

77 
$this
->
_h‰pM‘hod
 = 
$cÚfigs
->
h‰pM‘hod
;

78 
$this
->
_»¥Ú£Ty³
 = 
$cÚfigs
->
»¥Ú£Ty³
;

79 
$rg‘Api
 = 
£lf
::
TARGET_API
;

80 
$rg‘ApiCÚfs
 = 
$cÚfigs
->
$rg‘Api
;

82 
$this
->
_­iU¾
 = 
$rg‘ApiCÚfs
->
­iU¾
;

83 
$this
->
_»que¡P¬ams
 = 
$rg‘ApiCÚfs
->
»que¡P¬ams
;

84 
$this
->
_»que¡P¬amsStic
 = 
$rg‘ApiCÚfs
->
»que¡P¬amsStic
;

85 
$this
->
_codeTag
 = 
$rg‘ApiCÚfs
->
»¥Ú£ResuÉ
->
codeTag
;

86 
$this
->
_codeSucûss
 = 
$rg‘ApiCÚfs
->
»¥Ú£ResuÉStic
->
codeSucûss
;

88  
Œue
;

100 
public
 
funùiÚ
 
	$is_suµÜ‹d
(
$¶©fÜm
)

102 ià(
$¶©fÜm
 == '')

103  
çl£
;

104 
	`fÜ—ch
 (
$this
->
_suµÜtPÏtfÜms
 
as
 
$suµÜt
)

106 ià(
$¶©fÜm
 =ğ
$suµÜt
)

107  
Œue
;

110  
çl£
;

111 
	}
}

123 
public
 
funùiÚ
 
	$š™_v”ifyIÅuts
(
$»que¡
)

125 ià(!
	`is£t
(
$»que¡
['couponId']) || $request['couponId'] == '')

126  
çl£
;

127 
$šputs
['coupÚId'] = 
$»que¡
['couponId'];

129 ià(
	`is£t
(
$this
->
_»que¡P¬ams
->
coupÚPwd
))

131 ià(
$»que¡
['couponPwd'] == '')

132  
çl£
;

134 
$šputs
['coupÚPwd'] = 
$»que¡
['couponPwd'];

137  
$šputs
;

138 
	}
}

149 
public
 
funùiÚ
 
	$g‘_»¥Ú£Code
(
$»¥Ú£
)

151 
$»¥Ú£Code
 = "";

152 ià(
$»¥Ú£
 =ğ"" || 
$this
->
_»¥Ú£Ty³
 == "" ||

153 
$this
->
_codeTag
 =ğ"" || $this->
_codeSucûss
 == "")

154  
£lf
::
CODE_ERROR_PARSE_RESPONSE
;

156 ià(
$this
->
_»¥Ú£Ty³
 == "LAIQU")

158 
	`´eg_m©ch_®l
("/(<([\w]+)[^>]*>)(.*?)(<\/\\2>)/", 
$»¥Ú£
, 
$m©ches
, 
PREG_SET_ORDER
);

159 
	`fÜ—ch
 (
$m©ches
 
as
 
$v®
) {

160 ià(
$v®
[2] =ğ
$this
->
_codeTag
)

162 
$»¥Ú£Code
 = 
$v®
[3];

165 } ià(
$this
->
_»¥Ú£Ty³
 == "XML")

167 
$xmlRe¥Ú£
 = 
	`sim¶exml_lßd_¡ršg
(
$»¥Ú£
);

168 
$»¥Ú£Code
 = 
$xmlRe¥Ú£
->
$code
;

171 ià(
$»¥Ú£Code
 == '')

172  
£lf
::
CODE_ERROR_PARSE_RESPONSE
;

174  
$»¥Ú£Code
 =ğ
$this
->
_codeSucûss
 ? 
£lf
::
CODE_SUCCESS_VERIFY_COUPON
 : s–f::
CODE_FAIL_VERIFY_COUPON
;

175 
	}
}

186 
public
 
funùiÚ
 
	$g‘_»que¡P¬ams
(
$šputs
)

188 
$·¿ms
 = 
	`¬¿y
();

189 
	`fÜ—ch
 (
$this
->
_»que¡P¬ams
 
as
 
$key
 => 
$v®ue
)

192 
$·¿ms
[
$v®ue
] = 
$šputs
[
$key
];

194 ià(
$this
->
_»que¡P¬amsStic
 !ğ
nuÎ
)

197 
	`fÜ—ch
 (
$this
->
_»que¡P¬amsStic
 
as
 
$key
 => 
$v®ue
)

199 
$·¿ms
[
$key
] = 
$v®ue
;

202  
$·¿ms
;

203 
	}
}

214 
public
 
funùiÚ
 
	$g’_»¥Ú£_jsÚ
(
$»suÉ
)

216 ià(!
$»suÉ
 || 
£lf
::
$_codeMes§ges
[$result] == '')

217  
çl£
;

219 
$»¥Ú£
['code'] = 
$»suÉ
;

220 
$»¥Ú£
['msg'] = 
£lf
::
$_codeMes§ges
[
$»suÉ
];

221 
$»¥Ú£
['d©eTime'] = 
	`d©e
("Y-m-d, h:i:s");

223  
	`jsÚ_’code
(
$»¥Ú£
);

224 
	}
}

234 
public
 
funùiÚ
 
	$g‘_mes§ge
(
$code
 = 
nuÎ
)

236 ià(
$code
 =ğ
nuÎ
)

237  
£lf
::
$_codeMes§ges
;

239  
	`is£t
(
£lf
::
$_codeMes§ges
[
$code
]è? s–f::$_codeMes§ges[$code] : 
nuÎ
;

240 
	}
}

244 
public
 
funùiÚ
 
	$g‘_¶©fÜm
()

246  
$this
->
_¶©fÜm
;

247 
	}
}

251 
public
 
funùiÚ
 
	$g‘_»que¡M‘hod
()

253  
$this
->
_»que¡M‘hod
;

254 
	}
}

258 
public
 
funùiÚ
 
	$g‘_h‰pM‘hod
()

260  
$this
->
_h‰pM‘hod
;

261 
	}
}

265 
public
 
funùiÚ
 
	$g‘_»¥Ú£Ty³
()

267  
$this
->
_»¥Ú£Ty³
;

268 
	}
}

272 
public
 
funùiÚ
 
	$g‘_­iU¾
()

274  
$this
->
_­iU¾
;

275 
	}
}

279 
public
 
funùiÚ
 
	$g‘_codeTag
()

281  
$this
->
_codeTag
;

282 
	}
}

286 
public
 
funùiÚ
 
	$g‘_codeSucûss
()

288  
$this
->
_codeSucûss
;

289 
	}
}

	@verifyCoupon/v1000/doVerifyCoupon.php

1 <?
php


2 
	g»quœe_Úû
 'RESTclient.php';

3 
	g»quœe_Úû
 'VerifyCoupon.php';

5 
	g$¶©fÜm
 = 
$_REQUEST
['platform'];

6 
	g$v”ifyCoupÚ
 = 
Ãw
 
V”ifyCoupÚ
();

8 if(!
	g$v”ifyCoupÚ
->
	$š™
(
$¶©fÜm
))

10 
	`d›
(
V”ifyCoupÚ
::
	`g’_»¥Ú£_jsÚ
(V”ifyCoupÚ::
CODE_ERROR_UNIVERSAL_SERVER
));

11 
	}
}

13 
	g$šputs
 = 
$v”ifyCoupÚ
->
š™_v”ifyIÅuts
(
$_REQUEST
);

15 
	g$»¡
 = 
Ãw
 
RESTş›Á
();

17 
	g$·¿ms
 = 
$v”ifyCoupÚ
->
g‘_»que¡P¬ams
(
$šputs
);

19 ià(
	g$v”ifyCoupÚ
->
g‘_h‰pM‘hod
() == 'POST') {

20 
$»¡
->
ü—‹Reque¡
(
$v”ifyCoupÚ
->
g‘_­iU¾
(), 'POST', 
$·¿ms
);

22 
	g$»¡
->
ü—‹Reque¡
(
$v”ifyCoupÚ
->
g‘_­iU¾
());

23 
	g$u¾
 = 
$»¡
->
g‘U¾
();

24 
	g$u¾
->
£tQu”yV¬ŸbËs
(
$·¿ms
);

26 
	g$»¡
->
£ndReque¡
();

27 
	g$»¥Ú£
 = 
$»¡
->
g‘Re¥Ú£
();

28 
	g$»suÉ
 = 
$v”ifyCoupÚ
->
g‘_»¥Ú£Code
(
$»¥Ú£
);

30 
echo
 
	gV”ifyCoupÚ
::
g’_»¥Ú£_jsÚ
(
$»suÉ
);

	@verifyLogin/VerifyLogin.php

1 <?
php


15 
»quœe_Úû
('../common/CodeMessages.php');

16 
»quœe_Úû
('../common/Exception.php');

17 
»quœe_Úû
('../verifyCoupon/functions.php');

18 
»quœe_Úû
('../common/class/MyTable.php');

20 şas 
	cV”ifyLogš


22 cÚ¡ 
	mUSERTABLE
 = 'partner';

24 
´iv©e
 
	m$_mysql
 = 
nuÎ
;

32 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

34 
$this
->
_mysql
 = 
Ãw
 
	`MyTabË
();

38 
public
 
funùiÚ
 
	$g‘_mysql
()

40  
$this
->
_mysql
;

41 
	}
}

51 
public
 
funùiÚ
 
	$v”ify_logš
(
$u£ºame
, 
$·sswÜd
)

53 
$u£r
 = 
	`mysql_»®_esÿ³_¡ršg
(
$u£ºame
);

54 
$·ss
 = 
	`mysql_»®_esÿ³_¡ršg
(
$·sswÜd
);

55 ià(
	`em±y
(
$u£r
è||ƒm±y(
$·ss
) )

57 
throw
 
Ãw
 
	`Exû±iÚ
(

58 
V”ifyLogšCodeMsg
::
	`g‘_mes§ge
(V”ifyLogšCodeMsg::
INVALID_NAME_PASS
),

59 
V”ifyLogšCodeMsg
::
INVALID_NAME_PASS


62 
$·ss
 = 
$this
->
	`üy±_·ss
($pass);

63 
$qu”y
 = 
	`¥rštf
("SELECT * FROM %s WHERE username='%s' AND…assword='%s' LIMIT 1",

64 
£lf
::
USERTABLE
, 
$u£r
, 
$·ss
);

66 
$»suÉ
 = 
	`mysql_qu”y
(
$qu”y
);

68 ià(
	`mysql_num_rows
(
$»suÉ
) == 1)

70 
$row
 = 
	`mysql_ãtch_¬¿y
(
$»suÉ
);

71 
	`£ssiÚ_¡¬t
();

72 
$·¹ÃrId
 = 
$row
['id'];

73 
$_SESSION
['·¹ÃrId'] = 
$·¹ÃrId
;

74 
$_SESSION
['u£ºame'] = 
$row
['username'];

75 
$_SESSION
['t™Ë'] = 
$row
['title'];

78 
$this
->
	`do_logšPÏtfÜm
(
$·¹ÃrId
);

80 
throw
 
Ãw
 
	`Exû±iÚ
(

81 
V”ifyLogšCodeMsg
::
	`g‘_mes§ge
(V”ifyLogšCodeMsg::
ERROR_NAME_PASS
),

82 
V”ifyLogšCodeMsg
::
ERROR_NAME_PASS
);

84 
	}
}

87 
´iv©e
 
funùiÚ
 
	$do_logšPÏtfÜm
(
$·¹ÃrId
)

89 
$qu”y
 = 
	`¥rštf
("SELECT * FROM %s WHERE…artner_id=%s AND status=1",

90 '·¹Ãr_¶©fÜms', 
$·¹ÃrId
);

91 
$»suÉ
 = 
	`mysql_qu”y
(
$qu”y
);

92 
$row
 = 
	`mysql_ãtch_¬¿y
(
$»suÉ
))

94 ià(
$row
['platform_key'] === 'juhuasuan')

97 
$ŒyTimes
 = 10;

98 
$couÁ
 = 0;

99 !
	`logš_¶©fÜm
('juhuasuan'))

101 ià(++
$couÁ
 === 10 ) ;

105 
	}
}

114 
´iv©e
 
funùiÚ
 
	$üy±_·ss
(
$·ss
)

116 ià(
	`em±y
(
$·ss
))

117  
çl£
;

118 
$§É
 = 
	`sub¡r
(
	`md5
(
$·ss
), 0, 2);

119  
	`md5
(
	`üy±
(
$·ss
, 
$§É
));

120 
	}
}

137 
public
 
funùiÚ
 
	$g’_»¥Ú£_jsÚ
(
$code
)

140 
$msg
 = 
V”ifyLogšCodeMsg
::
	`g‘_mes§ge
(
$code
);

143 ià(
	`em±y
(
$msg
))

145 
$code
 = 
CommÚCodeMsg
::
INVALID_ARGUMENT_ERROR
;

146 
$msg
 = 
CommÚCodeMsg
::
	`g‘_mes§ge
(
$code
);

149 ià(
$code
 ==ğ
V”ifyLogšCodeMsg
::
VERIFY_LOGIN_SUCCESS
)

151 
$»¥Ú£
['sucûss'] = 
Œue
;

154 
$»¥Ú£
['sucûss'] = 
çl£
;

156 
$»¥Ú£
['code'] = 
$code
;

157 
$»¥Ú£
['msg'] = 
$msg
;

158 
$»¥Ú£
['d©eTime'] = 
	`d©e
("Y-m-d, h:i:s");

160  
	`jsÚ_’code
(
$»¥Ú£
);

161 
	}
}

	@verifyLogin/doVerifyLogin.php

1 <?
php


11 
»quœe_Úû
('VerifyLogin.php');

13 
funùiÚ
 
	$ruÁimeE¼ÜHªdËr
(
$”ºo
, 
$”r¡r
, 
$”rfe
, 
$”¾še
)

16 
$code
 = 
CommÚCodeMsg
::
SYSTEM_RUNTIME_ERROR
;

18 
	`”rÜ_log
(
$”r¡r
);

19 
	`d›
(
V”ifyLogš
::
	`g’_»¥Ú£_jsÚ
(
$code
));

21 
	}
}

22 
funùiÚ
 
	$exû±iÚHªdËr
(
$exû±iÚ
)

24 
$code
 = 
$exû±iÚ
->
	`g‘Code
();

25 
$v”ifyMsg
 = 
V”ifyLogšCodeMsg
::
	`g‘_mes§ge
(
$code
);

26 ià(
	`em±y
(
$v”ifyMsg
))

28 
$code
 = 
CommÚCodeMsg
::
UNCAUGHT_FATAL_ERROR
;

29 
$”r¡r
 = 
$exû±iÚ
->
	`g‘Mes§ge
();

31 
	`”rÜ_log
(
$”r¡r
);

33 
	`d›
(
V”ifyLogš
::
	`g’_»¥Ú£_jsÚ
(
$code
));

34 
	}
}

35 
£t_”rÜ_hªdËr
('ruÁimeE¼ÜHªdËr', 
E_ERROR
);

36 
£t_exû±iÚ_hªdËr
('exceptionHandler');

38 
	g$u£ºame
 = 
$_POST
['username'];

39 
	g$·sswÜd
 = 
$_POST
['password'];

41 
	g$v”ifyLogš
 = 
Ãw
 
V”ifyLogš
();

42 
	g$v”ifyLogš
->
v”ify_logš
(
$u£ºame
, 
$·sswÜd
);

43 
echo
 
	gV”ifyLogš
::
g’_»¥Ú£_jsÚ
(
V”ifyLogšCodeMsg
::
VERIFY_LOGIN_SUCCESS
);

	@verifyLogin/loginOut.php

1 <?
php


11 
»quœe_Úû
('../common/common.php');

13 
£ssiÚ_¡¬t
();

14 ià(
is£t
(
$_SESSION
['partnerId']))

16 
un£t
(
$_SESSION
['partnerId']);

17 
un£t
(
$_SESSION
['username']);

18 
un£t
(
$_SESSION
['title']);

20 ià(
is£t
(
$_SESSION
['JSESSIONID']))

21 
un£t
(
$_SESSION
['JSESSIONID']);

24 
»dœeù
('login.html');

	@
1
.
0
54
1402
acctManager/changePass.php
acctManager/do_changePass.php
admin/add-partner.php
admin/bind-partner-platform.php
admin/bindPartnerPlatform.php
admin/common.php
admin/doAddPartner.php
admin/index.php
common/CodeMessages.php
common/Exception.php
common/RESTclient.php
common/checkAuthority.php
common/class/Database.php
common/class/MyTable.php
common/class/Valite.php
common/class/ceshi/Valite.php
common/class/ceshi/myValidate.php
common/class/ceshi/test.php
common/common.php
common/constants.php
common/functions/common.funcs.php
common/include/errorCatcher.php
common/templates/left_nav_bar.php
common/utilities.php
cpapi/constants.php
cpapi/cp_init.php
cpapi/functions.php
cpapi/telapi.php
index.php
module/Coupon.php
module/Order.php
module/Partner.php
module/PartnerPlatforms.php
module/Team.php
old_trial/CommonDefine.php
old_trial/VerifyCoupon.php
old_trial/VerifyCoupon_laiqu.php
old_trial/VerifyFunction_def.php
old_trial/soapAndRest_sp.php
old_trial/test_360buyRest.php
old_trial/test_RestClient.php
statistics/consumedCoupons.php
statistics/teamList.php
verifyCoupon/VerifyCoupon.php
verifyCoupon/VerifyCoupon_funcs.php
verifyCoupon/doVerifyCoupon.php
verifyCoupon/functions.php
verifyCoupon/index.php
verifyCoupon/v1000/Exception.php
verifyCoupon/v1000/VerifyCoupon.php
verifyCoupon/v1000/doVerifyCoupon.php
verifyLogin/VerifyLogin.php
verifyLogin/doVerifyLogin.php
verifyLogin/loginOut.php
