cscope 15 $HOME/work/host/laiqu/module -q 0000000114 0000010800
	@Coupon.php

1 <?
php


11 
»quœe_Úû
('../common/class/MyTable.php');

12 
»quœe_Úû
('../common/Exception.php');

13 
»quœe_Úû
('../common/CodeMessages.php');

15 þas 
	cCoupÚ
 
ex‹nds
 
	mMyTabË


18 cÚ¡ 
	mCOUPON_TABLE
 = 'coupon';

19 cÚ¡ 
	mTEAM_TABLE
 = 'team';

20 cÚ¡ 
	mORDER_TABLE
 = 'order';

21 cÚ¡ 
	mUSER_TABLE
 = 'user';

29 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

31 
·»Á
::
	`__cÚ¡ruù
(
£lf
::
COUPON_TABLE
);

43 
public
 
funùiÚ
 
	$g‘_cÚsumedCoupÚs
(
$£¬chF›lds
, 
$¡¬t
, 
$off£t
)

45 ià(
$¡¬t
 < 0) $start = 0;

46 ià(
$off£t
 <= 0) $offset = 6;

48 
$sql
 = 
$this
->
	`g’_coupÚS—rchSql
(
$£¬chF›lds
, 
$¡¬t
, 
$off£t
);

50 
$»suÉ
 = 
	`mysql_qu”y
(
$sql
);

51 ià(
	`mysql_num_rows
(
$»suÉ
) < 1)

52  
	`¬¿y
();

54  
$this
->
	`·r£_coupÚLi¡
(
$»suÉ
);

55 
	}
}

64 
public
 
funùiÚ
 
	$g‘_cÚsumedCoupÚtimes
(
$£¬chF›lds
)

66 
$this
->
	`assu»_dbCÚÃùiÚ
();

67 
$sql
 = 
$this
->
	`g’_coupÚS—rchSql
(
$£¬chF›lds
);

69 
$cÚsumedtimes
 = 0;

70 
$»suÉ
 = 
	`mysql_qu”y
(
$sql
);

71 
$coupÚRow
 = 
	`mysql_ãtch_assoc
(
$»suÉ
))

73 
$cÚsumedtimes
 +ð
$coupÚRow
['consume_times'];

75  
$cÚsumedtimes
;

76 
	}
}

78 
´iv©e
 
funùiÚ
 
g’_coupÚS—rchSql
(
$£¬chF›lds
, 
$¡¬t
 = 0, 
$off£t
 = -1)

80 
fÜ—ch
 (
$£¬chF›lds
 
as
 
$f›ldKey
 => 
$f›ldV®ue
)

82 
$$f›ldKey
 = 
is_¡ršg
(
$f›ldV®ue
)?
mysql_»®_esÿ³_¡ršg
($fieldValue): $fieldValue;

85 ià(
	g$¡¬t
 < 0) $start = 0;

86 ià(
	g$off£t
 <ð0è
$off£t
 = 6;

88 
	g$£Ëù
 = "select c.order_id‡s orderId,.title‡seamTitle, c.id‡s couponId,";

89 
	g$£Ëù
 .= "u.username‡s username, u.email‡sƒmail, o.subbranch‡s subbranch, c.consume_time‡s consumeTime,c.consume_times‡s consumeTimes,c.platform_coupon_id‡s…latformCouponId,c.consumer_mobile‡s consumerMobile";

90 
	g$£Ëù
 .ð' from '.
£lf
::
DBDATABASE
.'.'.£lf::
TEAM_TABLE
.','.£lf::DBDATABASE.'.'.£lf::
ORDER_TABLE
.' o,';

91 
	g$£Ëù
 .ð
£lf
::
DBDATABASE
.'.'.£lf::
COUPON_TABLE
.' c†eá još '.£lf::DBDATABASE.'.'.£lf::
USER_TABLE
.' u on c.user_id=u.id';

92 
	g$sql
 = 
$£Ëù
." WHERE c.consume='Y' ";

93 ià(
couÁ
(
£¬chF–ds
) > 0)

95 ià(
	g$·¹ÃrId
 > 0)

96 
	g$sql
 .= " AND c.partner_id=$partnerId";

97 ià(
	g$‹amId
 > 0)

98 
	g$sql
 .= " AND c.team_id=$teamId ";

99 ià(!
em±y
(
$¶©fÜm
))

100 
	g$sql
 .= " AND c.platform_key='$platform'";

101 ià(
	g$Üd”Id
 > 0)

102 
	g$sql
 .= " AND c.order_id=$orderId";

103 ià(
	g$coupÚId
 > 0)

104 
	g$sql
 .= " AND c.platform_coupon_id=$couponId";

105 ià(!
em±y
(
$mobže
))

106 
	g$sql
 .= " AND c.consumer_mobile='$mobile'";

108 
	g$sql
 .= " AND.id=c.team_id AND o.id=c.order_id ";

110 
	g$sql
 .= " order by c.consume_time desc";

111 ià(
	g$¡¬t
 >= 0) {

112 
$sql
 .= " LIMIT $start";

113 ià(
	g$off£t
 > 
	g$¡¬t
)

114 
	g$sql
 .= ",$offset";

117  
	g$sql
;

127 
public
 
funùiÚ
 
	$g‘_cÚsumedCoupÚNums
(
$£¬chF›lds
)

129 
$this
->
	`assu»_dbCÚÃùiÚ
();

130 
$sql
 = 
$this
->
	`g’_coupÚS—rchSql
(
$£¬chF›lds
);

132 
$coupÚNums
 = 0;

133 
$»suÉ
 = 
	`mysql_qu”y
(
$sql
);

134 
$coupÚNums
 = 
	`mysql_num_rows
(
$»suÉ
);

140  
$coupÚNums
;

141 
	}
}

149 
public
 
funùiÚ
 
	$cÚsume_coupÚ
(
$coupÚId
, 
$cÚsumed_times
 = 1)

151 ià(
$coupÚId
 <ð0 || !
	`is_num”ic
(
$cÚsumed_times
) || $consumed_times < 1)

153 
throw
 
Ãw
 
	`V”ifyCoupÚ_Exû±iÚ
(

154 
CommÚCodeMsg
::
	`g‘_mes§ge
(CommÚCodeMsg::
INVALID_ARGUMENT_ERROR
),

155 
CommÚCodeMsg
::
INVALID_ARGUMENT_ERROR
);

158 
$upd©e
 = 'UPDATE '.
$this
->
	`g‘_dbTabËName
(
£lf
::
COUPON_TABLE
);

159 
$upd©e
 .ð" s‘ cÚsume='Y',cÚsume_time=UNIX_TIMESTAMP(),cÚsume_times=cÚsume_times+".
$cÚsumed_times
;

160 
$wh”e
 = " WHERE id=".
$coupÚId
;

161 
$sql
 = 
$upd©e
.
$wh”e
;

163  
	`mysql_qu”y
(
$sql
);

164 
	}
}

172 
´iv©e
 
funùiÚ
 
	$·r£_coupÚLi¡
(
$»suÉ
)

174 
$cÚsumedCoupÚLi¡
 = 
	`¬¿y
();

175 
$coupÚNums
 = 
	`mysql_num_rows
(
$»suÉ
);

176 ià(
$coupÚNums
 > 0)

178 
$cÚsumedCoupÚ
 = 
	`mysql_ãtch_¬¿y
(
$»suÉ
))

180 
	`¬¿y_push
(
$cÚsumedCoupÚLi¡
, 
$cÚsumedCoupÚ
);

183  
$cÚsumedCoupÚLi¡
;

184 
	}
}

193 
public
 
funùiÚ
 
	$š£¹_coupÚ
(
$coupÚInfo
)

195 
$this
->
	`assu»_dbCÚÃùiÚ
();

196 
$š£¹Sql
 = "INSERT INTO ".
$this
->
	`g‘_dbTabËName
(
£lf
::
COUPON_TABLE
);

197 
$keys
 = "(";

198 
$v®ues
 = " VALUES(";

199 
	`fÜ—ch
(
$coupÚInfo
 
as
 
$key
 => 
$v®ue
)

201 
$keys
 .ð
$key
 . ",";

203 ià(
	`is_¡ršg
(
$v®ues
))

205 
$v®ues
 .ð"'" . 
$v®ue
 . "'" . ",";

209 
$v®ues
 .ð
$v®ue
. ",";

214 
$keys
 = 
	`sub¡r
($keys, 0, -1) . ")";

215 
$v®ues
 = 
	`sub¡r
($values, 0, -1) . ")";

217 
$š£¹Sql
 .ð
$keys
 . 
$v®ues
;

218 
$»suÉ
 = 
	`mysql_qu”y
(
$š£¹Sql
);

219 ià(!
$»suÉ
) {

220  
nuÎ
;

222 
$š£¹edcoupÚId
 = 
	`mysql_š£¹_id
();

223 
$coupÚInfo
['id'] = 
$š£¹edcoupÚId
;

225  
$coupÚInfo
;

226 
	}
}

	@Order.php

1 <?
php


11 
»quœe_Úû
('../common/class/MyTable.php');

12 
»quœe_Úû
('../common/Exception.php');

13 
»quœe_Úû
('../common/CodeMessages.php');

15 þas 
	cOrd”
 
ex‹nds
 
	mMyTabË


18 cÚ¡ 
	mCOUPON_TABLE
 = 'coupon';

19 cÚ¡ 
	mTEAM_TABLE
 = 'team';

20 cÚ¡ 
	mORDER_TABLE
 = 'order';

21 cÚ¡ 
	mUSER_TABLE
 = 'user';

29 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

31 
·»Á
::
	`__cÚ¡ruù
(
£lf
::
ORDER_TABLE
);

41 
public
 
funùiÚ
 
	$š£¹_Üd”
(
$Üd”Info
)

43 
$this
->
	`assu»_dbCÚÃùiÚ
();

44 
$š£¹Sql
 = "INSERT INTO ".
$this
->
	`g‘_dbTabËName
(
£lf
::
ORDER_TABLE
);

45 
$keys
 = "(";

46 
$v®ues
 = " VALUES(";

47 
	`fÜ—ch
(
$Üd”Info
 
as
 
$key
 => 
$v®ue
)

49 
$keys
 .ð
$key
 . ",";

51 ià(
	`is_¡ršg
(
$v®ues
))

53 
$v®ues
 .ð"'" . 
$v®ue
 . "'" . ",";

57 
$v®ues
 .ð
$v®ue
. ",";

63 
$keys
 = 
	`sub¡r
($keys, 0, -1) . ")";

64 
$v®ues
 = 
	`sub¡r
($values, 0, -1) . ")";

66 
$š£¹Sql
 .ð
$keys
 . 
$v®ues
;

67 
$»suÉ
 = 
	`mysql_qu”y
(
$š£¹Sql
);

68 ià(!
$»suÉ
) {

69  
nuÎ
;

71 
$š£¹edOrd”Id
 = 
	`mysql_š£¹_id
();

72 
$Üd”Info
['id'] = 
$š£¹edOrd”Id
;

74  
$Üd”Info
;

75 
	}
}

	@Partner.php

1 <?
php


11 
»quœe_Úû
('../common/Exception.php');

12 
»quœe_Úû
('../common/class/MyTable.php');

13 
»quœe_Úû
('../common/common.php');

15 þas 
	cP¬Š”
 
ex‹nds
 
	mMyTabË


18 cÚ¡ 
	mPARTNER_TABLE
 = 'partner';

23 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

25 
·»Á
::
	`__cÚ¡ruù
();

35 
public
 
funùiÚ
 
	$chªgePass
(
$·¹ÃrId
, 
$ÜigšPasswd
, 
$ÃwPasswd
)

37 
$this
->
	`assu»_dbCÚÃùiÚ
();

38 
$ÜigšPasswd
 = 
	`mysql_»®_esÿ³_¡ršg
($originPasswd);

39 
$ÃwPasswd
 = 
	`mysql_»®_esÿ³_¡ršg
($newPasswd);

40 ià(
	`¡¾’
(
$ÃwPasswd
) < 6 || strlen($newPasswd) > 16)

42 
throw
 
Ãw
 
	`Exû±iÚ
(

43 
ChªgePassCodeMsg
::
	`g‘_mes§ge
(ChªgePassCodeMsg::
NEW_PASS_NOT_ALLOWED_ERROR
),

44 
ChªgePassCodeMsg
::
NEW_PASS_NOT_ALLOWED_ERROR
);

46 ià(!
	`em±y
(
$ÜigšPasswd
))

48 
$ÜigšPasswd
 = 
	`üy±_·ss
($originPasswd);

49 
$£ËùSql
 = "SELECT * FROM ".
$this
->
	`g‘_dbTabËName
(
£lf
::
PARTNER_TABLE
)." WHERE id=".
$·¹ÃrId
.

50 " AND…asswÜd='".
$ÜigšPasswd
."'";

51 
$»suÉ
 = 
	`mysql_qu”y
(
$£ËùSql
);

52 ià(
$»suÉ
 && 
	`mysql_num_rows
($result) == 1)

54 
$upd©eSql
 = "UPDATE ".
$this
->
	`g‘_dbTabËName
(
£lf
::
PARTNER_TABLE
)." SET";

55 
$upd©eSql
 .ð"…asswÜd='".
	`üy±_·ss
(
$ÃwPasswd
)."'"." WHERE id=".
$·¹ÃrId
;

56  
	`mysql_qu”y
(
$upd©eSql
)? 
LQ_OK
: 
LQ_FAIL
;

60 
throw
 
Ãw
 
	`Exû±iÚ
(

61 
ChªgePassCodeMsg
::
	`g‘_mes§ge
(ChªgePassCodeMsg::
ORIGIN_PASS_NOT_MATCH
),

62 
ChªgePassCodeMsg
::
ORIGIN_PASS_NOT_MATCH
);

63 
	}
}

	@PartnerPlatforms.php

1 <?
php


11 
»quœe_Úû
('../common/Exception.php');

12 
»quœe_Úû
('../common/class/MyTable.php');

13 
»quœe_Úû
('../common/common.php');

15 þas 
	cP¬Š”PÏtfÜms
 
ex‹nds
 
	mMyTabË


18 cÚ¡ 
	mPARTNET_PLATFORMS_TABLE
 = 'partner_platforms';

23 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

25 
·»Á
::
	`__cÚ¡ruù
(
£lf
::
PARTNET_PLATFORMS_TABLE
);

28 
	}
}

	@Team.php

1 <?
php


11 
»quœe_Úû
('../common/class/MyTable.php');

13 þas 
	cT—m
 
ex‹nds
 
	mMyTabË


16 cÚ¡ 
	mTEAM_TABLE
 = 'team';

17 cÚ¡ 
	mPLATFORM_TABLE
 = 'platform';

25 
public
 
funùiÚ
 
	$__cÚ¡ruù
()

27 
·»Á
::
	`__cÚ¡ruù
(
£lf
::
TEAM_TABLE
);

36 
public
 
funùiÚ
 
	$g‘_‹ams
(
$£¬chF›lds
, 
$¡¬t
, 
$off£t
)

38 
	`fÜ—ch
 (
$£¬chF›lds
 
as
 
$f›ldKey
 => 
$f›ldV®ue
)

40 
$$f›ldKey
 = 
	`is_¡ršg
(
$f›ldV®ue
)?
	`mysql_»®_esÿ³_¡ršg
($fieldValue): $fieldValue;

43 ià(
$·¹ÃrId
 <= 0)

45 
throw
 
Ãw
 
	`Exû±iÚ
(

46 
CommÚCodeMsg
::
	`g‘_mes§ge
(CommÚCodeMsg::
INVALID_ARGUMENT_ERROR
),

47 
CommÚCodeMsg
::
INVALID_ARGUEMENT
);

49 ià(
$¡¬t
 < 0) $start = 0;

50 ià(
$off£t
 <= 0) $offset = 4;

52 
$£Ëù
 = "select.id‡seamId,.title‡seamTitle,….title‡s…latformTitle,.begin_time‡s beginTime,";

53 
$£Ëù
 .= "t.end_time‡sƒndTime,.now_num‡s‚owNum,.min_num‡s minNum,.team_price‡seamPrice,";

54 
$£Ëù
 .= "t.market_price‡s marketPrice,.platform_key‡s…latformKey,";

55 
$£Ëù
 .= "t.expire_time‡sƒxpireTime,.state";

56 
$£Ëù
 .ð' from '.
£lf
::
DBDATABASE
.'.'.£lf::
TEAM_TABLE
.','.£lf::DBDATABASE.'.'.£lf::
PLATFORM_TABLE
.'…';

57 
$sql
 = 
$£Ëù
." WHERE.partner_id=$partnerId AND.platform_key=p.key ";

58 
$sql
 .= "order by.state desc,t.expire_time desc,t.id desc ";

59 
$sql
 .= "LIMIT $start,$offset ";

61 
$»suÉ
 = 
	`mysql_qu”y
(
$sql
);

62 ià(
	`mysql_num_rows
(
$»suÉ
) < 1)

63  
	`¬¿y
();

65  
$this
->
	`·r£_‹amLi¡
(
$»suÉ
);

66 
	}
}

75 
public
 
funùiÚ
 
	$g‘_‹amNums
(
$£¬chF›lds
)

77 
$this
->
	`assu»_dbCÚÃùiÚ
();

78 
	`fÜ—ch
 (
$£¬chF›lds
 
as
 
$f›ldKey
 => 
$f›ldV®ue
)

80 
$$f›ldKey
 = 
	`is_¡ršg
(
$f›ldV®ue
)?
	`mysql_»®_esÿ³_¡ršg
($fieldValue): $fieldValue;

83 
$sql
 = "SELECT couÁ(*èa ‹amNum FROM ".
$this
->
	`g‘_dbTabËName
(
£lf
::
TEAM_TABLE
);

84 
$sql
 .= " WHERE…artner_id=$partnerId";

86 
$‹amNums
 = 0;

87 
$»suÉ
 = 
	`mysql_qu”y
(
$sql
);

88 ià(
	`is_»sourû
(
$»suÉ
è&& 
	`mysql_num_rows
($result) > 0)

90 
$‹amRow
 = 
	`mysql_ãtch_¬¿y
(
$»suÉ
);

91 
$‹amNums
 = 
$‹amRow
['teamNums'];

94  
$‹amNums
;

95 
	}
}

103 
´iv©e
 
funùiÚ
 
	$·r£_‹amLi¡
(
$»suÉ
)

105 
$‹amLi¡
 = 
	`¬¿y
();

106 
$‹amNums
 = 
	`mysql_num_rows
(
$»suÉ
);

107 ià(
$‹amNums
 > 0)

109 
$‹am
ð
	`mysql_ãtch_¬¿y
(
$»suÉ
))

111 
	`¬¿y_push
(
$‹amLi¡
, 
$‹am
);

114  
$‹amLi¡
;

115 
	}
}

117 
public
 
funùiÚ
 
	$š£¹_‹am
(
$‹amInfo
)

119 
$this
->
	`assu»_dbCÚÃùiÚ
();

120 
$š£¹Sql
 = "INSERT INTO ".
$this
->
	`g‘_dbTabËName
(
£lf
::
TEAM_TABLE
);

121 
$keys
 = "(";

122 
$v®ues
 = " VALUES(";

123 
	`fÜ—ch
(
$‹amInfo
 
as
 
$key
 => 
$v®ue
)

125 
$keys
 .ð
$key
 . ",";

127 ià(
	`is_¡ršg
(
$v®ues
))

129 
$v®ues
 .ð"'" . 
$v®ue
 . "'" . ",";

133 
$v®ues
 .ð
$v®ue
. ",";

137 
$keys
 = 
	`sub¡r
($keys, 0, -1) . ")";

138 
$v®ues
 = 
	`sub¡r
($values, 0, -1) . ")";

140 
$š£¹Sql
 .ð
$keys
 . 
$v®ues
;

141 
$»suÉ
 = 
	`mysql_qu”y
(
$š£¹Sql
);

142 ià(!
$»suÉ
) {

143  
nuÎ
;

145 
$š£¹T—mId
 = 
	`mysql_š£¹_id
();

146 
$‹amInfo
['id'] = 
$š£¹T—mId
;

148  
$‹amInfo
;

149 
	}
}

	@
1
.
0
5
63
Coupon.php
Order.php
Partner.php
PartnerPlatforms.php
Team.php
