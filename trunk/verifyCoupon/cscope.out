cscope 15 $HOME/work/host/laiqu/verifyCoupon -q 0000000322 0000034191
	@VerifyCoupon.php

1 <?
php


13 
»quœe_Úû
('../common/Exception.php');

14 
»quœe_Úû
('../common/CodeMessages.php');

19 şas 
	cV”ifyCoupÚ


25 cÚ¡ 
	mTARGET_API
 = 'verifyCoupon';

29 
´iv©e
 
	m$_suµÜtPÏtfÜms
 = 
¬¿y
("laiqu", "juhuasuan");

31 
´iv©e
 
	m$_¶©fÜm
 = '';

32 
´iv©e
 
	m$_»que¡M‘hod
 = '';

33 
´iv©e
 
	m$_h‰pM‘hod
 = '';

34 
´iv©e
 
	m$_»¥Ú£Ty³
 = '';

35 
´iv©e
 
	m$_­iU¾
 = '';

36 
´iv©e
 
	m$_»que¡P¬ams
 = 
¬¿y
();

37 
´iv©e
 
	m$_»que¡P¬amsStic
 = 
¬¿y
();

38 
´iv©e
 
	m$_codeTag
 = '';

39 
´iv©e
 
	m$_codeSucûss
 = '';

40 
´iv©e
 
	m$_coupÚId
 = 0;

54 
public
 
funùiÚ
 
	$š™
(
$¶©fÜm
)

56 iàĞ!
$this
->
	`is_suµÜ‹d
(
$¶©fÜm
) )

58 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

59 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
UNKNOWN_PLATFORM_ERROR
),

60 
V”ifyCoupÚCodeMsg
::
UNKNOWN_PLATFORM_ERROR
);

62 
$this
->
_¶©fÜm
 = 
$¶©fÜm
;

64 
$cÚfigFeName
 = "../¶©fÜm_­i_cÚfs/" . 
$this
->
_¶©fÜm
 . ".conf";

65 
$cÚ‹Á
 = 
	`fe_g‘_cÚ‹Ás
(
$cÚfigFeName
);

66 
$cÚfigs
 = 
	`jsÚ_decode
(
$cÚ‹Á
);

68 ià(
$cÚfigs
 =ğ
nuÎ
)

70 
throw
 
Ãw
 
	`V”ifyCoupÚ_P¬£CÚfigFeExû±iÚ
(

71 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
PARSE_CONFIG_FILE_ERROR
),

72 
V”ifyCoupÚCodeMsg
::
PARSE_CONFIG_FILE_ERROR
);

75 
$this
->
_»que¡M‘hod
 = 
$cÚfigs
->
»que¡M‘hod
;

76 
$this
->
_h‰pM‘hod
 = 
$cÚfigs
->
h‰pM‘hod
;

77 
$this
->
_»¥Ú£Ty³
 = 
$cÚfigs
->
»¥Ú£Ty³
;

78 
$rg‘Api
 = 
£lf
::
TARGET_API
;

79 
$rg‘ApiCÚfs
 = 
$cÚfigs
->
$rg‘Api
;

81 
$this
->
_­iU¾
 = 
$rg‘ApiCÚfs
->
­iU¾
;

82 
$this
->
_»que¡P¬ams
 = 
$rg‘ApiCÚfs
->
»que¡P¬ams
;

83 
$this
->
_»que¡P¬amsStic
 = 
$rg‘ApiCÚfs
->
»que¡P¬amsStic
;

84 
$this
->
_codeTag
 = 
$rg‘ApiCÚfs
->
»¥Ú£ResuÉ
->
codeTag
;

85 
$this
->
_codeSucûss
 = 
$rg‘ApiCÚfs
->
»¥Ú£ResuÉStic
->
codeSucûss
;

87  
Œue
;

99 
public
 
funùiÚ
 
	$is_suµÜ‹d
(
$¶©fÜm
)

101 ià(
$¶©fÜm
 == '')

102  
çl£
;

103 
	`fÜ—ch
 (
$this
->
_suµÜtPÏtfÜms
 
as
 
$suµÜt
)

105 ià(
$¶©fÜm
 =ğ
$suµÜt
)

106  
Œue
;

109  
çl£
;

110 
	}
}

122 
public
 
funùiÚ
 
	$š™_v”ifyIÅuts
(
$»que¡
)

124 ià(!
	`is£t
(
$»que¡
['couponId']) || $request['couponId'] == '')

126 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

127 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
INVALID_COUPONID_ARG_ERROR
),

128 
V”ifyCoupÚCodeMsg
::
INVALID_COUPONID_ARG_ERROR
);

130 
$šputs
['coupÚId'] = 
$»que¡
['couponId'];

132 ià(
	`is£t
(
$this
->
_»que¡P¬ams
->
coupÚPwd
))

134 ià(
$»que¡
['couponPwd'] == '')

136 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

137 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
INVALID_COUPONPWD_ARG_ERROR
),

138 
V”ifyCoupÚCodeMsg
::
INVALID_COUPONPWD_ARG_ERROR
);

141 
$šputs
['coupÚPwd'] = 
$»que¡
['couponPwd'];

144 ià(
	`is£t
(
$this
->
_»que¡P¬ams
->
cÚsumeCouÁ
))

146 
$cÚsumeCouÁ
 = 
$»que¡
['consumeCount'];

147 ià(
$cÚsumeCouÁ
 ==ğ"" || !
	`is_num”ic
($cÚsumeCouÁè|| 
	`štv®
($consumeCount) < 1)

149 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

150 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
MALFORMED_COUNT_NUMBER
),

151 
V”ifyCoupÚCodeMsg
::
MALFORMED_COUNT_NUMBER
);

154 
$šputs
['cÚsumeCouÁ'] = 
$cÚsumeCouÁ
;

157  
$šputs
;

158 
	}
}

170 
public
 
funùiÚ
 
	$g‘_»¥Ú£Code
(
$»¥Ú£
)

172 
$»¥Ú£Code
 = "";

173 ià((
$»¥Ú£
 =ğ"" && 
$this
->
_»¥Ú£Ty³
 !== "JUHUASUAN") || $this->_responseType == "" ||

174 
$this
->
_codeTag
 =ğ"" || $this->
_codeSucûss
 == "")

176 
throw
 
Ãw
 
	`V”ifyCoupÚ_P¬£Re¥Ú£Exû±iÚ
(

177 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
PARSE_RESPONSE_EXCEPTION
),

178 
V”ifyCoupÚCodeMsg
::
PARSE_RESPONSE_EXCEPTION
);

181 
$codeTag
 = 
$this
->
_codeTag
;

182 
$»¥Ú£Ty³
 = 
	`¡¹ouµ”
(
$this
->
_»¥Ú£Ty³
);

183 ià(
$»¥Ú£Ty³
== "LAIQU")

185 
	`´eg_m©ch_®l
("/(<([\w]+)[^>]*>)(.*?)(<\/\\2>)/", 
$»¥Ú£
, 
$m©ches
, 
PREG_SET_ORDER
);

186 
	`fÜ—ch
 (
$m©ches
 
as
 
$v®
) {

187 ià(
$v®
[2] =ğ
$this
->
_codeTag
)

189 
$»¥Ú£Code
 = 
$v®
[3];

192 } ià(
$»¥Ú£Ty³
 == "XML")

194 
$xmlRe¥Ú£
 = 
	`sim¶exml_lßd_¡ršg
(
$»¥Ú£
);

195 
$»¥Ú£Code
 = 
$xmlRe¥Ú£
->
$codeTag
;

196 } ià(
$»¥Ú£Ty³
 === "JSON")

198 
$jsÚRe¥Ú£
 = 
	`jsÚ_decode
(
$»¥Ú£
);

199 
$»¥Ú£Code
 = 
$jsÚRe¥Ú£
->
$codeTag
;

200 } ià(
$»¥Ú£Ty³
 === "JUHUASUAN")

204 ià(
çl£
 ==ğ
	`¡ros
(
$»¥Ú£
, "false"))

206 
$»¥Ú£Code
 = "true";

207 } ià(
çl£
 !=ğ
	`¡½os
(
$»¥Ú£
, "302")){

209 
$»¥Ú£Code
 = "login_expired";

211 
$»¥Ú£Code
 = "false";

215 ià(
$»¥Ú£Code
 == '')

217 
throw
 
Ãw
 
	`V”ifyCoupÚ_P¬£Re¥Ú£Exû±iÚ
(

218 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
PARSE_RESPONSE_EXCEPTION
),

219 
V”ifyCoupÚCodeMsg
::
PARSE_RESPONSE_EXCEPTION
);

221 ià(
$»¥Ú£Code
 =ğ
$this
->
_codeSucûss
)

223  
V”ifyCoupÚCodeMsg
::
VERIFY_COUPON_SUCCESS
;

225 ià(
$»¥Ú£Code
 === "login_expired")

227  
V”ifyCoupÚCodeMsg
::
JUHUASUAN_LOGIN_EXPIRED
;

230  
V”ifyCoupÚCodeMsg
::
VERIFY_COUPON_FAIL
;

232 
	}
}

244 
public
 
funùiÚ
 
	$g‘_»que¡P¬ams
(
$šputs
)

246 ià(!
	`is_¬¿y
(
$šputs
))

248 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

249 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
TRANSFER_REQUEST_PARAM_ERROR
),

250 
V”ifyCoupÚCodeMsg
::
TRANSFER_REQUEST_PARAM_ERROR
);

253 
$·¿ms
 = 
	`¬¿y
();

254 
	`fÜ—ch
 (
$this
->
_»que¡P¬ams
 
as
 
$key
 => 
$v®ue
)

257 ià(!
	`is£t
(
$šputs
[
$key
]))

259 
throw
 
Ãw
 
	`V”ifyCoupÚ_Reque¡Exû±iÚ
(

260 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(V”ifyCoupÚCodeMsg::
TRANSFER_REQUEST_PARAM_ERROR
),

261 
V”ifyCoupÚCodeMsg
::
TRANSFER_REQUEST_PARAM_ERROR
);

264 
$·¿ms
[
$v®ue
] = 
$šputs
[
$key
];

266 ià(
$this
->
_»que¡P¬amsStic
 !ğ
nuÎ
)

269 
	`fÜ—ch
 (
$this
->
_»que¡P¬amsStic
 
as
 
$key
 => 
$v®ue
)

271 
$·¿ms
[
$key
] = 
$v®ue
;

274  
$·¿ms
;

275 
	}
}

286 
public
 
funùiÚ
 
g’_»¥Ú£_jsÚ
(
$»suÉ
, 
$msg
 = "")

289 
$code
 = 
$»suÉ
;

290 ià(
	g$msg
 == "")

293 
$msg
 = 
V”ifyCoupÚCodeMsg
::
g‘_mes§ge
(
$code
);

296 ià(
em±y
(
$msg
))

298 
	g$code
 = 
CommÚCodeMsg
::
INVALID_ARGUMENT_ERROR
;

299 
	g$msg
 = 
CommÚCodeMsg
::
g‘_mes§ge
(
$code
);

303 ià(
	g$code
 ==ğ
V”ifyCoupÚCodeMsg
::
VERIFY_COUPON_SUCCESS
)

305 
$»¥Ú£
['sucûss'] = 
Œue
;

307 
	g$»¥Ú£
['sucûss'] = 
çl£
;

309 
	g$»¥Ú£
['code'] = 
$code
;

310 
	g$»¥Ú£
['msg'] = 
$msg
;

312  
jsÚ_’code
(
$»¥Ú£
);

317 
public
 
funùiÚ
 
	$g‘_¶©fÜm
()

319  
$this
->
_¶©fÜm
;

320 
	}
}

324 
public
 
funùiÚ
 
	$g‘_»que¡M‘hod
()

326  
$this
->
_»que¡M‘hod
;

327 
	}
}

331 
public
 
funùiÚ
 
	$g‘_h‰pM‘hod
()

333  
$this
->
_h‰pM‘hod
;

334 
	}
}

338 
public
 
funùiÚ
 
	$g‘_»¥Ú£Ty³
()

340  
$this
->
_»¥Ú£Ty³
;

341 
	}
}

345 
public
 
funùiÚ
 
	$g‘_­iU¾
()

347  
$this
->
_­iU¾
;

348 
	}
}

352 
public
 
funùiÚ
 
	$g‘_codeTag
()

354  
$this
->
_codeTag
;

355 
	}
}

359 
public
 
funùiÚ
 
	$g‘_codeSucûss
()

361  
$this
->
_codeSucûss
;

362 
	}
}

	@VerifyCoupon_funcs.php

1 <?
php


9 
funùiÚ
 
	$š™_v”ifyIÅuts
(
$»que¡
)

11 
$šputs
 = 
	`¬¿y
();

14 
$šputs
['coupÚId'] = 
$»que¡
['couponId'];

15 ià(
$»que¡
['couponPwd'] != '')

16 
$šputs
['coupÚPwd'] = 
$»que¡
['couponPwd'];

17  
$šputs
;

18 
	}
}

30 
funùiÚ
 
	$·r£_¶©fÜm_»¥Ú£
(
$»¥Ú£
, 
$»que¡M‘hod
, 
$»¥Ú£Ty³
, 
$codeTag
, 
$codeSucûss
)

32 ià(
$»que¡M‘hod
 != 'REST')

33  
CODE_ERROR_ONLY_SUPPORT_REST
;

34  
	`g‘_»¥Ú£Code
(
$»¥Ú£
, 
$»¥Ú£Ty³
, 
$codeTag
, 
$codeSucûss
);

35 
	}
}

37 
funùiÚ
 
	$g‘_»¥Ú£Code
(
$»¥Ú£
, 
$»¥Ú£Ty³
, 
$codeTag
, 
$codeSucûss
)

39 
$»¥Ú£Code
 = "";

40 ià(
$»¥Ú£
 =ğ"" || 
$»¥Ú£Ty³
 == "" ||

41 
$codeTag
 =ğ"" || 
$codeSucûss
 == "")

42  
CODE_ERROR_API_CALL
;

44 ià(
$»¥Ú£Ty³
 == "LAIQU")

46 
	`´eg_m©ch_®l
("/(<([\w]+)[^>]*>)(.*?)(<\/\\2>)/", 
$»¥Ú£
, 
$m©ches
, 
PREG_SET_ORDER
);

47 
	`fÜ—ch
 (
$m©ches
 
as
 
$v®
) {

48 ià(
$v®
[2] =ğ
$codeTag
)

50 
$»¥Ú£Code
 = 
$v®
[3];

53 } ià(
$»¥Ú£Ty³
 == "XML")

55 
$xmlRe¥Ú£
 = 
	`sim¶exml_lßd_¡ršg
(
$»¥Ú£
);

56 
$»¥Ú£Code
 = 
$xmlRe¥Ú£
->
$code
;

59 ià(
$»¥Ú£Code
 == '')

60  
CODE_ERROR_API_CALL
;

62  
$»¥Ú£Code
 =ğ
$codeSucûss
 ? 
CODE_SUCCESS_VERIFY_COUPON
:
CODE_FAIL_VERIFY_COUPON
;

63 
	}
}

72 
funùiÚ
 
	$·r£_¶©fÜm_cÚfs
(
$¶©fÜm
)

74 
glob®
 
$»que¡M‘hod
;

75 
glob®
 
$h‰pM‘hod
;

76 
glob®
 
$»¥Ú£Ty³
;

77 
glob®
 
$­iU¾
;

78 
glob®
 
$»que¡P¬ams
;

79 
glob®
 
$»que¡P¬amsStic
;

80 
glob®
 
$codeTag
;

81 
glob®
 
$codeSucûss
;

83 
$cÚfigFeName
 = "¶©fÜm_­i_cÚfs/" . 
$¶©fÜm
 . ".conf";

84 
$cÚ‹Á
 = 
	`fe_g‘_cÚ‹Ás
(
$cÚfigFeName
);

85 
$cÚfigs
 = 
	`jsÚ_decode
(
$cÚ‹Á
);

86 
	`fÜ—ch
 (
$cÚfigs
 
as
 
$key
 => 
$v®ue
)

88 
glob®
 
$$key
;

89 
$$key
 = 
$v®ue
;

91 
$­iU¾
 = 
$$rg‘Api
->
­iU¾
;

92 
$»que¡P¬ams
 = 
$$rg‘Api
->
»que¡P¬ams
;

93 
$»que¡P¬amsStic
 = 
$$rg‘Api
->
»que¡P¬amsStic
;

94 
$codeTag
 = 
$$rg‘Api
->
»¥Ú£ResuÉ
->
codeTag
;

95 
$codeSucûss
 = 
$$rg‘Api
->
»¥Ú£ResuÉStic
->
codeSucûss
;

96 
	}
}

105 
funùiÚ
 
	$g‘_»que¡P¬ams
(
$šputs
)

107 
$·¿ms
 = 
	`¬¿y
();

108 
glob®
 
$»que¡P¬ams
;

109 
glob®
 
$»que¡P¬amsStic
;

110 
	`fÜ—ch
 (
$»que¡P¬ams
 
as
 
$key
 => 
$v®ue
)

113 
$·¿ms
[
$v®ue
] = 
$šputs
[
$key
];

115 ià(
$»que¡P¬amsStic
 !ğ
nuÎ
)

118 
	`fÜ—ch
 (
$»que¡P¬amsStic
 
as
 
$key
 => 
$v®ue
)

120 
$·¿ms
[
$key
] = 
$v®ue
;

123  
$·¿ms
;

124 
	}
}

133 
funùiÚ
 
	$g’_»¥Ú£_jsÚ
(
$»suÉ
)

135 
glob®
 
$codeMes§ges
;

136 
$»¥Ú£
 = 
	`¬¿y
();

138 ià(!
$»suÉ
 || 
$codeMes§ges
[$result] == '')

139 
$»suÉ
 = 
CODE_ERROR_UNKNOWN
;

141 
$»¥Ú£
['code'] = 
$»suÉ
;

142 
$»¥Ú£
['msg'] = 
$codeMes§ges
[
$»suÉ
];

143 
$»¥Ú£
['d©eTime'] = 
	`d©e
("Y-m-d, h:i:s");

145  
	`jsÚ_’code
(
$»¥Ú£
);

146 
	}
}

	@doVerifyCoupon.php

1 <?
php


10 
	g»quœe_Úû
 '../common/checkAuthority.php';

11 
	g»quœe_Úû
 '../common/RESTclient.php';

12 
	g»quœe_Úû
 'VerifyCoupon.php';

13 
	g»quœe_Úû
 '../common/CodeMessages.php';

14 
	g»quœe_Úû
 'functions.php';

16 
funùiÚ
 
	$ruÁimeE¼ÜHªdËr
(
$”ºo
, 
$”r¡r
, 
$”rfe
, 
$”¾še
)

19 
$code
 = 
CommÚCodeMsg
::
SYSTEM_RUNTIME_ERROR
;

21 
	`”rÜ_log
(
$”r¡r
);

22 
	`d›
(
V”ifyCoupÚ
::
	`g’_»¥Ú£_jsÚ
(
$code
));

24 
	}
}

25 
funùiÚ
 
	$exû±iÚHªdËr
(
$exû±iÚ
)

27 
$code
 = 
$exû±iÚ
->
	`g‘Code
();

28 
$v”ifyMsg
 = 
V”ifyCoupÚCodeMsg
::
	`g‘_mes§ge
(
$code
);

29 ià(
	`em±y
(
$v”ifyMsg
))

31 
$code
 = 
CommÚCodeMsg
::
UNCAUGHT_FATAL_ERROR
;

32 
$”r¡r
 = 
$exû±iÚ
->
	`g‘Mes§ge
();

34 
	`”rÜ_log
(
$”r¡r
);

36 
	`d›
(
V”ifyCoupÚ
::
	`g’_»¥Ú£_jsÚ
(
$code
));

37 
	}
}

38 
£t_”rÜ_hªdËr
('ruÁimeE¼ÜHªdËr', 
E_ERROR
);

39 
£t_exû±iÚ_hªdËr
('exceptionHandler');

41 
	g$¶©fÜm
 = 
$_REQUEST
['platform'];

44 ià(
is£t
(
$_REQUEST
['aùiÚ']è&& 
	g$_REQUEST
['aùiÚ'] ==ğ'v®id©eCode' && 
$¶©fÜm
 === 'juhuasuan')

46 
$»¡
 = 
Ãw
 
RESTş›Á
();

47 
	g$»¡
->
ü—‹Reque¡
('h‰p://59.151.29.121/v®id©eCode.do?'.
d©e
(
mktime
()), 'GET');

48 
	g$»q
 = 
$»¡
->
g‘H‰pReque¡
();

50 
	g$»¡
->
£ndReque¡
();

51 
	g$»¥Ú£Obj
 = 
$»¡
->
g‘Re¥Ú£Obj
();

52 
	g$j£ssiÚid
 = 
fšdCook›
("JSESSIONID", 
$»¥Ú£Obj
->
g‘Cook›s
());

53 ià(
	g$j£ssiÚid
 != '')

55 
$»q
->
addCook›
("JSESSIONID", 
$j£ssiÚid
['value']);

57 
	g$_SESSION
['JSESSIONID'] = 
$j£ssiÚid
['value'];

59 
h—d”
("Content-Type:image/jpeg");

60 
echo
 
	g$»¡
->
g‘Re¥Ú£
();

61 
un£t
(
$»¡
);

62 
	gex™
;

64 ià(
is£t
(
$_REQUEST
['aùiÚ']è&& 
	g$_REQUEST
['aùiÚ'] ==ğ'isjulogš' && 
$¶©fÜm
 === 'juhuasuan')

66 ià(
is£t
(
$_SESSION
['JSESSIONID']) && $_SESSION['JSESSIONID'] !== "")

68 
$sucûss
 = 
Œue
;

70 
	g$sucûss
 = 
çl£
;

72 
echo
 
jsÚ_’code
(
¬¿y
("sucûss"=>
$sucûss
));

73 
	gex™
;

75 ià(
is£t
(
$_REQUEST
['aùiÚ']è&& 
	g$_REQUEST
['aùiÚ'] ==ğ'julogš' && 
$¶©fÜm
 === 'juhuasuan')

77 
$v®id©eCode
 = 
$_REQUEST
['validatecode'];

78 
	g$sucûss
 = 
çl£
;

80 ià(
	g$v®id©eCode
 !== "")

82 
$sucûss
 = 
logš_¶©fÜm
(
$¶©fÜm
);

84 ià(
	g$sucûss
 === "juhuasuan_not_bind")

86 
$sucûss
 = 
V”ifyCoupÚCodeMsg
::
PLATFORM_ACCT_NOT_BIND_ERROR
;

89 
echo
 
jsÚ_’code
(
¬¿y
("sucûss" => 
$sucûss
));

90 
	gex™
;

93 
	g$»¥Ú£Code
 = 
doV”ifyCoupÚ
(
$_REQUEST
);

94 
	g$coupÚId
 = 
$_REQUEST
['couponId'];

95 ià(
	g$¶©fÜm
 === 'juhuasuan')

97 
$cÚsumed_times
 = 
$_REQUEST
['consumeCount'];

101 ià(
	g$»¥Ú£Code
 ==ğ
V”ifyCoupÚCodeMsg
::
JUHUASUAN_LOGIN_EXPIRED
)

104 
$ŒyTimes
 = 10;

105 
	g$couÁ
 = 0;

106 !
logš_¶©fÜm
('juhuasuan'))

108 ià(++
	g$couÁ
 ==ğ
$ŒyTimes
 ) ;

110 ià(
	g$couÁ
 < 
	g$ŒyTimes
)

112 
	g$»¥Ú£Code
 = 
doV”ifyCoupÚ
(
$_REQUEST
);

116 ià(
	g$»¥Ú£Code
 ==ğ
V”ifyCoupÚCodeMsg
::
VERIFY_COUPON_SUCCESS
)

118 ià(!
»cÜd_cÚsumed_coupÚ
(
$coupÚId
, 
$¶©fÜm
, 
$cÚsumed_times
))

120 
$»¥Ú£Code
 = 
V”ifyCoupÚCodeMsg
::
RECORD_COUPON_FAILED_ERROR
;

123 ià(
	g$»¥Ú£Code
 ==ğ
V”ifyCoupÚCodeMsg
::
RECORD_COUPON_FAILED_ERROR
)

125 
$»¥Ú£
 = 
V”ifyCoupÚ
::
g’_»¥Ú£_jsÚ
(

126 
V”ifyCoupÚCodeMsg
::
RECORD_COUPON_FAILED_ERROR
,

127 "E¼ÜCode: ".
V”ifyCoupÚCodeMsg
::
RECORD_COUPON_FAILED_ERROR
." å¹³å°:".
$¶©fÜm
."ç¼–å·ä¸º".
$coupÚId
."çš„å·²æ¶ˆè´¹çš„å›¢è´­åˆ¸åœ¨æœ¬åœ°ç™»è®°å¤±è´¥!");

130 
	g$»¥Ú£
 = 
V”ifyCoupÚ
::
g’_»¥Ú£_jsÚ
(
$»¥Ú£Code
);

132 
	g$»¥Ú£W™hCoupÚInfo
 = 
addCoupÚInfoToV”ifyRe¥Ú£
(
$»¥Ú£
, 
$coupÚId
, 
$¶©fÜm
, 
$cÚsumed_times
);

133 
echo
 
	g$»¥Ú£W™hCoupÚInfo
;

134 
un£t
(
$»¡
);

	@functions.php

1 <?
php


12 
	g»quœe_Úû
 '../module/PartnerPlatforms.php';

13 
	g»quœe_Úû
 '../module/Order.php';

14 
	g»quœe_Úû
 '../module/Team.php';

15 
	g»quœe_Úû
 '../module/Coupon.php';

16 
	g»quœe_Úû
 '../common/class/Valite.php';

17 
	g»quœe_Úû
 'VerifyCoupon.php';

18 
	g»quœe_Úû
 '../common/RESTclient.php';

21 
funùiÚ
 
	$fšdCook›
(
$Çme
, 
$cook›s
)

23 
	`fÜ—ch
 (
$cook›s
 
as
 
$cook›
)

25 ià(
$cook›
['Çme'] ==ğ
$Çme
)

27  
$cook›
;

31 
	}
}

35 
funùiÚ
 
	$d—l_w™h_¶©fÜm
(
$»que¡
)

37 
$¶©fÜm
 = 
$»que¡
['platform'];

39 ià(
$¶©fÜm
 === 'juhuasuan')

41 
$v®id©eCode
 = 
$»que¡
['validateCode'];

42 ià(
$v®id©eCode
 ==ğ"" || !
	`logš_¶©fÜm
(
$¶©fÜm
))

44  
V”ifyCoupÚCodeMsg
::
VALIDATECODE_NOT_MATCH_ERROR
;

46 ià(
	`logš_¶©fÜm
(
$¶©fÜm
) === "juhuasuan_not_bind")

48  
V”ifyCoupÚCodeMsg
::
PLATFORM_ACCT_NOT_BIND_ERROR
;

50  
Œue
;

52 
	}
}

55 
funùiÚ
 
	$g‘_logš_v®id©e_img_·th
(
$¶©fÜm
)

57 
$tmp_ÿ±cha_Çme
 = '';

58 ià(
$¶©fÜm
 === "juhuasuan")

60 
$ÿ±chaU¾
 = 'h‰p://59.151.29.121/v®id©eCode.do?'.
	`d©e
(
	`mktime
());

61 
$imgSuffix
 = 'jpg';

64 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

65 
$»¡
->
	`ü—‹Reque¡
(
$ÿ±chaU¾
);

66 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

68 
$»¡
->
	`£ndReque¡
();

69 
$»¥Ú£Obj
 = 
$»¡
->
	`g‘Re¥Ú£Obj
();

70 
$j£ssiÚid
 = 
	`fšdCook›
("JSESSIONID", 
$»¥Ú£Obj
->
	`g‘Cook›s
());

71 ià(
$j£ssiÚid
 != '')

73 
$»q
->
	`addCook›
("JSESSIONID", 
$j£ssiÚid
['value']);

75 
$_SESSION
['JSESSIONID'] = 
$j£ssiÚid
['value'];

77 
$tmp_ÿ±cha_Çme
 = 
	`‹m²am
(
	`sys_g‘_‹mp_dœ
(),
$imgSuffix
);

78 
	`fe_put_cÚ‹Ás
(
$tmp_ÿ±cha_Çme
, 
$»¡
->
	`g‘Re¥Ú£
());

79  
$tmp_ÿ±cha_Çme
;

80 
	}
}

82 
funùiÚ
 
	$decode_ÿ±cha
(
$ÿ±chaP©h
)

84 
$v®™e
 = 
Ãw
 
	`V®™e
();

86 
$v®™e
->
	`£tImage
(
$ÿ±chaP©h
);

87 
$v®™e
->
	`g‘Hec
();

88 
$v®id©eCode
 = 
$v®™e
->
	`run
();

90  
$v®id©eCode
;

91 
	}
}

93 
funùiÚ
 
	$logš_¶©fÜm
(
$¶©fÜm
)

95 ià(
$¶©fÜm
 === 'juhuasuan')

98 
$sucûss
 = 
çl£
;

99 
$ÿ±chaP©h
 = 
	`g‘_logš_v®id©e_img_·th
(
$¶©fÜm
);

100 
$v®id©eCode
 = 
	`decode_ÿ±cha
(
$ÿ±chaP©h
);

101 
	`uÆšk
(
$ÿ±chaP©h
);

103 
$logšU¾
 = "http://59.151.29.121/shopUsed/shopLogin.do";

105 
$·¿ms
 = 
	`g‘_juhuasuª_logš_·¿ms
();

106 ià(
$·¿ms
 ==ğ
nuÎ
)

110 
$·¿ms
['mod–.v®id©eCode'] = 
$v®id©eCode
;

111 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

112 
$»¡
->
	`ü—‹Reque¡
(
$logšU¾
,'POST',
$·¿ms
);

115 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

116 
$»q
->
	`£tCook›J¬
();

117 
$»q
->
	`addCook›
("JSESSIONID", 
$_SESSION
['JSESSIONID']);

118 
$»¡
->
	`£ndReque¡
();

119 
$»¥Ú£
 = 
$»¡
->
	`g‘Re¥Ú£
();

120 
	`un£t
(
$»¡
);

121 
$sucûss
 = 
	`is_logš_sucûss
(
$»¥Ú£
, 
$¶©fÜm
);

123 ià(
$sucûss
 ==ğ
Œue
)

125 
$_SESSION
['·¹Ãr_'.
$¶©fÜm
] = 
	`¬¿y
(

126 "p_u£ºame" => 
$·¿ms
['model.sign'],

127 "p_·sswÜd" => 
$·¿ms
['model.password'],

128 "p_‹rmš®id" => 
$·¿ms
['model.terminalId']);

130  
$sucûss
;

132 
	}
}

134 
funùiÚ
 
	$doV”ifyCoupÚ
(
$»que¡
)

136 
$¶©fÜm
 = 
$»que¡
['platform'];

137 
$v”ifyCoupÚ
 = 
Ãw
 
	`V”ifyCoupÚ
();

139 
$v”ifyCoupÚ
->
	`š™
(
$¶©fÜm
);

141 
$šputs
 = 
$v”ifyCoupÚ
->
	`š™_v”ifyIÅuts
(
$»que¡
);

142 
$coupÚId
 = 
$šputs
['couponId'];

143 ià(
$¶©fÜm
 ==ğ'juhuasuª' && 
	`is£t
(
$_SESSION
['partner_'.$platform]))

145 
$šputs
['‹rmš®id'] = 
$_SESSION
['·¹Ãr_'.
$¶©fÜm
]['p_terminalid'];

148 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

149 
$·¿ms
 = 
$v”ifyCoupÚ
->
	`g‘_»que¡P¬ams
(
$šputs
);

151 ià(
$v”ifyCoupÚ
->
	`g‘_h‰pM‘hod
() == 'POST') {

152 
$»¡
->
	`ü—‹Reque¡
(
$v”ifyCoupÚ
->
	`g‘_­iU¾
(), 'POST', 
$·¿ms
);

154 
$»¡
->
	`ü—‹Reque¡
(
$v”ifyCoupÚ
->
	`g‘_­iU¾
());

155 
$u¾
 = 
$»¡
->
	`g‘U¾
();

156 
$u¾
->
	`£tQu”yV¬ŸbËs
(
$·¿ms
);

158 
$»¥Ú£
 = '';

161 ià(
$¶©fÜm
 === "juhuasuan")

163 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

164 
$»q
->
	`addCook›
("JSESSIONID", 
$_SESSION
['JSESSIONID']);

165 
$cÚsumed_times
 = 
$»que¡
['consumeCount'];

168 
$»¡
->
	`£ndReque¡
();

169 
$»¥Ú£
 = 
$»¡
->
	`g‘Re¥Ú£
();

170 
$»¥Ú£Code
 = 
$v”ifyCoupÚ
->
	`g‘_»¥Ú£Code
(
$»¥Ú£
);

171  
$»¥Ú£Code
;

172 
	}
}

175 
funùiÚ
 
	$is_logš_sucûss
(
$»¥Ú£
, 
$¶©fÜm
)

177 ià(
$¶©fÜm
 === 'juhuasuan')

180 iàĞ1 !=ğ
	`´eg_m©ch
('/g‘Li¡\(\"shİU£d\/h—d”s\.do\"\)/', 
$»¥Ú£
))

182  
çl£
;

184  
Œue
;

186 
	}
}

188 
funùiÚ
 
	$g‘_juhuasuª_logš_·¿ms
()

190 
$·¹ÃrPÏtfÜms
 = 
Ãw
 
	`P¬Š”PÏtfÜms
();

191 ià(!
	`is£t
(
$_SESSION
['partnerId']))

193  
nuÎ
;

195 
$µRow
 = 
$·¹ÃrPÏtfÜms
->
	`g‘_row
(

196 
	`¬¿y
("·¹Ãr_id" => 
$_SESSION
['partnerId'],

200 ià(
$µRow
 ==ğ
nuÎ
) { ‚ull; }

202 
$·¿ms
 = 
	`¬¿y
 (

203 "mod–.sign" => 
$µRow
['p_username'],

204 "mod–.·sswÜd" => 
$µRow
['p_password'],

205 "mod–.‹rmš®Id" => 
$µRow
['p_terminalid']);

206  
$·¿ms
;

207 
	}
}

210 
funùiÚ
 
	$»cÜd_cÚsumed_coupÚ
(
$coupÚId
, 
$¶©fÜm
, 
$cÚsumed_times
=1)

212 
$coupÚ
 = 
Ãw
 
	`CoupÚ
();

213 
$cÚd™iÚs
 = 
	`¬¿y
(

214 "¶©fÜm_coupÚ_id"=>
$coupÚId
,

215 "¶©fÜm_key"=>
$¶©fÜm
);

216 
$cÚsumedCoupÚs
 = 
$coupÚ
->
	`g‘_row
(
$cÚd™iÚs
);

218 ià(!
	`is_num”ic
(
$cÚsumed_times
) || $consumed_times < 1)

220  
çl£
;

222 ià(
$cÚsumedCoupÚs
 !=ğ
nuÎ
 && 
$¶©fÜm
 === "juhuasuan")

224  
$coupÚ
->
	`cÚsume_coupÚ
(
$cÚsumedCoupÚs
['id'], 
$cÚsumed_times
);

225 } ià(
$¶©fÜm
 === "juhuasuan")

228 
$Üd”Info
 = 
	`»cÜd_Üd”
(
$coupÚId
, 
$¶©fÜm
, 
$cÚsumed_times
);

231 ifĞ
$Üd”Info
 ==ğ
çl£
)

233  
çl£
;

236 
$š£¹CoupÚ
 = 
	`¬¿y
(

237 "¶©fÜm_key" => 
$Üd”Info
['platform_key'],

238 "·¹Ãr_id" => 
$_SESSION
['partnerId'],

239 "‹am_id" => 
$Üd”Info
['team_id'],

240 "Üd”_id" => 
$Üd”Info
['id'],

242 "cÚsume_time" => 
	`mktime
(),

243 "ü—‹_time" => 
	`mktime
(),

244 "cÚsume_times" => 
$cÚsumed_times
,

245 "¶©fÜm_coupÚ_id" => 
$coupÚId
,

246 "cÚsum”_mobe" => 
$Üd”Info
['consumer_mobile'],

249  
$coupÚ
->
	`š£¹_coupÚ
(
$š£¹CoupÚ
);

251 
	}
}

253 
funùiÚ
 
	$»cÜd_Üd”
(
$coupÚId
,
$¶©fÜm
, 
$cÚsumed_times
 = 1)

256 
$Üd”Info
 = 
	`g‘_Üd”Info
(
$coupÚId
, 
$¶©fÜm
);

257 ià(!
	`is_¬¿y
(
$Üd”Info
è|| 
	`em±y
($orderInfo))

259  
çl£
;

262 
$Üd”Info
['¶©fÜm_key'] = 
$¶©fÜm
;

263 
$Üd”Info
['cÚsume_times'] = 
$cÚsumed_times
;

264 
$Üd”Info
['·¹Ãr_id'] = 
$_SESSION
['partnerId'];

265 
$Üd”Info
['¶©fÜm_coupÚ_id'] = 
$coupÚId
;

267 
$Üd”Id
 = 
$Üd”Info
['platform_order_id'];

268 
$Üd”
 = 
Ãw
 
	`Ord”
();

269 
$cÚd™iÚs
 = 
	`¬¿y
(

270 "¶©fÜm_Üd”_id"=>
$Üd”Id
,

271 "¶©fÜm_key"=>
$¶©fÜm
);

272 
$»cÜdedOrd”
 = 
$Üd”
->
	`g‘_row
(
$cÚd™iÚs
);

274 ià(
$»cÜdedOrd”
 !=ğ
nuÎ
 && 
$¶©fÜm
 === "juhuasuan")

276 
$»cÜdedOrd”
['cÚsum”_mobe'] = 
$Üd”Info
['consumer_mobile'];

277  
$»cÜdedOrd”
;

278 } if(
$¶©fÜm
 === "juhuasuan")

280 
$»cÜdedT—m
 = 
	`»cÜd_‹am_by_Üd”
(
$Üd”Info
);

281 
$Üd”Info
['‹am_id'] = 
$»cÜdedT—m
['id'];

283 
$š£¹Ord”
 = 
	`¬¿y
(

284 "‹am_id" => 
$Üd”Info
['team_id'],

285 "ü—‹_time" => 
	`mktime
(),

286 "¶©fÜm_Üd”_id" => 
$Üd”Info
['platform_order_id'],

287 "¶©fÜm_key" => 
$Üd”Info
['platform_key']

289 
$Üd”In£¹ed
 = 
$Üd”
->
	`š£¹_Üd”
(
$š£¹Ord”
);

290 
$Üd”In£¹ed
['cÚsum”_mobe'] = 
$Üd”Info
['consumer_mobile'];

291  
$Üd”In£¹ed
;

293 
	}
}

296 
funùiÚ
 
	$»cÜd_‹am_by_Üd”
(
$Üd”Info
)

298 
$‹am
 = 
Ãw
 
	`T—m
();

299 ià(
	`is_¬¿y
(
$Üd”Info
è&& !
	`em±y
($orderInfo))

302 
$‹amRow
 = 
$‹am
->
	`g‘_row
(

303 
	`¬¿y
("t™Ë"=>
$Üd”Info
['title'],

304 "¶©fÜm_key"=>
$Üd”Info
['platform_key']));

306 ià(!
	`is_¬¿y
(
$‹amRow
è|| 
	`em±y
($teamRow))

308 
$‹amInfo
 = 
	`¬¿y
(

309 "t™Ë" => 
$Üd”Info
['title'],

310 "¶©fÜm_key" => 
$Üd”Info
['platform_key'],

311 "summ¬y" => 
$Üd”Info
['summary'],

312 "·¹Ãr_id" => 
$Üd”Info
['partner_id'],

313 "‹am_´iû" => 
$Üd”Info
['team_price']

315  
$‹am
->
	`š£¹_‹am
(
$‹amInfo
);

317  
$‹amRow
;

320  
çl£
;

322 
	}
}

325 
funùiÚ
 
	$g‘_Üd”Info
(
$coupÚId
, 
$¶©fÜm
)

327 
$»¡
 = 
Ãw
 
	`RESTş›Á
();

328 
$ÏiquOrd”
 = 
	`¬¿y
();

330 ià(
$¶©fÜm
 === "juhuasuan")

332 
$·¿ms
 = 
	`¬¿y
("mod–.ass™Code" => 
$coupÚId
);

333 
$»¡
->
	`ü—‹Reque¡
("h‰p://59.151.29.121/shİU£d/li¡.do", 'POST', 
$·¿ms
);

334 
$»q
 = 
$»¡
->
	`g‘H‰pReque¡
();

335 
$»q
->
	`addCook›
("JSESSIONID", 
$_SESSION
['JSESSIONID']);

336 
$»¡
->
	`£ndReque¡
();

337 
$»¥Ú£
 = 
$»¡
->
	`g‘Re¥Ú£
();

339 
$»¥Ú£
 = 
	`tidy_ugly_jsÚ
($»¥Ú£,
$¶©fÜm
);

340 
$»suÉ
 = 
	`jsÚ_decode
(
$»¥Ú£
);

342 ià(
$»suÉ
->
sucûss
 ==ğ
çl£
 && $»suÉ->
¡©us
 === 302)

344  
V”ifyCoupÚCodeMsg
::
JUHUASUAN_LOGIN_EXPIRED
;

346 ià(
	`is£t
(
$»suÉ
->
d©a
è&& 
	`couÁ
($result->data) > 0)

348 
$Üd”
 = 
$»suÉ
->
d©a
[0];

349 
$ÏiquOrd”
 = 
	`cÚv”t_Üd”
(
$Üd”
, 
$¶©fÜm
);

350 } ià(
	`is£t
(
$»suÉ
->
d©a
)){

351  
V”ifyCoupÚCodeMsg
::
COUPON_NOT_EXIST
;

355  
$ÏiquOrd”
;

356 
	}
}

359 
funùiÚ
 
	$cÚv”t_Üd”
(
$Üd”Info
, 
$¶©fÜm
)

361 
$Üd”
 = 
	`¬¿y
();

362 ià(
$¶©fÜm
 === "juhuasuan")

364 
$Üd”
['t™Ë'] = 
$Üd”Info
->
´oduù
;

365 
$Üd”
['summ¬y'] = 
$Üd”Info
->
desütiÚ
;

367 
$Üd”
['‹am_´iû'] = 
	`æßtv®
(
	`sub¡r
(
$Üd”Info
->
·ym’t
, 3));

368 
$Üd”
['¶©fÜm_key'] = 
$¶©fÜm
;

369 
$Üd”
['¶©fÜm_Üd”_id'] = 
$Üd”Info
->
obaoId
;

370 
$Üd”
['cÚsum”_mobe'] = 
$Üd”Info
->
»ûiMobe
;

373  
$Üd”
;

375 
	}
}

378 
funùiÚ
 
	$tidy_ugly_jsÚ
(
$uglyJsÚ
, 
$¶©fÜm
)

380 
$b—utifulJsÚ
 = "";

381 ià(
$¶©fÜm
 === "juhuasuan")

384 
$uglyJsÚ
 = 
	`´eg_»¶aû
('/items\s*:\s*\[[^<]+?\]/','', $uglyJson);

385 
$uglyJsÚ
 = 
	`´eg_»¶aû
('/\s*:\s*/',':', $uglyJson);

387 
$uglyJsÚ
 = 
	`´eg_»¶aû_ÿÎback
('/([\{,]\s*)([[\w\d]+)(\s*:)/',"add_double_quote", $uglyJson);

389 
$b—utifulJsÚ
 = 
	`´eg_»¶aû
('/(,\s*)([\}\]])/','${2}',
$uglyJsÚ
);

391 
$b—utifulJsÚ
 = 
	`´eg_»¶aû
("/'(.*)'/",'"${1}"', $beautifulJson);

394  
$b—utifulJsÚ
;

395 
	}
}

396 
funùiÚ
 
	$add_doubË_quÙe
(
$m©ches
)

399  
$m©ches
[1].'"'.$matches[2].'":';

400 
	}
}

403 
funùiÚ
 
	$addCoupÚInfoToV”ifyRe¥Ú£
(
$»¥Ú£
, 
$coupÚId
, 
$¶©fÜm
, 
$cÚsumed_times
)

405 
$»¥Ú£Obj
 = 
	`jsÚ_decode
(
$»¥Ú£
);

406 ià(
$»¥Ú£Obj
->
sucûss
 ==ğ
çl£
)

408  
$»¥Ú£
;

411 
$coupÚ
 = 
Ãw
 
	`CoupÚ
();

412 
$·¿ms
 = 
	`¬¿y
('¶©fÜm_coupÚ_id'=>
$coupÚId
, '¶©fÜm_key'=>
$¶©fÜm
);

413 
$coupÚRow
 = 
$coupÚ
->
	`g‘_row
(
$·¿ms
);

414 ià(
$coupÚRow
 ==ğ
nuÎ
)

416  
$»¥Ú£
;

418 
$»¥Ú£Obj
->
coupÚId
 = 
$coupÚId
;

419 
$»¥Ú£Obj
->
¶©fÜm
 = 
$¶©fÜm
;

420 
$»¥Ú£Obj
->
‹amId
 = 
$coupÚRow
['team_id'];

421 
$»¥Ú£Obj
->
Üd”Id
 = 
$coupÚRow
['order_id'];

422 
$»¥Ú£Obj
->
cÚsum”Mobe
 = 
$coupÚRow
['consumer_mobile'];

423 
$»¥Ú£Obj
->
cÚsumedTimes
 = 
$coupÚRow
['consumedTimes'];

424 
$»¥Ú£Obj
->
d©eTime
 = 
	`¡ráime
('%Y-%m-%d %H:%M:%S',
$coupÚRow
['consume_time']);

426 
$‹am
 = 
Ãw
 
	`T—m
();

427 
$·¿ms
 = 
	`¬¿y
('id'=>
$coupÚRow
['team_id']);

428 
$‹amRow
 = 
$‹am
->
	`g‘_row
(
$·¿ms
);

429 ià(
$coupÚRow
 ==ğ
nuÎ
)

431 
$»¥Ú£Obj
->
‹amT™Ë
 = "æœªçŸ¥é¡¹ç›®";

433 
$»¥Ú£Obj
->
‹amT™Ë
 = 
$‹amRow
['title'];

435  
	`jsÚ_’code
(
$»¥Ú£Obj
);

436 
	}
}

	@index.php

1 ï»¿<?
php
 
»quœe_Úû
('../common/checkAuthority.php'); ?>

2 <
html
 
	gxmÊs
="http://www.w3.org/1999/xhtml">

3 <
h—d
>

4 <
t™Ë
>éªŒè¯å¹³å°</title>

5 <
m‘a
 
h‰p
-
equiv
="CÚ‹Á-Ty³" 
cÚ‹Á
="text/html; charset=utf-8">

6 <
lšk
 
h»f
="css/check_css.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

8 <
lšk
 
h»f
="../css/com_css.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

9 <
lšk
 
h»f
="../css/sim¶emod®.css" 
»l
="¡yËsh“t" 
ty³
="text/css" />

10 </
h—d
>

11 <
body
>

12 <
süt
 
¤c
="../js/jquery.min.js"></script>

13 <
süt
 
¤c
="../js/jquery.simplemodal.js"></script>

14 <
süt
 
¤c
="../js/common_funcs.js"></script>

15 <
süt
 
¤c
="js/verifyCoupon.js"></script>

17 <
div
 
şass
="maš" 
id
="main">

21 <
div
 
şass
="top_blank">

22 </
div
>

24 <
div
 
şass
="top">

25 <
img
 
¤c
="../images/logo.jpg" />

26 </
div
>

28 <
div
 
şass
="body">

30 <
div
 
şass
="body_l">

31 <
div
 
şass
="nav">

33 <?
php


34 
»quœe
 '../common/templates/left_nav_bar.php';

36 </
	gdiv
>

38 <
div
 
	gşass
="serv">

39 <
div
 
şass
="‹l" 
h»f
="#"> </div>

40 <
a
 
şass
="online_qq"></a>

41 </
div
>

43 </
div
>

45 <
div
 
şass
="body_r" > <!--è¿™é‡Œçš„
body_r
 æ˜¯åŸæ¥çš„
body
 -->

47 <
div
 
şass
="fl fl_1">

48 <
fÜm
 
aùiÚ
="" 
m‘hod
="g‘" 
acû±
-
ch¬£t
="utf-8">

50 <
div
 
şass
="platform_b">

51 <
£Ëù
 
şass
="¶©fÜm" 
Çme
="¶©fÜm" 
id
="platform">

52 <
İtiÚ
 
v®ue
="juhuasuan">èšåˆ’ç®—</option>

53 <
İtiÚ
 
v®ue
="laiqu">æ¥è¶£</option>

54 <!-- <
İtiÚ
 
v®ue
="360buy">äº¬ä¸œ</option> -->

55 </
£Ëù
>

56 </
div
>

58 <
div
 
şass
="coupÚId_b" 
Çme
="coupÚIdW¿µ”" 
id
="couponIdWrapper">

59 <
šput
 
şass
="coupÚId" 
Çme
="coupÚId" 
id
="coupÚId" 
v®ue
="åˆ¸å·"/>

60 </
div
>

62 <
div
 
şass
="coupÚPwd_b" 
Çme
="coupÚPwdW¿µ”" 
id
="couponPwdWrapper">

63 <
šput
 
şass
="coupÚPwd" 
Çme
="coupÚPwd" 
id
="coupÚPwd" 
v®ue
="å¯†ç "/>

64 </
div
>

66 <
div
 
şass
="button">

67 <
a
 
şass
="»£t" 
ty³
="»£t" 
v®ue
="" 
Çme
="»£t" 
id
="»£t" 
h»f
="javascript:void(0);"></a>

68 <
a
 
şass
="subm™" 
ty³
="subm™" 
v®ue
="" 
Çme
="subm™" 
id
="subm™" 
h»f
="javascript:void(0);"></a>

69 </
div
>

70 </
fÜm
>

71 </
div
>

73 <
div
 
şass
="mid">

74 </
div
>

77 <
div
 
şass
="fr fr_1">

79 <
p
 
şass
="‹xt_1"><
b
>éªŒè¯ç»“æœï¼š</b></p>

81 <
div
 
Çme
="imageRe¥Ú£" 
id
="imageRe¥Ú£" 
şass
="imageResponse" ></div>

82 <
div
 
şass
="line"></div>

83 <
p
 
şass
="‹xt_2_3" 
Çme
="msgRe¥Ú£" 
id
="msgResponse">è¯·åœ¨å·¦è¾¹è¾“å…¥æ¡†ä¸­è¾“å…¥ç›¸åº”çš„åˆ¸å·åŠå¯†ç ã€‚</p>

86 </
div
>

89 </
div
>

92 </
div
>

95 <
div
 
şass
="footer">

97 <
div
 
şass
="bottom_1">

98 </
div
>

100 <
div
 
şass
="bottom_line">

102 </
div
>

104 <
p
 
şass
="footer_text">æ¥ è¶£ ç½‘ ç»œ ç§‘ æŠ€ æœ‰ é™ å…¬ å¸</p>

106 </
div
>

108 </
div
>

110 </
body
>

111 </
html
>

	@v1000/Exception.php

1 <?
php


18 şas 
	cV”ifyCoupÚ_Exû±iÚ
 
ex‹nds
 
	mPEAR_Exû±iÚ


22 cÚ¡ 
	mCODE_SUCCESS_VERIFY_COUPON
 = 200;

25 cÚ¡ 
	mCODE_FAIL_VERIFY_COUPON
 = 300;

28 cÚ¡ 
	mCODE_ERROR_API_CALL
 = 400;

29 cÚ¡ 
	mCODE_ERROR_PARSE_RESPONSR
 = 401;

30 cÚ¡ 
	mCODE_ERROR_ONLY_SUPPORT_REST
 = 402;

31 cÚ¡ 
	mCODE_ERROR_UNIVERSAL_SERVER
 = 403;

32 cÚ¡ 
	mCODE_ERROR_UNKNOWN
 = 404;

33 cÚ¡ 
	mCODE_ERROR_INVALID_ARG
 = 405;

36 
´iv©e
 
	m$_codeMes§ges
 = 
¬¿y
 (

37 
£lf
::
CODE_SUCCESS_VERIFY_COUPON
 => "éªŒè¯æˆåŠŸ",

38 
£lf
::
CODE_FAIL_VERIFY_COUPON
 => "éªŒè¯å¤±è´¥",

39 
£lf
::
CODE_ERROR_API_CALL
 => "æ¥å£è°ƒç”¨å‡ºé”™",

40 
£lf
::
CODE_ERROR_PARSE_RESPONSE
 => "è§£ææ¥å£è¿”å›å‡ºé”™",

41 
£lf
::
CODE_ERROR_ONLY_SUPPORT_REST
 => "å¹³å°ç›®å‰åªæ”¯æŒRESTfulæ¥å£çš„å¹³å°",

42 
£lf
::
CODE_ERROR_UNIVERSAL_SERVER
 => "éªŒè¯å¹³å°åç«¯é€šç”¨é”™è¯¯",

43 
£lf
::
CODE_ERROR_UNKNOWN
 => "æœªçŸ¥é”™è¯¯",

44 
£lf
::
CODE_ERROR_INVALID_ARG
 => "æ— æ•ˆçš„å‚æ•°"

55 
public
 
funùiÚ
 
	$__cÚ¡ruù
(
$mes§ge
 = 
nuÎ
, 
$code
 =‚ull)

57 ià(
$mes§ge
 !ğ
nuÎ
 && 
$code
 ==‚ull)

59 
Œy
 {

60 
$mes§ge
 = 
£lf
::
	`g‘_mes§ge
(
$code
);

61 
·»Á
::
	`__cÚ¡ruù
(
$mes§ge
, 
$code
);

63 
	`ÿtch
 (
PEAR_Exû±iÚ
 
$´
)

65 
throw
 
$´
;

68 
·»Á
::
	`__cÚ¡ruù
(
$mes§ge
, 
$code
);

81 
public
 
funùiÚ
 
	$g‘_mes§ge
(
$code
 = 
nuÎ
)

83 ià(
$code
 =ğ
nuÎ
)

84  
£lf
::
$_codeMes§ges
;

86 ià(! 
	`is£t
(
£lf
::
$_codeMes§ges
[
$code
]))

87 
throw
 
Ãw
 
	`PEAR_Exû±iÚ
(
£lf
::
	`$_codeMes§ge
(£lf::
CODE_ERROR_INVALID_ARG
),

88 
£lf
::
CODE_ERROR_INVALID_ARG
);

90  
£lf
::
$_codeMes§ges
[
$code
];

91 
	}
}

	@v1000/VerifyCoupon.php

1 <?
php


10 şas 
	cV”ifyCoupÚ


14 cÚ¡ 
	mCODE_SUCCESS_VERIFY_COUPON
 = 200;

17 cÚ¡ 
	mCODE_FAIL_VERIFY_COUPON
 = 300;

20 cÚ¡ 
	mCODE_ERROR_API_CALL
 = 400;

21 cÚ¡ 
	mCODE_ERROR_PARSE_RESPONSR
 = 401;

22 cÚ¡ 
	mCODE_ERROR_ONLY_SUPPORT_REST
 = 402;

23 cÚ¡ 
	mCODE_ERROR_UNIVERSAL_SERVER
 = 403;

24 cÚ¡ 
	mCODE_ERROR_UNKNOWN
 = 404;

27 cÚ¡ 
	mTARGET_API
 = 'verifyCoupon';

30 
´iv©e
 
	m$_codeMes§ges
 = 
¬¿y
 (

31 
£lf
::
CODE_SUCCESS_VERIFY_COUPON
 => "éªŒè¯æˆåŠŸ",

32 
£lf
::
CODE_FAIL_VERIFY_COUPON
 => "éªŒè¯å¤±è´¥",

33 
£lf
::
CODE_ERROR_API_CALL
 => "æ¥å£è°ƒç”¨å‡ºé”™",

34 
£lf
::
CODE_ERROR_PARSE_RESPONSE
 => "è§£ææ¥å£è¿”å›å‡ºé”™",

35 
£lf
::
CODE_ERROR_ONLY_SUPPORT_REST
 => "å¹³å°ç›®å‰åªæ”¯æŒRESTfulæ¥å£çš„å¹³å°",

36 
£lf
::
CODE_ERROR_UNIVERSAL_SERVER
 => "éªŒè¯å¹³å°åç«¯é€šç”¨é”™è¯¯",

37 
£lf
::
CODE_ERROR_UNKNOWN
 => "æœªçŸ¥é”™è¯¯");

40 
´iv©e
 
	m$_suµÜtPÏtfÜms
 = 
¬¿y
("laiqu", "360buy");

42 
´iv©e
 
	m$_¶©fÜm
 = '';

43 
´iv©e
 
	m$_»que¡M‘hod
 = '';

44 
´iv©e
 
	m$_h‰pM‘hod
 = '';

45 
´iv©e
 
	m$_»¥Ú£Ty³
 = '';

46 
´iv©e
 
	m$_­iU¾
 = '';

47 
´iv©e
 
	m$_»que¡P¬ams
 = 
¬¿y
();

48 
´iv©e
 
	m$_»que¡P¬amsStic
 = 
¬¿y
();

49 
´iv©e
 
	m$_codeTag
 = '';

50 
´iv©e
 
	m$_codeSucûss
 = '';

63 
public
 
funùiÚ
 
	$š™
(
$¶©fÜm
)

65 iàĞ!
$this
->
	`is_suµÜ‹d
(
$¶©fÜm
) )

66  
çl£
;

67 
$this
->
_¶©fÜm
 = 
$¶©fÜm
;

69 
$cÚfigFeName
 = "¶©fÜm_­i_cÚfs/" . 
$this
->
_¶©fÜm
 . ".conf";

70 
$cÚ‹Á
 = 
	`fe_g‘_cÚ‹Ás
(
$cÚfigFeName
);

71 
$cÚfigs
 = 
	`jsÚ_decode
(
$cÚ‹Á
);

73 ià(!
	`is£t
(
$cÚfigs
))

74  
çl£
;

76 
$this
->
_»que¡M‘hod
 = 
$cÚfigs
->
»que¡M‘hod
;

77 
$this
->
_h‰pM‘hod
 = 
$cÚfigs
->
h‰pM‘hod
;

78 
$this
->
_»¥Ú£Ty³
 = 
$cÚfigs
->
»¥Ú£Ty³
;

79 
$rg‘Api
 = 
£lf
::
TARGET_API
;

80 
$rg‘ApiCÚfs
 = 
$cÚfigs
->
$rg‘Api
;

82 
$this
->
_­iU¾
 = 
$rg‘ApiCÚfs
->
­iU¾
;

83 
$this
->
_»que¡P¬ams
 = 
$rg‘ApiCÚfs
->
»que¡P¬ams
;

84 
$this
->
_»que¡P¬amsStic
 = 
$rg‘ApiCÚfs
->
»que¡P¬amsStic
;

85 
$this
->
_codeTag
 = 
$rg‘ApiCÚfs
->
»¥Ú£ResuÉ
->
codeTag
;

86 
$this
->
_codeSucûss
 = 
$rg‘ApiCÚfs
->
»¥Ú£ResuÉStic
->
codeSucûss
;

88  
Œue
;

100 
public
 
funùiÚ
 
	$is_suµÜ‹d
(
$¶©fÜm
)

102 ià(
$¶©fÜm
 == '')

103  
çl£
;

104 
	`fÜ—ch
 (
$this
->
_suµÜtPÏtfÜms
 
as
 
$suµÜt
)

106 ià(
$¶©fÜm
 =ğ
$suµÜt
)

107  
Œue
;

110  
çl£
;

111 
	}
}

123 
public
 
funùiÚ
 
	$š™_v”ifyIÅuts
(
$»que¡
)

125 ià(!
	`is£t
(
$»que¡
['couponId']) || $request['couponId'] == '')

126  
çl£
;

127 
$šputs
['coupÚId'] = 
$»que¡
['couponId'];

129 ià(
	`is£t
(
$this
->
_»que¡P¬ams
->
coupÚPwd
))

131 ià(
$»que¡
['couponPwd'] == '')

132  
çl£
;

134 
$šputs
['coupÚPwd'] = 
$»que¡
['couponPwd'];

137  
$šputs
;

138 
	}
}

149 
public
 
funùiÚ
 
	$g‘_»¥Ú£Code
(
$»¥Ú£
)

151 
$»¥Ú£Code
 = "";

152 ià(
$»¥Ú£
 =ğ"" || 
$this
->
_»¥Ú£Ty³
 == "" ||

153 
$this
->
_codeTag
 =ğ"" || $this->
_codeSucûss
 == "")

154  
£lf
::
CODE_ERROR_PARSE_RESPONSE
;

156 ià(
$this
->
_»¥Ú£Ty³
 == "LAIQU")

158 
	`´eg_m©ch_®l
("/(<([\w]+)[^>]*>)(.*?)(<\/\\2>)/", 
$»¥Ú£
, 
$m©ches
, 
PREG_SET_ORDER
);

159 
	`fÜ—ch
 (
$m©ches
 
as
 
$v®
) {

160 ià(
$v®
[2] =ğ
$this
->
_codeTag
)

162 
$»¥Ú£Code
 = 
$v®
[3];

165 } ià(
$this
->
_»¥Ú£Ty³
 == "XML")

167 
$xmlRe¥Ú£
 = 
	`sim¶exml_lßd_¡ršg
(
$»¥Ú£
);

168 
$»¥Ú£Code
 = 
$xmlRe¥Ú£
->
$code
;

171 ià(
$»¥Ú£Code
 == '')

172  
£lf
::
CODE_ERROR_PARSE_RESPONSE
;

174  
$»¥Ú£Code
 =ğ
$this
->
_codeSucûss
 ? 
£lf
::
CODE_SUCCESS_VERIFY_COUPON
 : s–f::
CODE_FAIL_VERIFY_COUPON
;

175 
	}
}

186 
public
 
funùiÚ
 
	$g‘_»que¡P¬ams
(
$šputs
)

188 
$·¿ms
 = 
	`¬¿y
();

189 
	`fÜ—ch
 (
$this
->
_»que¡P¬ams
 
as
 
$key
 => 
$v®ue
)

192 
$·¿ms
[
$v®ue
] = 
$šputs
[
$key
];

194 ià(
$this
->
_»que¡P¬amsStic
 !ğ
nuÎ
)

197 
	`fÜ—ch
 (
$this
->
_»que¡P¬amsStic
 
as
 
$key
 => 
$v®ue
)

199 
$·¿ms
[
$key
] = 
$v®ue
;

202  
$·¿ms
;

203 
	}
}

214 
public
 
funùiÚ
 
	$g’_»¥Ú£_jsÚ
(
$»suÉ
)

216 ià(!
$»suÉ
 || 
£lf
::
$_codeMes§ges
[$result] == '')

217  
çl£
;

219 
$»¥Ú£
['code'] = 
$»suÉ
;

220 
$»¥Ú£
['msg'] = 
£lf
::
$_codeMes§ges
[
$»suÉ
];

221 
$»¥Ú£
['d©eTime'] = 
	`d©e
("Y-m-d, h:i:s");

223  
	`jsÚ_’code
(
$»¥Ú£
);

224 
	}
}

234 
public
 
funùiÚ
 
	$g‘_mes§ge
(
$code
 = 
nuÎ
)

236 ià(
$code
 =ğ
nuÎ
)

237  
£lf
::
$_codeMes§ges
;

239  
	`is£t
(
£lf
::
$_codeMes§ges
[
$code
]è? s–f::$_codeMes§ges[$code] : 
nuÎ
;

240 
	}
}

244 
public
 
funùiÚ
 
	$g‘_¶©fÜm
()

246  
$this
->
_¶©fÜm
;

247 
	}
}

251 
public
 
funùiÚ
 
	$g‘_»que¡M‘hod
()

253  
$this
->
_»que¡M‘hod
;

254 
	}
}

258 
public
 
funùiÚ
 
	$g‘_h‰pM‘hod
()

260  
$this
->
_h‰pM‘hod
;

261 
	}
}

265 
public
 
funùiÚ
 
	$g‘_»¥Ú£Ty³
()

267  
$this
->
_»¥Ú£Ty³
;

268 
	}
}

272 
public
 
funùiÚ
 
	$g‘_­iU¾
()

274  
$this
->
_­iU¾
;

275 
	}
}

279 
public
 
funùiÚ
 
	$g‘_codeTag
()

281  
$this
->
_codeTag
;

282 
	}
}

286 
public
 
funùiÚ
 
	$g‘_codeSucûss
()

288  
$this
->
_codeSucûss
;

289 
	}
}

	@v1000/doVerifyCoupon.php

1 <?
php


2 
	g»quœe_Úû
 'RESTclient.php';

3 
	g»quœe_Úû
 'VerifyCoupon.php';

5 
	g$¶©fÜm
 = 
$_REQUEST
['platform'];

6 
	g$v”ifyCoupÚ
 = 
Ãw
 
V”ifyCoupÚ
();

8 if(!
	g$v”ifyCoupÚ
->
	$š™
(
$¶©fÜm
))

10 
	`d›
(
V”ifyCoupÚ
::
	`g’_»¥Ú£_jsÚ
(V”ifyCoupÚ::
CODE_ERROR_UNIVERSAL_SERVER
));

11 
	}
}

13 
	g$šputs
 = 
$v”ifyCoupÚ
->
š™_v”ifyIÅuts
(
$_REQUEST
);

15 
	g$»¡
 = 
Ãw
 
RESTş›Á
();

17 
	g$·¿ms
 = 
$v”ifyCoupÚ
->
g‘_»que¡P¬ams
(
$šputs
);

19 ià(
	g$v”ifyCoupÚ
->
g‘_h‰pM‘hod
() == 'POST') {

20 
$»¡
->
ü—‹Reque¡
(
$v”ifyCoupÚ
->
g‘_­iU¾
(), 'POST', 
$·¿ms
);

22 
	g$»¡
->
ü—‹Reque¡
(
$v”ifyCoupÚ
->
g‘_­iU¾
());

23 
	g$u¾
 = 
$»¡
->
g‘U¾
();

24 
	g$u¾
->
£tQu”yV¬ŸbËs
(
$·¿ms
);

26 
	g$»¡
->
£ndReque¡
();

27 
	g$»¥Ú£
 = 
$»¡
->
g‘Re¥Ú£
();

28 
	g$»suÉ
 = 
$v”ifyCoupÚ
->
g‘_»¥Ú£Code
(
$»¥Ú£
);

30 
echo
 
	gV”ifyCoupÚ
::
g’_»¥Ú£_jsÚ
(
$»suÉ
);

	@
1
.
0
8
151
VerifyCoupon.php
VerifyCoupon_funcs.php
doVerifyCoupon.php
functions.php
index.php
v1000/Exception.php
v1000/VerifyCoupon.php
v1000/doVerifyCoupon.php
